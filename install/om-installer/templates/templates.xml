<configuration>
  <property>
    <name>ldap_changes_template</name>
    <value>dn: {{ldap_dn}}
changetype: modify
replace: olcSuffix
olcSuffix: dc=esgyn,dc=local

dn: {{ldap_dn}}
changetype: modify
replace: olcRootDN
olcRootDN: cn=Manager,dc=esgyn,dc=local

dn: {{ldap_dn}}
changetype: modify
{{rootpw_mode}}: olcRootPW
olcRootPW: {{ldap_rootpw}}

dn: {{ldap_dn}}
changetype: modify
{{access_mode}}: olcAccess
olcAccess: {0}to attrs=userPassword by self write by dn.base="cn=Manager,dc=esgyn,dc=local" write by anonymous auth by * none
olcAccess: {1}to * by dn.base="cn=Manager,dc=esgyn,dc=local" write by self write by * read</value>
  </property>
  <property>
    <name>ldap_ou_template</name>
    <value>dn: dc=esgyn,dc=local
objectClass: dcObject
objectClass: organization
dc: esgyn
o : esgyn

dn: ou=Users,dc=esgyn,dc=local
objectClass: organizationalUnit
ou: Users</value>
  </property>
  <property>
    <name>ldap_users_template</name>
    <value># db_root
dn: uid=trafodion,ou=Users,dc=esgyn,dc=local
uid: trafodion
ou: Users
sn: db_root
cn: DB_ROOT
objectClass: person
objectClass: organizationalPerson
objectClass: inetOrgPerson
userpassword: {{db_root_pwd}}

# db_admin
dn: uid=admin,ou=Users,dc=esgyn,dc=local
ou: Users
uid: admin
sn: db_admin
cn: DB_ADMIN
objectClass: person
objectClass: organizationalPerson
objectClass: inetOrgPerson
userpassword: {{db_admin_pwd}}</value>
  </property>
  <property>
    <name>ldap_mod_syncprov</name>
    <value>dn: cn=module,cn=config
objectClass: olcModuleList
cn: module
olcModulePath: /usr/lib64/openldap
olcModuleLoad: syncprov.la</value>
  </property>
  <property>
    <name>ldap_syncprov</name>
    <value>dn: olcOverlay=syncprov,{{ldap_dn}}
objectClass: olcOverlayConfig
objectClass: olcSyncProvConfig
olcOverlay: syncprov
olcSpCheckpoint: 100 10
olcSpSessionLog: 100</value>
  </property>
  <property>
    <name>ldap_ha</name>
    <value>dn: cn=config
changetype: modify
replace: olcServerID
olcServerID: {{server_id}}

dn: {{ldap_dn}}
changetype: modify
replace: olcSyncRepl
olcSyncRepl: rid=001
             provider=ldap://{{ldap_provider}}:389
             bindmethod=simple
             binddn="cn=Manager,dc=esgyn,dc=local"
             credentials={{ldap_rootpw}}
             searchbase="dc=esgyn,dc=local"
             filter="(objectClass=*)"
             scope=sub
             schemachecking=off
             attrs="*,+"
             type=refreshAndPersist
             retry="5 5 300 +"
             interval=00:00:01:00
-
{{mirror_mode}}: olcMirrorMode
olcMirrorMode: TRUE
-
{{uuid_mode}}: olcDbIndex
olcDbIndex: entryUUID eq
-
{{csn_mode}}: olcDbIndex
olcDbIndex: entryCSN eq</value>
  </property>
  <property>
    <name>logstash_config</name>
    <value>input {
    beats {
        port => "5044"
    }
}
# The filter part of this file is commented out to indicate that it is
# optional.
filter {
    grok {
        match => {"message" => "%{TIMESTAMP_ISO8601:access_time}"}
    }
    date {
        match => [ "access_time", "yyyy-MM-dd HH:mm:ss.SSS", "ISO8601" ]
        # move this to a per-host statement
        timezone => "Asia/Shanghai"
        remove_field => ["access_time", "agent"]
    }
}
output {
    stdout{}
    elasticsearch {
        hosts => [ "{{management_node}}:9200" ]
	index => "trafodion_logs-{{traf_cluster_id}}-%{+YYYY.MM.dd}"
    }
}</value>
  </property>
  <property>
    <name>ldap_config_template</name>
    <value>
SECTION: Defaults
  DefaultSectionName: {{ldap_domain}}
  RefreshTime: 1800
  TLS_CACERTFilename: {{ldap_certpath}}

SECTION: {{ldap_domain}}
  # one name: value pair for each host.
  # LdapHostname:
{{ldap_hosts}}

  # Default is port 389, change if using 636 or any other port
  LdapPort: {{ldap_port}}

  # Must specify one or more unique identifiers, one name: value pair for each
  # UniqueIdentifier:
{{ldap_identifiers}}

  # If the configured LDAP server requires a username and password to
  # to perform name lookup, provide those here.
  LDAPSearchDN: {{ldap_user}}
  LDAPSearchPwd: {{ldap_pwd}}

  # If configured LDAP server requires TLS(2) or SSL (1), update this value
  LDAPSSL: {{ldap_encrypt}}

  # Default timeout values in seconds
  #LDAPNetworkTimeout: 30
  #LDAPTimeout: 30
  #LDAPTimeLimit: 30
  #RetryCount: 5
  #RetryDelay: 2
  #PreserveConnection: No
  #ExcludeBadHosts: Yes
  #MaxExcludeListSize: 3

  LDAPSearchGroupBase: {{ldap_srch_grp_base}}
  LDAPSearchGroupObjectClass: {{ldap_srch_grp_obj_class}}
  LDAPSearchGroupMemberAttr: {{ldap_srch_grp_mem_attr}}
  LDAPSearchGroupNameAttr: {{ldap_srch_grp_name_attr}}

#SECTION: (name)
#  LdapHostname: (host)
#  UniqueIdentifier: (cn=...)
#  ...
    </value>
  </property>
</configuration>
