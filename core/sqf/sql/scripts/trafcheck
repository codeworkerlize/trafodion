#!/bin/bash
#
# @@@ START COPYRIGHT @@@
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
# @@@ END COPYRIGHT @@@
#

if [[ -z $TRAF_HOME ]]; then
    echo "The environment variable TRAF_HOME is not present."
    echo "Looks like the Trafodion environment has not been configured. Exitting..."
    exit 5;
fi

if [[ -z $SQSCRIPTS_DIR ]]; then
    SQSCRIPTS_DIR=$TRAF_HOME/sql/scripts
fi
SQCONFIGDB_FILE="$TRAF_VAR/sqconfig.db"
if [[ ! -e ${SQCONFIGDB_FILE} ]]; then
    echo "Cannot find the Trafodion configuration DB file ${SQCONFIGDB_FILE}"
    echo "Please execute sqgen to generate this file."
    exit 5;
fi

grep_out=`pstat | grep "monitor COLD" | grep -v mpirun`
if [[ $? == '0' ]]; then
   echo "The Trafodion monitor seems to be running on this node - let's check the status..."
   sqcheck
   exit $?
else
   echo "Trafodion is not running on the current node: `hostname`"
   lv_monitor_not_running_on_curr_node=1
fi

if [[ ! -z ${TRAF_AGENT} ]]; then
    # Currently assuming that other nodes are not reachable in agent mode when the
    # local monitor is down.
    #
    # Remove this check when we have some methodology to reach other nodes.
    echo
    echo "Status of other nodes in the Trafodion cluster is unknown (cannot communicate with remote monitors when the local monitor is down). Exitting..."
    exit 1;
fi

echo
echo "Trafodion has been configured to run on these nodes:"
trafconf -short
echo

echo 
echo "Let's check if a Trafodion monitor is running on other nodes..."

grep_out_mon=`$TRAF_HOME/sql/scripts/cstat | grep "monitor COLD" `
lv_ret=$?
if [[ $lv_ret == 0 ]]; then
    grep_out=`cstat | grep "monitor COLD" | grep -v mpirun | sort | cut -d: -f1`
    echo
    echo "Trafodion seems to be running on these nodes:"
    echo "$grep_out"
    for lv_node in $grep_out; do
	echo
        echo "Executing sqcheck on node (via ssh): $lv_node"
        echo "ssh $lv_node sqcheck"
        ssh $lv_node sqcheck
        lv_sqcheck_retcode=$?
        if [[ ${lv_monitor_not_running_on_curr_node} == "1" ]]; then
            let lv_exit_code=(${lv_sqcheck_retcode}+100)
        else
            let lv_exit_code=(${lv_sqcheck_retcode})
	fi
        exit ${lv_exit_code}
    done
else
    echo "None of the Trafodion nodes have a Trafodion monitor running on them."
    echo "Trafodion is currently down."
    exit 255;
fi
