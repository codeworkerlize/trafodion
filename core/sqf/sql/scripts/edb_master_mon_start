#!/bin/bash

export SLEEP_TIME=30

function do_sqcheckmon {
    sleep ${SLEEP_TIME}
    echo "`date`: waiting for the monitor to come up" >> ${LOG_FILE}
    sqcheckmon >> ${LOG_FILE} 2>&1
    echo "`date`: sleeping ${SLEEP_TIME} seconds" >> ${LOG_FILE}
    sleep ${SLEEP_TIME} 
    echo "`date`: going to execute gomon.cold" >> ${LOG_FILE}
    gomon.cold >> ${LOG_FILE} 2>&1
}

if [[ -z $TRAF_HOME ]]; then
    echo
    echo "The TRAF_HOME environment variable does not exist."
    echo "Please ensure sqenv.sh has been sourced."
    echo
    exit 1;
fi

if [[ -z ${MONITOR_COMM_PORT} ]]; then
    echo "Please set the variable MONITOR_COMM_PORT"
    exit 1;
fi

cd $TRAF_HOME/sql/scripts

LOG_FILE="master_monitor_startup.log"

edb_startup_cleanup >> ${LOG_FILE} 2>&1
lv_ret=$?
echo "`date`:edb_startup_cleanup done, return code= ${lv_ret}" >> ${LOG_FILE}
if [[ ${lv_ret} != 0 ]]; then
    echo "`date`: Exitting..." >> ${LOG_FILE}
    exit $lv_ret
fi

if [[ $1 != "-n" ]]; then
    do_sqcheckmon &
    lv_ret=$?
    echo "`date`: Started do_sqcheckmon in the background, return code= ${lv_ret}, jobs: " >> ${LOG_FILE}
    jobs >> ${LOG_FILE}
    disown %1
fi

echo "`date`: starting monitor" >> ${LOG_FILE}
monitor COLD_AGENT & >> ${LOG_FILE}
lv_ret=$?
echo "`date`: monitor startup done, return code= ${lv_ret}, jobs:" >> ${LOG_FILE}
jobs | tee -a ${LOG_FILE}

disown %1
