
# ------------------------------------------------------------------------------
# Upgrade should succeed without errors.  If some unexpected problems occur
# during upgrade, then the system backup should be restored.
# If there is no system backup available then a set of scripts can be run to 
# recover the system.
#
# *** important ***
# In order for this to work, the "createUpgradeSnapshots" must be run before
# the initial upgrade is attempted.  To do this:
#    hbase shell createUpgradeSnapshots > createSnapshots.log
#
# If error occur during upgrade:
#   Determine where upgrade fails and adjust the following scripts accordingly.
#     (see comments in each script that describes what should be done)
#
# restoreUpgradeStep1 - restores backup snapshots
#   hbase shell restoreUpgradeStep1 > restoreSnapshots.log
#
# restoreUpgradeStep2 - verifies that the restored tables are good 
#   hbase shell restoreUpgradeStep2 > verifyRestore.log
#
# restoreUpgradeStep3 - removes temporary files created during upgrade
#   hbase shell restoreUpgradeStep3 > removeTempTablesFromHbase.log
#
# restoreUpgradeStep4 - removes temporary tables from EsgynDB
#   sqlci < restoreUpgradeStep4 > removeTempTablesFromSQL.log
#
# Once a successful upgrade occurs, you can remove the snapshots
#   hbase shell deleteUpgradeSnapshots > deleteSnapshots.log
# ------------------------------------------------------------------------------

# first get and store rowcounts of each table
count 'TRAF_RSRVD_1:TRAFODION._MD_.AUTHS'
count 'TRAF_RSRVD_1:TRAFODION._MD_.COLUMNS'
count 'TRAF_RSRVD_1:TRAFODION._MD_.DEFAULTS'
count 'TRAF_RSRVD_1:TRAFODION._MD_.INDEXES'
count 'TRAF_RSRVD_1:TRAFODION._MD_.KEYS'
count 'TRAF_RSRVD_1:TRAFODION._MD_.LIBRARIES'
count 'TRAF_RSRVD_1:TRAFODION._MD_.LIBRARIES_USAGE'
count 'TRAF_RSRVD_1:TRAFODION._MD_.OBJECTS'
count 'TRAF_RSRVD_1:TRAFODION._MD_.OBJECTS_UNIQ_IDX'
count 'TRAF_RSRVD_1:TRAFODION._MD_.REF_CONSTRAINTS'
count 'TRAF_RSRVD_1:TRAFODION._MD_.ROUTINES'
count 'TRAF_RSRVD_1:TRAFODION._MD_.SEQ_GEN'
count 'TRAF_RSRVD_1:TRAFODION._MD_.TABLES'
count 'TRAF_RSRVD_1:TRAFODION._MD_.TABLE_CONSTRAINTS'
count 'TRAF_RSRVD_1:TRAFODION._MD_.TABLE_CONSTRAINTS_IDX'
count 'TRAF_RSRVD_1:TRAFODION._MD_.TEXT'
count 'TRAF_RSRVD_1:TRAFODION._MD_.UNIQUE_REF_CONSTR_USAGE'
count 'TRAF_RSRVD_1:TRAFODION._MD_.VERSIONS'
count 'TRAF_RSRVD_1:TRAFODION._MD_.VIEWS'
count 'TRAF_RSRVD_1:TRAFODION._MD_.VIEWS_USAGE'

count 'TRAF_RSRVD_1:TRAFODION._PRIVMGR_MD_.COLUMN_PRIVILEGES'
count 'TRAF_RSRVD_1:TRAFODION._PRIVMGR_MD_.COMPONENTS'
count 'TRAF_RSRVD_1:TRAFODION._PRIVMGR_MD_.COMPONENT_OPERATIONS'
count 'TRAF_RSRVD_1:TRAFODION._PRIVMGR_MD_.COMPONENT_PRIVILEGES'
count 'TRAF_RSRVD_1:TRAFODION._PRIVMGR_MD_.OBJECT_PRIVILEGES'
count 'TRAF_RSRVD_1:TRAFODION._PRIVMGR_MD_.ROLE_USAGE'
count 'TRAF_RSRVD_1:TRAFODION._PRIVMGR_MD_.SCHEMA_PRIVILEGES'

# Now take snapshots of each table
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.AUTHS', 'SNAPSHOT_TRAFODION._MD_.AUTHS'                                           
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.COLUMNS', 'SNAPSHOT_TRAFODION._MD_.COLUMNS'                                       
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.DEFAULTS', 'SNAPSHOT_TRAFODION._MD_.DEFAULTS'                                     
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.INDEXES', 'SNAPSHOT_TRAFODION._MD_.INDEXES'                                       
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.KEYS', 'SNAPSHOT_TRAFODION._MD_.KEYS'                                             
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.LIBRARIES', 'SNAPSHOT_TRAFODION._MD_.LIBRARIES'                                   
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.LIBRARIES_USAGE', 'SNAPSHOT_TRAFODION._MD_.LIBRARIES_USAGE'                       
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.OBJECTS', 'SNAPSHOT_TRAFODION._MD_.OBJECTS'                                       
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.OBJECTS_UNIQ_IDX', 'SNAPSHOT_TRAFODION._MD_.OBJECTS_UNIQ_IDX'                                       
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.REF_CONSTRAINTS', 'SNAPSHOT_TRAFODION._MD_.REF_CONSTRAINTS'                       
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.ROUTINES', 'SNAPSHOT_TRAFODION._MD_.ROUTINES'                                     
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.SEQ_GEN', 'SNAPSHOT_TRAFODION._MD_.SEQ_GEN'                                       
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.TABLES', 'SNAPSHOT_TRAFODION._MD_.TABLES'                                         
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.TABLE_CONSTRAINTS', 'SNAPSHOT_TRAFODION._MD_.TABLE_CONSTRAINTS'                   
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.TABLE_CONSTRAINTS_IDX', 'SNAPSHOT_TRAFODION._MD_.TABLE_CONSTRAINTS_IDX'                   
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.TEXT', 'SNAPSHOT_TRAFODION._MD_.TEXT'                                             
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.UNIQUE_REF_CONSTR_USAGE', 'SNAPSHOT_TRAFODION._MD_.UNIQUE_REF_CONSTR_USAGE'       
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.VERSIONS', 'SNAPSHOT_TRAFODION._MD_.VERSIONS'                                     
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.VIEWS', 'SNAPSHOT_TRAFODION._MD_.VIEWS'                                           
snapshot 'TRAF_RSRVD_1:TRAFODION._MD_.VIEWS_USAGE', 'SNAPSHOT_TRAFODION._MD_.VIEWS_USAGE'           

snapshot 'TRAF_RSRVD_1:TRAFODION._PRIVMGR_MD_.COLUMN_PRIVILEGES', 'SNAPSHOT_TRAFODION._PRIVMGR_MD_.COLUMN_PRIVILEGES'
snapshot 'TRAF_RSRVD_1:TRAFODION._PRIVMGR_MD_.COMPONENTS', 'SNAPSHOT_TRAFODION._PRIVMGR_MD_.COMPONENTS'
snapshot 'TRAF_RSRVD_1:TRAFODION._PRIVMGR_MD_.COMPONENT_OPERATIONS', 'SNAPSHOT_TRAFODION._PRIVMGR_MD_.COMPONENT_OPERATIONS'
snapshot 'TRAF_RSRVD_1:TRAFODION._PRIVMGR_MD_.COMPONENT_PRIVILEGES',  'SNAPSHOT_TRAFODION._PRIVMGR_MD_.COMPONENT_PRIVILEGES'
snapshot 'TRAF_RSRVD_1:TRAFODION._PRIVMGR_MD_.OBJECT_PRIVILEGES', 'SNAPSHOT_TRAFODION._PRIVMGR_MD_.OBJECT_PRIVILEGES'
snapshot 'TRAF_RSRVD_1:TRAFODION._PRIVMGR_MD_.ROLE_USAGE', 'SNAPSHOT_TRAFODION._PRIVMGR_MD_.ROLE_USAGE'
snapshot 'TRAF_RSRVD_1:TRAFODION._PRIVMGR_MD_.SCHEMA_PRIVILEGES', 'SNAPSHOT_TRAFODION._PRIVMGR_MD_.SCHEMA_PRIVILEGES'

# Return list of snapshots that exist
list_snapshots
exit
# ------------------------------------------------------------------------------

