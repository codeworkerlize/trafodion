>>
>>obey TEST311(test);
>>
>>set schema t311sch;

--- SQL operation complete.
>>
>>create table t1 (a int);

--- SQL operation complete.
>>select * from t1;

--- 0 row(s) selected.
>>create table t8(c1 int unique);

--- SQL operation complete.
>>
>>obey TEST311(test_trans_t2);
>>
>>cqd sp_default_no_transaction_required 'on';

--- SQL operation complete.
>>
>>EXECUTE //
SET "hplsql.transaction.compatible" = true;
SET "hplsql.use.only.one.connection" = true;
//;

--- SQL operation complete.
>>
>>obey TEST311(trans_create);
>>
>>create or replace procedure p1() as //
begin
  insert into t1 values (1);
  commit;
  insert into t1 values (2);
  rollback;
  begin work;
  insert into t1 values (3);
  commit;
end//;

--- SQL operation complete.
>>
>>create or replace procedure p2(out r int, out errcode varchar(10), out errmsg varchar(200)) as //
declare
  i int;
begin
  insert into t1 values (21);
  declare cursor c1 for select a from t1;
  open c1;
  fetch c1 into i;
  set r := 0;
  while (sqlcode = 0)
  do
    set r := r + i;
    fetch c1 into i;
  end while;
  commit;
  insert into t1 values (22);
  select * from not_exist_table;
exception when others then
  begin
    get diagnostics exception 1 text = MESSAGE_TEXT;
    set errcode := substr(text, instr(text, 'ERROR[') + 6, 4);
    set errmsg := substr(text, instr(text, 'ERROR[') + 12, 200);
    rollback;
    insert into t1 values (23);
  end;
end//;

--- SQL operation complete.
>>
>>create or replace procedure p3() transaction required as //
begin
  insert into t1 values (31);
end//;

--- SQL operation complete.
>>
>>create or replace procedure p4(out r int) transaction required as //
begin
  select count(*) into r from t1;
end//;

--- SQL operation complete.
>>
>>create or replace procedure p5(out r int) as //
begin
  select count(*) into r from t1;
end//;

--- SQL operation complete.
>>
>>create or replace procedure p6() as//
begin
  prepare x from 'insert into t1 values(61)';
  exec x;
end//;

--- SQL operation complete.
>>
>>create or replace procedure p7() as//
begin
  prepare x from 'insert into t1 values(70)';
  exec x;
  close prepare x;
end//;

--- SQL operation complete.
>>
>>create or replace procedure p8() as//
begin
  insert into t8 values(1);
  insert into t8 values(1); /* error */
exception
  when others then
    rollback;
    insert into t8 values(2);
end//;

--- SQL operation complete.
>>
>>create or replace package body pkg as //
  procedure p9 is
  begin
    insert into t1 values (101);
    commit;
    insert into t1 values (102);
    rollback;
    insert into t1 values (103);
  end;
end//;

--- SQL operation complete.
>>
>>obey TEST311(trans_call);
>>
>>call p1();

--- SQL operation complete.
>>select * from t1;

A          
-----------

          1
          3

--- 2 row(s) selected.
>>
>>call p2(?, ?, ?);

R            ERRCODE     ERRMSG
-----------  ----------  --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

         25  4082        Object TRAFODION.T311SCH.NOT_EXIST_TABLE does not exist or is inaccessible.                                                                                                                             

--- SQL operation complete.
>>select * from t1;

A          
-----------

          1
          3
         21
         23

--- 4 row(s) selected.
>>
>>call p3();

--- SQL operation complete.
>>select * from t1;

A          
-----------

          1
          3
         21
         23
         31

--- 5 row(s) selected.
>>
>>call p4(?);

R          
-----------

          5

--- SQL operation complete.
>>
>>call p5(?);

R          
-----------

          5

--- SQL operation complete.
>>
>>call p6();

--- SQL operation complete.
>>select * from t1;

A          
-----------

          1
          3
         21
         23
         31
         61

--- 6 row(s) selected.
>>
>>call p7();

--- SQL operation complete.
>>select * from t1;

A          
-----------

          1
          3
         21
         23
         31
         61
         70

--- 7 row(s) selected.
>>
>>call p8();

--- SQL operation complete.
>>select * from t8;

C1         
-----------

          2

--- 1 row(s) selected.
>>
>>call pkg.p9();

--- SQL operation complete.
>>select * from t1;

A          
-----------

          1
          3
         21
         23
         31
         61
         70
        101
        103

--- 9 row(s) selected.
>>
>>
>>
>>delete from t1;

--- 9 row(s) deleted.
>>delete from t8;

--- 1 row(s) deleted.
>>obey TEST311(test_trans_t4);
>>
>>cqd sp_default_no_transaction_required 'off';

--- SQL operation complete.
>>
>>EXECUTE //
SET "hplsql.conn.trafodion" = 'org.trafodion.jdbc.t4.T4Driver;jdbc:t4jdbc:/' || '/127.0.0.1:23400/;trafodion;traf123';
SET "hplsql.conn.default" = 'trafodion';
SET "hplsql.transaction.compatible" = true;
SET "hplsql.use.only.one.connection" = true;
//;

--- SQL operation complete.
>>
>>obey TEST311(trans_create);
>>
>>create or replace procedure p1() as //
begin
  insert into t1 values (1);
  commit;
  insert into t1 values (2);
  rollback;
  begin work;
  insert into t1 values (3);
  commit;
end//;

--- SQL operation complete.
>>
>>create or replace procedure p2(out r int, out errcode varchar(10), out errmsg varchar(200)) as //
declare
  i int;
begin
  insert into t1 values (21);
  declare cursor c1 for select a from t1;
  open c1;
  fetch c1 into i;
  set r := 0;
  while (sqlcode = 0)
  do
    set r := r + i;
    fetch c1 into i;
  end while;
  commit;
  insert into t1 values (22);
  select * from not_exist_table;
exception when others then
  begin
    get diagnostics exception 1 text = MESSAGE_TEXT;
    set errcode := substr(text, instr(text, 'ERROR[') + 6, 4);
    set errmsg := substr(text, instr(text, 'ERROR[') + 12, 200);
    rollback;
    insert into t1 values (23);
  end;
end//;

--- SQL operation complete.
>>
>>create or replace procedure p3() transaction required as //
begin
  insert into t1 values (31);
end//;

--- SQL operation complete.
>>
>>create or replace procedure p4(out r int) transaction required as //
begin
  select count(*) into r from t1;
end//;

--- SQL operation complete.
>>
>>create or replace procedure p5(out r int) as //
begin
  select count(*) into r from t1;
end//;

--- SQL operation complete.
>>
>>create or replace procedure p6() as//
begin
  prepare x from 'insert into t1 values(61)';
  exec x;
end//;

--- SQL operation complete.
>>
>>create or replace procedure p7() as//
begin
  prepare x from 'insert into t1 values(70)';
  exec x;
  close prepare x;
end//;

--- SQL operation complete.
>>
>>create or replace procedure p8() as//
begin
  insert into t8 values(1);
  insert into t8 values(1); /* error */
exception
  when others then
    rollback;
    insert into t8 values(2);
end//;

--- SQL operation complete.
>>
>>create or replace package body pkg as //
  procedure p9 is
  begin
    insert into t1 values (101);
    commit;
    insert into t1 values (102);
    rollback;
    insert into t1 values (103);
  end;
end//;

--- SQL operation complete.
>>
>>obey TEST311(trans_call);
>>
>>call p1();

--- SQL operation complete.
>>select * from t1;

A          
-----------

          1
          3

--- 2 row(s) selected.
>>
>>call p2(?, ?, ?);

R            ERRCODE     ERRMSG
-----------  ----------  --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

         25  4082        Object TRAFODION.T311SCH.NOT_EXIST_TABLE does not exist or is inaccessible. [2019-06-26 02:31:03]                                                                                                       

--- SQL operation complete.
>>select * from t1;

A          
-----------

          1
          3
         21
         23

--- 4 row(s) selected.
>>
>>call p3();

--- SQL operation complete.
>>select * from t1;

A          
-----------

          1
          3
         21
         23
         31

--- 5 row(s) selected.
>>
>>call p4(?);

R          
-----------

          5

--- SQL operation complete.
>>
>>call p5(?);

R          
-----------

          5

--- SQL operation complete.
>>
>>call p6();

--- SQL operation complete.
>>select * from t1;

A          
-----------

          1
          3
         21
         23
         31
         61

--- 6 row(s) selected.
>>
>>call p7();

--- SQL operation complete.
>>select * from t1;

A          
-----------

          1
          3
         21
         23
         31
         61
         70

--- 7 row(s) selected.
>>
>>call p8();

--- SQL operation complete.
>>select * from t8;

C1         
-----------

          2

--- 1 row(s) selected.
>>
>>call pkg.p9();

--- SQL operation complete.
>>select * from t1;

A          
-----------

          1
          3
         21
         23
         31
         61
         70
        101
        103

--- 9 row(s) selected.
>>
>>
>>
>>set parserflags 131072;

--- SQL operation complete.
>>update "_MD_".routines set transaction_attributes='NO'
+>      where udr_type='P'
+>      and udr_uid in (select object_uid from "_MD_".objects where schema_name='T311SCH'
+>      and object_name in ('P1', 'P2', 'P5', 'P6', 'P7', 'P8'));

--- 6 row(s) updated.
>>reset parserflags 131072;

--- SQL operation complete.
>>EXECUTE //
SET "hplsql.conn.default" = 'default';
//;

--- SQL operation complete.
>>delete from t1;

--- 9 row(s) deleted.
>>delete from t8;

--- 1 row(s) deleted.
>>obey TEST311(trans_call);
>>
>>call p1();

--- SQL operation complete.
>>select * from t1;

A          
-----------

          1
          3

--- 2 row(s) selected.
>>
>>call p2(?, ?, ?);

R            ERRCODE     ERRMSG
-----------  ----------  --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

         25  4082        Object TRAFODION.T311SCH.NOT_EXIST_TABLE does not exist or is inaccessible.                                                                                                                             

--- SQL operation complete.
>>select * from t1;

A          
-----------

          1
          3
         21
         23

--- 4 row(s) selected.
>>
>>call p3();

--- SQL operation complete.
>>select * from t1;

A          
-----------

          1
          3
         21
         23
         31

--- 5 row(s) selected.
>>
>>call p4(?);

R          
-----------

          5

--- SQL operation complete.
>>
>>call p5(?);

R          
-----------

          5

--- SQL operation complete.
>>
>>call p6();

--- SQL operation complete.
>>select * from t1;

A          
-----------

          1
          3
         21
         23
         31
         61

--- 6 row(s) selected.
>>
>>call p7();

--- SQL operation complete.
>>select * from t1;

A          
-----------

          1
          3
         21
         23
         31
         61
         70

--- 7 row(s) selected.
>>
>>call p8();

--- SQL operation complete.
>>select * from t8;

C1         
-----------

          2

--- 1 row(s) selected.
>>
>>call pkg.p9();

--- SQL operation complete.
>>select * from t1;

A          
-----------

          1
          3
         21
         23
         31
         61
         70
        101
        103

--- 9 row(s) selected.
>>
>>
>>
>>log;
