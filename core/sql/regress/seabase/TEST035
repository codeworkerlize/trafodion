-- @@@ START COPYRIGHT @@@
--
-- Licensed to the Apache Software Foundation (ASF) under one
-- or more contributor license agreements.  See the NOTICE file
-- distributed with this work for additional information
-- regarding copyright ownership.  The ASF licenses this file
-- to you under the Apache License, Version 2.0 (the
-- "License"); you may not use this file except in compliance
-- with the License.  You may obtain a copy of the License at
--
--   http://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing,
-- software distributed under the License is distributed on an
-- "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
-- KIND, either express or implied.  See the License for the
-- specific language governing permissions and limitations
-- under the License.
--
-- @@@ END COPYRIGHT @@@
--

-- test shared cache and integrated preloading feature.

log LOG035 clear;

create schema t035sch;
set schema t035sch;

create table t035_cube1
(a int not null not droppable, 
b int not null not droppable,
c int not null not droppable,
d int not null, 
e int not null, 
f int not null, txt char(100),
primary key (a,b,c))
salt using 8 partitions
attribute aligned format
;
create table t035_fact3
(a int not null not droppable, 
b int not null not droppable,
c int not null not droppable,
d int not null not droppable,
e int, f int, txt char(1300),
primary key (a,b,c,d))
attribute aligned format
;


alter table t035_cube1 generate stored desc;
alter table t035_fact3 generate stored desc;

-- test shard cache.
prepare s1 from
select cast (catalog_name as char(30) character set iso88591),
       cast (schema_name as char(30) character set iso88591),
       cast (object_name as char(30) character set iso88591)
from table(natablecacheentries('all','local')) order by 1,2,3;

cqd TRAF_ENABLE_METADATA_LOAD_IN_SHARED_CACHE 'ON';
load trafodion metadata into shared cache; -- load into shared cache

-- should only load the system tables
delete all from table(natablecache('remove')); -- clean ntable cache first
load trafodion metadata in cache;

select context, num_entries from table(natablecache('user','local')) ;
select context, num_entries from table(natablecache('meta','local')) where num_entries > 0;
execute s1;

prepare xx from select a, b from t035_fact3;
select context, num_entries from table(natablecache('user','local')) ;
select context, num_entries from table(natablecache('meta','local')) where num_entries > 0;
execute s1;

prepare xx from select a, b from t035_cube1;
select context, num_entries from table(natablecache('user','local')) ;
select context, num_entries from table(natablecache('meta','local')) where num_entries > 0;
execute s1;

check trafodion metadata shared cache;
alter trafodion metadata shared cache for table t035_cube1 disable;
alter trafodion metadata shared cache for table t035_cube1 enable;
alter trafodion metadata shared cache for table t035_cube1 update;

check trafodion metadata shared cache for table t035_cube1;
check trafodion metadata shared cache;

alter trafodion metadata shared cache for table t035_cube1 delete;
check trafodion metadata shared cache;

alter trafodion metadata shared cache clear;
check trafodion metadata shared cache;

drop table t035_cube1;
drop table t035_fact3;

drop schema if exists t035sch cascade;

sh tdm_arkcmp -testMemoryExhaustion;
