
--==QID: 8

prepare xx from
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales_1stripeperfile
     ,date_dim
     ,store,
     (select ca_zip
     from (
       select * from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '38977','85746','60544','13350','60534','79540',
                          '71296','14176','29101','90389','81806',
                          '57057','37661','33363','42781','73102',
                          '88477','22788','12760','99274','28015',
                          '17448','14535','20407','69982','19881',
                          '41662','26062','32863','44171','32376',
                          '75908','71941','41305','92809','22513',
                          '71002','30446','25272','26929','29022',
                          '23393','19760','34759','95710','25290',
                          '45600','85699','38457','11291','55574',
                          '24167','53441','78912','60463','21434',
                          '30412','24560','38445','15484','10060',
                          '43972','14290','83499','10226','39768',
                          '74066','14195','66700','12909','84061',
                          '50708','89568','46829','89398','44572',
                          '93704','47982','62195','32415','55653',
                          '27115','14607','50086','18160','33737',
                          '35162','74411','42028','18190','32876',
                          '41558','56993','83930','24873','99051',
                          '23603','60602','98595','13547','75658',
                          '32097','46307','44782','28767','10797',
                          '30693','83703','75142','22996','62553',
                          '57426','88910','61405','47769','47659',
                          '60013','34156','31722','41443','87694',
                          '47463','44557','78937','80366','40592',
                          '10929','19919','31046','98425','78509',
                          '49102','21893','89538','42304','31790',
                          '38139','53005','79546','92516','68932',
                          '64862','17450','27753','17662','43681',
                          '44543','87276','10245','51157','19377',
                          '94484','53994','57938','94911','77799',
                          '15654','88735','19948','10507','11551',
                          '39689','68142','16050','28418','47391',
                          '43363','21044','57932','33501','80628',
                          '66693','50097','47078','49334','47418',
                          '98041','78557','83115','39151','83658',
                          '19330','31460','84910','58946','12067',
                          '46113','86429','47289','87062','94364',
                          '94118','18570','59583','40227','66258',
                          '37663','12752','95769','71968','70185',
                          '93327','80818','83503','85163','47196',
                          '59274','52146','36451','42762','44882',
                          '63909','28230','66713','37168','47765',
                          '25277','74223','68053','20067','14320',
                          '64066','33411','96838','17381','25048',
                          '33780','61431','13625','78204','12990',
                          '13856','60968','32983','46715','27611',
                          '30746','23990','42604','29314','60783',
                          '52006','99389','17101','55113','17628',
                          '67821','64231','27220','20588','71316',
                          '69359','35218','80946','91199','97022',
                          '86147','22508','16150','18212','11788',
                          '60015','36002','55461','58683','14572',
                          '72832','41023','94004','67407','95999',
                          '72713','61686','40904','31583','25966',
                          '16338','34962','15445','37322','22098',
                          '43094','52172','84728','38739','45218',
                          '15902','67305','65172','69635','52028',
                          '86383','66164','30322','16448','31660',
                          '40716','26546','85502','65678','53342',
                          '85069','20514','21992','37688','39052',
                          '20016','81871','36053','71813','51619',
                          '46802','90762','10606','48369','86846',
                          '77486','72652','31352','52290','93686',
                          '12434','13219','90353','64731','87081',
                          '57986','31254','60087','54104','22343',
                          '95844','40210','60049','18161','26553',
                          '46848','53919','61282','87704','51718',
                          '95378','16705','81015','15850','32386',
                          '18691','53112','56041','20821','24203',
                          '78626','14432','41517','34036','89890',
                          '71793','29867','28507','69222','27460',
                          '66755','95394','20994','15860','43202',
                          '10401','39398','17881','87339','56775',
                          '34072','12778','69539','52209','82032',
                          '99237','44531','31477','32801','58971',
                          '47739','38750','20014','26917','42982',
                          '31407','82065','30711','22326','40008',
                          '80225','25314','36438','39643','26960',
                          '80464','28848','14410','18185')
                      ) as ta where
     exists(
         select * from (
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10) ) as tb 
            where ta.ca_zip = tb.ca_zip) 
       )A2
       )V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;
