
--==QID: 70

prepare xx from
select  
    total_sum
   ,s_state
   ,s_county
   ,lochierarchy
   ,rank() over (
        partition by lochierarchy,
        case when t_county = 0 then s_state end 
        order by total_sum desc) as rank_within_parent
 from
   (
    select sum(ss_net_profit) as total_sum
      ,s_state
      ,s_county
      ,0 as t_state
      ,0 as t_county
      ,0 as lochierarchy
   from
      store_sales_1stripeperfile
      ,date_dim       d1
      ,store
   where
      d1.d_month_seq between 1197 and 1197+11
      and d1.d_date_sk = ss_sold_date_sk
      and s_store_sk  = ss_store_sk
      and s_state in
             ( select s_state
               from  (select s_state as s_state,
                            rank() over ( partition by s_state order by sum(ss_net_profit) desc) as ranking
                      from   store_sales_1stripeperfile, store, date_dim
                      where  d_month_seq between 1197 and 1197+11
                            and d_date_sk = ss_sold_date_sk
                            and s_store_sk  = ss_store_sk
                      group by s_state
                     ) tmp1 
               where ranking <= 5
             )
   group by (s_state,s_county)
union all
   select sum(ss_net_profit) as total_sum
      ,s_state
      ,null as s_county
      ,0 as t_state
      ,1 as t_county
      ,1 as lochierarchy
   from
      store_sales_1stripeperfile
      ,date_dim       d1
      ,store
   where
      d1.d_month_seq between 1197 and 1197+11
      and d1.d_date_sk = ss_sold_date_sk
      and s_store_sk  = ss_store_sk
      and s_state in
             ( select s_state
               from  (select s_state as s_state,
                            rank() over ( partition by s_state order by sum(ss_net_profit) desc) as ranking
                      from   store_sales_1stripeperfile, store, date_dim
                      where  d_month_seq between 1197 and 1197+11
                            and d_date_sk = ss_sold_date_sk
                            and s_store_sk  = ss_store_sk
                      group by s_state
                     ) tmp1 
               where ranking <= 5
             )
   group by (s_state)
union all
   select sum(ss_net_profit) as total_sum
      ,null as s_state
      ,null as s_county
      ,1 as t_state
      ,1 as t_county
      ,2 as lochierarchy
   from
      store_sales_1stripeperfile
      ,date_dim       d1
      ,store
   where
      d1.d_month_seq between 1197 and 1197+11
      and d1.d_date_sk = ss_sold_date_sk
      and s_store_sk  = ss_store_sk
      and s_state in
             ( select s_state
               from  (select s_state as s_state,
                            rank() over ( partition by s_state order by sum(ss_net_profit) desc) as ranking
                      from   store_sales_1stripeperfile, store, date_dim
                      where  d_month_seq between 1197 and 1197+11
                            and d_date_sk = ss_sold_date_sk
                            and s_store_sk  = ss_store_sk
                      group by s_state
                     ) tmp1 
               where ranking <= 5
             )   
   )
 order by
   lochierarchy desc
  ,rank_within_parent
  limit 100
 ;
