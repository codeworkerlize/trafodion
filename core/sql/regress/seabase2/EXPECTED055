>>
>>-- should not show any entries
>>cleanup metadata, check, return details;
Metadata Cleanup: started, check only

  Start: Cleanup Orphan Objects Entries
  End:   Cleanup Orphan Objects Entries (0 entries found)

  Start: Cleanup Orphan Hbase Entries
  End:   Cleanup Orphan Hbase Entries (0 entries found)

  Start: Cleanup Inconsistent Objects Entries
  End:   Cleanup Inconsistent Objects Entries (0 entries found)

  Start: Cleanup Inconsistent Partitions Entries
  End:   Cleanup Inconsistent Partitions Entries (0 entries found)

  Start: Cleanup Inconsistent Views Entries
  End:   Cleanup Inconsistent Views Entries (0 entries found)

  Start: Cleanup Inconsistent Hive Entries
  End:   Cleanup Inconsistent Hive Entries (0 entries found)

  Start: Cleanup Inconsistent Privilege Entries
  End:   Cleanup Inconsistent Privilege Entries (0 entries found)

  Start: Cleanup Inconsistent User Group Entries
  End:   Cleanup Inconsistent User Group Entries (0 entries found)

  Start: Cleanup Inconsistent TEXT Entries
  End:   Cleanup Inconsistent TEXT Entries (0 entries found)

Metadata Cleanup: done


--- SQL operation complete.
>>
>>cqd traf_blob_as_varchar 'OFF';

--- SQL operation complete.
>>
>>-- return error, tag doesn't exist
>>drop backup snapshot, tag 'test055';

*** ERROR[5050] DROP BACKUP SNAPSHOT command could not be completed. Reason: Specified tag does not exist.

--- SQL operation failed with errors.
>>
>>drop schema if exists sch055 cascade;

--- SQL operation complete.
>>create schema sch055;

--- SQL operation complete.
>>set schema sch055;

--- SQL operation complete.
>>cqd traf_restore_parallel '1';

--- SQL operation complete.
>>
>>-- precreate tags
>>backup trafodion, create tags ('test055incr1', 'test055incr2', 'test055incr3');

--- SQL operation complete.
>>
>>-- incremental backup tests
>>drop schema if exists sch0551 cascade;

--- SQL operation complete.
>>create schema if not exists sch0551;

--- SQL operation complete.
>>showddl schema sch0551;

CREATE PRIVATE SCHEMA TRAFODION.SCH0551 AUTHORIZATION DB__ROOT NAMESPACE
  'TRAF_regr'  STORED DESC ;

--- SQL operation complete.
>>
>>set schema sch0551;

--- SQL operation complete.
>>
>>cqd TRAF_NON_XN_INCR_BACKUP_OPERATION 'ON';

--- SQL operation complete.
>>create table loadt(
+>        colkey int not null,
+>        colint int not null,
+>        -- coldate date,
+>        colnum numeric(11,3),
+>        colchariso char(11) character set iso88591 not null,
+>        colcharucs2 char(11) character set ucs2 not null,
+>        colintn int,
+>        -- colts timestamp,
+>        colcharison char(13) character set iso88591,
+>        colcharucs2n char(13) character set ucs2,
+>        primary key(colint, colchariso, colcharucs2, colkey)
+>        ) attributes incremental backup
+>        ;

--- SQL operation complete.
>>
>>load into loadt select
+>         c1+c2*10+c3*100+c4*1000+c5*10000, --colkey
+>         c1+c2*10+c3*100+c4*1000+c5*10000, --colint
+>         cast(c1+c2*10+c3*100+c4*1000+c5*10000 as numeric(11,3)), --colnum
+>        cast(c1+c2*10+c3*100+c4*1000+c5*10000 as char(11) character set iso88591), --colchariso
+>          cast(c1+c2*10+c3*100+c4*1000+c5*10000 as char(11) character set ucs2), --colcharucs2
+>         c1+c2*10+c3*100+c4*1000+c5*10000, --colintn
+>         cast(c1+c2*10+c3*100+c4*1000+c5*10000 as char(13) character set iso88591), --colvchriso
+>         cast(c1+c2*10+c3*100+c4*1000+c5*10000 as char(13) character set ucs2) --colvchrucs2
+>         from (values(1)) t
+>         transpose 0,1,2,3,4,5,6,7,8,9 as c1
+>         transpose 0,1,2,3,4,5,6,7,8,9 as c2
+>         transpose 0,1,2,3,4,5,6,7,8,9 as c3
+>        transpose 0,1,2,3,4,5,6,7,8,9 as c4
+>        transpose 0,1,2,3,4,5,6,7,8,9 as c5
+>           ;
Task:  LOAD            Status: Started    Object: TRAFODION.SCH0551.LOADT
Task:  CLEANUP         Status: Started    Time: 2021-04-07 19:48:20.789178
Task:  CLEANUP         Status: Ended      Time: 2021-04-07 19:48:20.808790
Task:  CLEANUP         Status: Ended      Elapsed Time:    00:00:00.020
Task:  LOADING DATA    Status: Started    Time: 2021-04-07 19:48:20.808900
       Rows Processed: 100000 
       Error Rows:     0 
Task:  LOADING DATA    Status: Ended      Time: 2021-04-07 19:48:28.552516
Task:  LOADING DATA    Status: Ended      Elapsed Time:    00:00:07.744
Task:  COMPLETION      Status: Started    Time: 2021-04-07 19:48:28.552568
       Rows Loaded:    100000 
Task:  COMPLETION      Status: Ended      Time: 2021-04-07 19:48:29.553096
Task:  COMPLETION      Status: Ended      Elapsed Time:    00:00:01.001

--- 100000 row(s) loaded.
>>
>>select count(*) from loadt;

(EXPR)              
--------------------

              100000

--- 1 row(s) selected.
>>
>>-- Add 2 more rows to our incremental table
>>insert into loadt values(100001,100001,100001.000,'100001','100001',100001,'100001','100001');

--- 1 row(s) inserted.
>>insert into loadt values(100002,100002,100002.000,'100002','100002',100002,'100002','100002');

--- 1 row(s) inserted.
>>select count(*) from loadt;

(EXPR)              
--------------------

              100002

--- 1 row(s) selected.
>>
>>drop table loadt cascade;

--- SQL operation complete.
>>select count(*) from loadt;

*** ERROR[4082] Object TRAFODION.SCH0551.LOADT does not exist or is inaccessible.

*** ERROR[8822] The statement was not prepared.

>>cqd TRAF_NON_XN_INCR_BACKUP_OPERATION 'OFF';

--- SQL operation complete.
>>
>>create table t1incr(a int not null primary key, b int) 
+>  attribute incremental backup;

--- SQL operation complete.
>>showddl t1incr;

CREATE TABLE TRAFODION.SCH0551.T1INCR
  (
    A                                INT NO DEFAULT NOT NULL NOT DROPPABLE
  , B                                INT DEFAULT NULL
  , PRIMARY KEY (A ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_regr' INCREMENTAL BACKUP
;

--- SQL operation complete.
>>alter table t1incr attribute no incremental backup;

--- SQL operation complete.
>>showddl t1incr;

CREATE TABLE TRAFODION.SCH0551.T1INCR
  (
    A                                INT NO DEFAULT NOT NULL NOT DROPPABLE
  , B                                INT DEFAULT NULL
  , PRIMARY KEY (A ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_regr'
;

--- SQL operation complete.
>>alter table t1incr attribute incremental backup;

--- SQL operation complete.
>>create table t2noincr(a int);

--- SQL operation complete.
>>showddl t2noincr;

CREATE TABLE TRAFODION.SCH0551.T2NOINCR
  (
    A                                INT DEFAULT NULL
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_regr'
;

--- SQL operation complete.
>>create table t2incr(a int not null primary key, b int) 
+>  attribute incremental backup;

--- SQL operation complete.
>>showddl t2incr;

CREATE TABLE TRAFODION.SCH0551.T2INCR
  (
    A                                INT NO DEFAULT NOT NULL NOT DROPPABLE
  , B                                INT DEFAULT NULL
  , PRIMARY KEY (A ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_regr' INCREMENTAL BACKUP
;

--- SQL operation complete.
>>
>>insert into t2noincr values (1);

--- 1 row(s) inserted.
>>
>>insert into t1incr values (1, 10);

--- 1 row(s) inserted.
>>explain options 'f' insert into t1incr values (1,10);

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

1    .    2    root                  o         x                     1.00E+000
.    .    1    trafodion_insert                T1INCR                1.00E+000

--- SQL operation complete.
>>insert into t2incr values (1, 10);

--- 1 row(s) inserted.
>>upsert into t1incr values (1,10), (2,20), (3,30);

--- 3 row(s) inserted.
>>upsert into t2incr values (1,10), (2,20), (3,30);

--- 3 row(s) inserted.
>>update t1incr set b = 30 where a = 2;

--- 1 row(s) updated.
>>update t2incr set b = 30 where a = 2;

--- 1 row(s) updated.
>>delete from t1incr where a = 1 and b = 20;

--- 0 row(s) deleted.
>>delete from t2incr where a = 1 and b = 20;

--- 0 row(s) deleted.
>>-- expect (1, 10), (2, 30), (3, 30)
>>select * from t1incr;

A            B          
-----------  -----------

          1           10
          2           30
          3           30

--- 3 row(s) selected.
>>-- expect (1, 10), (2, 30), (3, 30)
>>select * from t2incr;

A            B          
-----------  -----------

          1           10
          2           30
          3           30

--- 3 row(s) selected.
>>update t1incr set b = 40 where a = 2;

--- 1 row(s) updated.
>>update t2incr set b = 40 where a = 2;

--- 1 row(s) updated.
>>-- expect (1, 10), (2, 40), (3, 30)
>>select * from t1incr;

A            B          
-----------  -----------

          1           10
          2           40
          3           30

--- 3 row(s) selected.
>>
>>-- expect (1, 10), (2, 40), (3, 30)
>>select * from t2incr;

A            B          
-----------  -----------

          1           10
          2           40
          3           30

--- 3 row(s) selected.
>>
>>create index t1incri1 on t1incr(b);

--- SQL operation complete.
>>showddl t1incr;

CREATE TABLE TRAFODION.SCH0551.T1INCR
  (
    A                                INT NO DEFAULT NOT NULL NOT DROPPABLE
  , B                                INT DEFAULT NULL
  , PRIMARY KEY (A ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_regr' INCREMENTAL BACKUP
;

CREATE INDEX T1INCRI1 ON TRAFODION.SCH0551.T1INCR
  (
    B ASC
  )
;

--- SQL operation complete.
>>insert into t1incr values (4,40);

--- 1 row(s) inserted.
>>select * from t1incr;

A            B          
-----------  -----------

          1           10
          3           30
          2           40
          4           40

--- 4 row(s) selected.
>>purgedata t1incr;

--- SQL operation complete.
>>
>>-- incr backup with cdc
>>drop table if exists t1incr6;

--- SQL operation complete.
>>create table t1incr6 (i int, j int) attribute incremental backup;

--- SQL operation complete.
>>upsert into t1incr6 values (1,1), (2, 2), (1, 2), (2, 1);

--- 4 row(s) inserted.
>>update t1incr6 set i = 5 where j = 2;

--- 2 row(s) updated.
>>delete from t1incr6 where i = 1;

--- 1 row(s) deleted.
>>
>>-- there should not be any locks.
>>get all locked objects;

--- SQL operation complete.
>>
>>-- should not be any orphans in metadata at this point
>>cleanup metadata, check, return details;
Metadata Cleanup: started, check only

  Start: Cleanup Orphan Objects Entries
  End:   Cleanup Orphan Objects Entries (0 entries found)

  Start: Cleanup Orphan Hbase Entries
  End:   Cleanup Orphan Hbase Entries (0 entries found)

  Start: Cleanup Inconsistent Objects Entries
  End:   Cleanup Inconsistent Objects Entries (0 entries found)

  Start: Cleanup Inconsistent Partitions Entries
  End:   Cleanup Inconsistent Partitions Entries (0 entries found)

  Start: Cleanup Inconsistent Views Entries
  End:   Cleanup Inconsistent Views Entries (0 entries found)

  Start: Cleanup Inconsistent Hive Entries
  End:   Cleanup Inconsistent Hive Entries (0 entries found)

  Start: Cleanup Inconsistent Privilege Entries
  End:   Cleanup Inconsistent Privilege Entries (0 entries found)

  Start: Cleanup Inconsistent User Group Entries
  End:   Cleanup Inconsistent User Group Entries (0 entries found)

  Start: Cleanup Inconsistent TEXT Entries
  End:   Cleanup Inconsistent TEXT Entries (0 entries found)

Metadata Cleanup: done


--- SQL operation complete.
>>
>>-- need to drop incr backup first as cascade option doesn't work yet. TBD.
>>drop backup snapshot, tag 'test055incr1';

*** ERROR[5050] DROP BACKUP SNAPSHOT command could not be completed. Reason: Specified tag does not exist.

--- SQL operation failed with errors.
>>drop backup snapshot, tag 'test055reg1', force, cascade;

*** ERROR[5050] DROP BACKUP SNAPSHOT command could not be completed. Reason: Specified tag does not exist.

--- SQL operation failed with errors.
>>
>>-- schema of restored table doesn't exist. Return error.TBD. mantis 6317
>>create schema if not exists sch055a namespace 'TRAF_regr' incremental backup;

--- SQL operation complete.
>>create table sch055a.t (a int);

--- SQL operation complete.
>>backup trafodion, tag 'test055reg1', table (sch055a.t), override;

--- SQL operation complete.
>>restore trafodion, tag 'test055reg1', table (sch055a.t), show objects;

MetaData Objects
================

TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".COLUMNS
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".COLUMN_PRIVILEGES
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".INDEXES
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".KEYS
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".LIBRARIES
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".LIBRARIES_USAGE
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".LOBCHUNKS__03093662417588457272
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".LOB_COLUMNS
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".OBJECTS
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".OBJECT_PRIVILEGES
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".REF_CONSTRAINTS
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".ROUTINES
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".SB_HISTOGRAMS
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".SB_HISTOGRAM_INTERVALS
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".SB_PERSISTENT_SAMPLES
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".SCHEMA_PRIVILEGES
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".SEQ_GEN
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".TABLES
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".TABLE_CONSTRAINTS
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".TEXT
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".UNIQUE_REF_CONSTR_USAGE
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".VIEWS
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".VIEWS_USAGE

User objects
============

TABLE:   TRAF_regr:TRAFODION.SCH055A.SB_HISTOGRAMS
TABLE:   TRAF_regr:TRAFODION.SCH055A.SB_HISTOGRAM_INTERVALS
TABLE:   TRAF_regr:TRAFODION.SCH055A.SB_PERSISTENT_SAMPLES
TABLE:   TRAF_regr:TRAFODION.SCH055A.T

Restore Stats
=============
  Total:     27
  Metadata:  23
  Tables:    4


--- SQL operation complete.
>>drop schema sch055a cascade;

--- SQL operation complete.
>>restore trafodion, tag 'test055reg1', table (sch055a.t), show objects;

MetaData Objects
================

TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".COLUMNS
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".COLUMN_PRIVILEGES
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".INDEXES
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".KEYS
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".LIBRARIES
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".LIBRARIES_USAGE
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".LOBCHUNKS__03093662417588457272
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".LOB_COLUMNS
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".OBJECTS
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".OBJECT_PRIVILEGES
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".REF_CONSTRAINTS
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".ROUTINES
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".SB_HISTOGRAMS
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".SB_HISTOGRAM_INTERVALS
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".SB_PERSISTENT_SAMPLES
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".SCHEMA_PRIVILEGES
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".SEQ_GEN
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".TABLES
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".TABLE_CONSTRAINTS
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".TEXT
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".UNIQUE_REF_CONSTR_USAGE
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".VIEWS
TRAF_RSRVD_3:TRAFODION."_BACKUP_test055reg1_".VIEWS_USAGE

User objects
============

TABLE:   TRAF_regr:TRAFODION.SCH055A.SB_HISTOGRAMS
TABLE:   TRAF_regr:TRAFODION.SCH055A.SB_HISTOGRAM_INTERVALS
TABLE:   TRAF_regr:TRAFODION.SCH055A.SB_PERSISTENT_SAMPLES
TABLE:   TRAF_regr:TRAFODION.SCH055A.T

Restore Stats
=============
  Total:     27
  Metadata:  23
  Tables:    4


--- SQL operation complete.
>>
>>restore trafodion, tag 'test055reg1', table (sch055a.t);

--- SQL operation complete.
>>showddl schema sch055a;

CREATE PRIVATE SCHEMA TRAFODION.SCH055A AUTHORIZATION DB__ROOT INCREMENTAL
  BACKUP  STORED DESC ;

--- SQL operation complete.
>>cleanup backup, tag 'test055reg1';

--- SQL operation complete.
>>
>>create schema if not exists sch055a namespace 'TRAF_regr' incremental backup;

--- SQL operation complete.
>>set schema sch055a;

--- SQL operation complete.
>>
>>-- full database backup and restore
>>create table tab2(c1 int,c2 int,c3 int,c4 int,c5 int, c6 int, c7 int, c8 int, c9 int, c10 int,c11 char(2),c12 char(2));

--- SQL operation complete.
>>insert into tab2 values(5,5,5,5,5,5,5,5,5,5,'5','5');

--- 1 row(s) inserted.
>>insert into tab2 values(6,6,6,6,6,6,6,6,6,6,'6','6');

--- 1 row(s) inserted.
>>backup trafodion, tag 'test055fulldb', override;

--- SQL operation complete.
>>insert into tab2 values(7,7,7,7,7,7,7,7,7,7,'7','7');

--- 1 row(s) inserted.
>>insert into tab2 values(8,8,8,8,8,8,8,8,8,8,'8','8');

--- 1 row(s) inserted.
>>backup trafodion, tag 'test055fulldbincr',incremental, override;

--- SQL operation complete.
>>get all backup snapshots, match 'test055%';

BackupTag           BackupTime           BackupStatus  BackupOperation        BackupOwner
===========================================================================================

test055reg1         2019-11-07:00:17:19  VALID         REGULAR                DB__ROOT
test055fulldb       2019-11-07:00:21:22  VALID         REGULAR                DB__ROOT
test055fulldbincr   2019-11-07:00:23:10  VALID         INCREMENTAL            DB__ROOT

--- SQL operation complete.
>>restore trafodion, tag 'test055fulldb', tables(tab2);

--- SQL operation complete.
>>select * from tab2;

C1           C2           C3           C4           C5           C6           C7           C8           C9           C10          C11  C12
-----------  -----------  -----------  -----------  -----------  -----------  -----------  -----------  -----------  -----------  ---  ---

          5            5            5            5            5            5            5            5            5            5  5    5  
          6            6            6            6            6            6            6            6            6            6  6    6  

--- 2 row(s) selected.
>>restore trafodion, tag 'test055fulldbincr', tables (tab2);

--- SQL operation complete.
>>select * from tab2;

C1           C2           C3           C4           C5           C6           C7           C8           C9           C10          C11  C12
-----------  -----------  -----------  -----------  -----------  -----------  -----------  -----------  -----------  -----------  ---  ---

          5            5            5            5            5            5            5            5            5            5  5    5  
          6            6            6            6            6            6            6            6            6            6  6    6  
          7            7            7            7            7            7            7            7            7            7  7    7  
          8            8            8            8            8            8            8            8            8            8  8    8  

--- 4 row(s) selected.
>>drop backup snapshot, tag 'test055fulldbincr';

--- SQL operation complete.
>>drop backup snapshot, tag 'test055fulldb', force, cascade;

--- SQL operation complete.
>>
>>-- restore after alter rename should cleanup. mantis 6897.
>>set schema sch055a;

--- SQL operation complete.
>>create table if not exists tabc (c1 int, c2 varchar(20));

--- SQL operation complete.
>>insert into tabc values(0,'traf');

--- 1 row(s) inserted.
>>backup trafodion, tag 'test055reg1', table(tabc), override;

--- SQL operation complete.
>>insert into tabc values (1, 'inc1');

--- 1 row(s) inserted.
>>drop hbase table "TRAF_regr:TRAFODION.SCH055A.TABC_OLD";

*** WARNING[1004] Object TRAF_regr:TRAFODION.SCH055A.TABC_OLD does not exist or object type is invalid for the current operation.

--- SQL operation complete.
>>get all hbase objects, match 'TRAF_regr:TRAFODION.SCH055A.TABC_OLD';

External HBase objects
======================


--- SQL operation complete.
>>alter table tabc rename to tabc_old;

--- SQL operation complete.
>>alter table tabc_old generate stored descriptor;

--- SQL operation complete.
>>invoke tabc;

*** ERROR[4082] Object TRAFODION.SCH055A.TABC does not exist or is inaccessible.

*** ERROR[8822] The statement was not prepared.

>>invoke tabc_old;

-- Definition of Trafodion table TRAFODION.SCH055A.TABC_OLD
-- Definition of hbase table TRAF_regr:TRAFODION.SCH055A.TABC_OLD
-- Definition current  Wed Apr  7 19:54:31 2021

  (
    SYSKEY                           LARGEINT NO DEFAULT NOT NULL NOT DROPPABLE
  , C1                               INT DEFAULT NULL
  , C2                               VARCHAR(20) CHARACTER SET ISO88591 COLLATE
      DEFAULT DEFAULT NULL
  )

--- SQL operation complete.
>>get all hbase objects, match 'TRAF_regr:TRAFODION.SCH055A.TABC_OLD';

External HBase objects
======================

TRAF_regr:TRAFODION.SCH055A.TABC_OLD

--- SQL operation complete.
>>get tables;

Tables in Schema TRAFODION.SCH055A
==================================

SB_HISTOGRAMS
SB_HISTOGRAM_INTERVALS
SB_PERSISTENT_SAMPLES
T
TAB2
TABC_OLD

=======================
 6 row(s) returned

--- SQL operation complete.
>>restore trafodion, tag 'test055reg1';

--- SQL operation complete.
>>
>>-- should not show TABC_OLD
>>get all hbase objects, match 'TRAF_regr:TRAFODION.SCH055A.TABC_OLD';

External HBase objects
======================

TRAF_regr:TRAFODION.SCH055A.TABC_OLD

--- SQL operation complete.
>>get tables;

Tables in Schema TRAFODION.SCH055A
==================================

SB_HISTOGRAMS
SB_HISTOGRAM_INTERVALS
SB_PERSISTENT_SAMPLES
T
TAB2
TABC

=======================
 6 row(s) returned

--- SQL operation complete.
>>drop hbase table "TRAF_regr:TRAFODION.SCH055A.TABC_OLD";

--- SQL operation complete.
>>
>>-- incr backup restore test. mantis-?
>>set schema sch055a;

--- SQL operation complete.
>>drop table if exists tabc;

--- SQL operation complete.
>>create table if not exists tabc (c1 int, c2 varchar(20));

--- SQL operation complete.
>>insert into tabc values(0,'traf');

--- 1 row(s) inserted.
>>backup trafodion, tag 'test055reg1', table(tabc), override;

--- SQL operation complete.
>>insert into tabc values (1, 'inc1');

--- 1 row(s) inserted.
>>backup trafodion, tag 'test055incr1', table(tabc), incremental, override;

--- SQL operation complete.
>>
>>-- keyword override will drop all dependent tags when backup type is REGULAR
>>-- backup tag 'test055incr1' should be droped
>>backup trafodion, tag 'test055reg1', table(tabc), override;

--- SQL operation complete.
>>
>>alter table tabc rename to tabc_old;

--- SQL operation complete.
>>alter table tabc_old generate stored descriptor;

--- SQL operation complete.
>>
>>create table tabc(a int, b int, c varchar(20));

--- SQL operation complete.
>>insert into tabc values(0,0,'traf');

--- 1 row(s) inserted.
>>insert into tabc values(1,1,'inc1');

--- 1 row(s) inserted.
>>backup trafodion, tag 'test055incr3', table(tabc), incremental, override;

--- SQL operation complete.
>>get all backup snapshots, match 'test055%';

BackupTag      BackupTime           BackupStatus  BackupOperation        BackupOwner
======================================================================================

test055reg1    2019-11-07:00:27:37  VALID         REGULAR                DB__ROOT
test055incr3   2019-11-07:00:28:52  VALID         INCREMENTAL            DB__ROOT

--- SQL operation complete.
>>
>>restore trafodion, tag 'test055incr3', table(tabc);

--- SQL operation complete.
>>backup trafodion, tag 'test055incr3', table(tabc),incremental, override;

--- SQL operation complete.
>>
>>get all backup snapshots, match 'test055%';

BackupTag      BackupTime           BackupStatus  BackupOperation        BackupOwner
======================================================================================

test055reg1    2019-11-07:00:27:37  VALID         REGULAR                DB__ROOT
test055incr3   2019-11-07:00:29:43  VALID         INCREMENTAL            DB__ROOT

--- SQL operation complete.
>>restore trafodion, tag 'test055incr3', table(tabc);

--- SQL operation complete.
>>
>>select * from tabc;

A            B            C                   
-----------  -----------  --------------------

          0            0  traf                
          1            1  inc1                

--- 2 row(s) selected.
>>get tables;

Tables in Schema TRAFODION.SCH055A
==================================

SB_HISTOGRAMS
SB_HISTOGRAM_INTERVALS
SB_PERSISTENT_SAMPLES
T
TAB2
TABC
TABC_OLD

=======================
 7 row(s) returned

--- SQL operation complete.
>>delete from tabc;

--- 2 row(s) deleted.
>>restore trafodion, tag 'test055incr3';

--- SQL operation complete.
>>get tables;

Tables in Schema TRAFODION.SCH055A
==================================

SB_HISTOGRAMS
SB_HISTOGRAM_INTERVALS
SB_PERSISTENT_SAMPLES
T
TAB2
TABC
TABC_OLD

=======================
 7 row(s) returned

--- SQL operation complete.
>>select * from tabc;

A            B            C                   
-----------  -----------  --------------------

          0            0  traf                
          1            1  inc1                

--- 2 row(s) selected.
>>-- incrmental backup tag 'test055incr1' not exists
>>restore trafodion, tag 'test055incr1';

*** ERROR[5050] RESTORE command could not be completed. Reason: Specified tag does not exist.

--- SQL operation failed with errors.
>>-- expect (0,0,'traf'), (1,1,'inc1')
>>select * from tabc;

A            B            C
-----------  -----------  --------------------

          0            0  traf
          1            1  inc1

--- 2 row(s) selected.
>>
>>-- cleanup TABC_OLD
>>drop hbase table "TRAF_regr:TRAFODION.SCH055A.TABC_OLD";

--- SQL operation complete.
>>
>>-- incr backup restore test when table renamed and 
>>-- then renamed back to the original. mantis-7202
>>-- This needs to be enabled at a later date.
>>-- Now causes Too many zookeeper connections and
>>-- CorruptSnapshotExceptions
>>-- drop backup snapshot, tag 'test055incr1';
>>-- drop backup snapshot, tag 'test055reg1';
>>-- drop table if exists tabc;
>>-- drop table if exists tabc_new;
>>-- drop hbase table "TRAF_regr:TRAFODION.SCH055A.TABC";
>>-- drop hbase table "TRAF_regr:TRAFODION.SCH055A.TABC_NEW";
>>-- create table tabc(a int, b varchar(20)) attribute incremental backup;
>>-- insert into tabc values(1,'base'),(2,'base');
>>-- --regular backup for table
>>-- backup trafodion, tag 'test055tabc_bkbase1';
>>-- insert into  tabc values(1,'inc1'),(2,'inc1');
>>-- backup trafodion, tag 'test055tabc_incbk1', incremental, override;
>>-- --alter rename
>>-- alter table tabc rename to tabc_new;
>>-- alter table tabc_new generate stored descriptor;
>>
>>-- cleanup old table
>>-- backup trafodion, tag 'test055tabc_new_bkbase1';
>>-- get tables;
>>-- insert into tabc_new values(10,'inc2'),(11,'inc2');
>>-- backup trafodion, tag 'test055tabc_new_incbk2',incremental, override;
>>
>>-- --expect (1,'base'),(2,'base'),(1,'inc1'),(2,'inc1'),(10,'inc2'),(11,'inc2')
>>-- select * from tabc_new;
>>
>>-- alter table tabc_new rename to tabc;
>>-- alter table tabc generate stored descriptor;
>>
>>-- cleanup old table
>>-- --drop hbase table "TRAF_regr:TRAFODION.SCH055A.TABC_NEW";
>>-- backup trafodion, tag 'test055tabc_incbk3',incremental, override;
>>-- insert into tabc values(20,'inc3'),(21,'inc3');
>>
>>-- --expect (1,'base'),(2,'base'),(1,'inc1'),(2,'inc1'),(10,'inc2'),(11,'inc2'),(20,'inc3'),(21,'inc3')
>>-- select * from tabc;
>>
>>-- backup trafodion, tag 'test055tabc_incbk3',incremental, override;
>>-- insert into tabc values(30,'inc4'),(31,'inc4');
>>
>>-- --expect (1,'base'),(2,'base'),(1,'inc1'),(2,'inc1'),(10,'inc2'),(11,'inc2'),(20,'inc3'),(21,'inc3'),(30,'inc4'),(31,'inc4')
>>-- select * from  tabc;
>>
>>-- drop table tabc cascade;
>>-- restore trafodion, tag 'test055tabc_incbk1';
>>-- --expect (1,'base'),(2,'base'),(1,'inc1'),(2,'inc1')
>>-- select * from tabc;
>>-- drop table tabc cascade;
>>
>>-- restore trafodion, tag 'test055tabc_new_incbk2';
>>-- --expect(1,'base'),(2,'base'),(1,'inc1'),(2,'inc1'),(10,'inc2'),(11,'inc2')
>>-- select * from tabc_new;
>>-- drop table tabc_new cascade;
>>
>>-- restore trafodion, tag 'test055tabc_incbk3';
>>-- --- SQL operation complete.
>>-- --expect (1,'base'),(2,'base'),(1,'inc1'),(2,'inc1'),(10,'inc2'),(11,'inc2'),(20,'inc3'),(21,'inc3')
>>-- select * from tabc;
>>
>>-- 'Alter add' after restore - Mantis 7475
>>delete from tabc;

--- 2 row(s) deleted.
>>-- sql return error, table tabc have 3 columns
>>insert into tabc values(0,'base');

*** ERROR[4023] The degree of each row value constructor (2) must equal the degree of the target table column list (3).

*** ERROR[8822] The statement was not prepared.

>>backup trafodion, tag 'test055_altadd_regbk', tables(tabc),override;

--- SQL operation complete.
>>
>>--inc1: alter add
>>alter table tabc add column c3 varchar(20);

--- SQL operation complete.
>>showddl tabc;

CREATE TABLE TRAFODION.SCH055A.TABC
  (
    A                                INT DEFAULT NULL
  , B                                INT DEFAULT NULL
  , C                                VARCHAR(20) CHARACTER SET ISO88591 COLLATE
      DEFAULT DEFAULT NULL
  , C3                               VARCHAR(20) CHARACTER SET ISO88591 COLLATE
      DEFAULT DEFAULT NULL /*added_col*/
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_regr' INCREMENTAL BACKUP
;

--- SQL operation complete.
>>
>>--incbk1
>>insert into tabc values(1,1,'inc1','inc1');

--- 1 row(s) inserted.
>>--expect (1,1,'inc1','inc1')
>>select * from tabc;

A            B            C                     C3
-----------  -----------  --------------------  --------------------

          1            1  inc1                  inc1

--- 1 row(s) selected.
>>backup trafodion, tag 'test055incr1', tables(tabc), incremental,override;

--- SQL operation complete.
>>
>>--inc2
>>insert into tabc values(2,2,'inc2','inc2');

--- 1 row(s) inserted.
>>--expect (1,1,'inc1','inc1'),(2,2,'inc2','inc2')
>>select * from tabc;

A            B            C                     C3
-----------  -----------  --------------------  --------------------

          1            1  inc1                  inc1
          2            2  inc2                  inc2

--- 2 row(s) selected.
>>backup trafodion, tag 'test055incr2', tables(tabc), incremental,override;

--- SQL operation complete.
>>
>>--incbk3
>>alter table tabc attribute no incremental backup;

--- SQL operation complete.
>>-- aflter add column tabc has 5 columns
>>alter table tabc add column c4 char(8);

--- SQL operation complete.
>>insert into tabc values(3,3,'no-inc3','no-inc3','no-inc3');

--- 1 row(s) inserted.
>>--expect (1,1,'inc1','inc1',?),(2,2,'inc2','inc2',?),(3,3,'no-inc3','no-inc3','no-inc3')
>>select * from tabc;

A            B            C                     C3                    C4
-----------  -----------  --------------------  --------------------  --------

          1            1  inc1                  inc1                  ?
          2            2  inc2                  inc2                  ?
          3            3  no-inc3               no-inc3               no-inc3

--- 3 row(s) selected.
>>backup trafodion, tag 'test055incr3', tables(tabc), incremental,override;

--- SQL operation complete.
>>
>>drop table tabc cascade;

--- SQL operation complete.
>>--restore test055tabc_incbk2
>>-- This should accomplish 2 things.  It should restore a version of tabc
>>-- that has the incremental backup attribute and it should exclude mutations
>>-- from test055tabc_incbk4 from future backup operations
>>restore trafodion, tag 'test055incr2';

--- SQL operation complete.
>>showddl tabc;

CREATE TABLE TRAFODION.SCH055A.TABC
  (
    A                                INT DEFAULT NULL
  , B                                INT DEFAULT NULL
  , C                                VARCHAR(20) CHARACTER SET ISO88591 COLLATE
      DEFAULT DEFAULT NULL
  , C3                               VARCHAR(20) CHARACTER SET ISO88591 COLLATE
      DEFAULT DEFAULT NULL /*added_col*/
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_regr' INCREMENTAL BACKUP
;

--- SQL operation complete.
>>--expect (1,1,'inc1','inc1'),(2,2,'inc2','inc2')
>>select * from tabc;

A            B            C                     C3
-----------  -----------  --------------------  --------------------

          1            1  inc1                  inc1
          2            2  inc2                  inc2

--- 2 row(s) selected.
>>
>>--incbk4
>>backup trafodion, tag 'test055incr4', tables(tabc), incremental,override;

--- SQL operation complete.
>>delete from tabc;

--- 2 row(s) deleted.
>>insert into tabc values(3,3,'inc4','inc4');

--- 1 row(s) inserted.
>>select * from tabc;

A            B            C                     C3
-----------  -----------  --------------------  --------------------

          3            3  inc4                  inc4

--- 1 row(s) selected.
>>
>>--incbk5
>>backup trafodion, tag 'test055incr5', tables(tabc), incremental,override;

--- SQL operation complete.
>>drop table tabc cascade;

--- SQL operation complete.
>>
>>--restore incbk5
>>restore trafodion, tag 'test055incr5';

--- SQL operation complete.
>>showddl tabc;

CREATE TABLE TRAFODION.SCH055A.TABC
  (
    A                                INT DEFAULT NULL
  , B                                INT DEFAULT NULL
  , C                                VARCHAR(20) CHARACTER SET ISO88591 COLLATE
      DEFAULT DEFAULT NULL
  , C3                               VARCHAR(20) CHARACTER SET ISO88591 COLLATE
      DEFAULT DEFAULT NULL /*added_col*/
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_regr' INCREMENTAL BACKUP
;

--- SQL operation complete.
>>select * from tabc;

A            B            C                     C3
-----------  -----------  --------------------  --------------------

          3            3  inc4                  inc4

--- 1 row(s) selected.
>>
>>-- end state
>>get all backup snapshots, match 'test055%';

BackupTag              BackupTime           BackupStatus  BackupOperation        BackupOwner
==============================================================================================

test055reg1            2019-11-07:00:27:37  VALID         REGULAR                DB__ROOT
test055_altadd_regbk   2019-11-07:00:33:55  VALID         REGULAR                DB__ROOT
test055incr1           2019-11-07:00:34:10  VALID         INCREMENTAL            DB__ROOT
test055incr2           2019-11-07:00:34:31  VALID         INCREMENTAL            DB__ROOT
test055incr3           2019-11-07:00:34:58  VALID         INCREMENTAL            DB__ROOT
test055incr4           2019-11-07:00:37:43  VALID         INCREMENTAL            DB__ROOT
test055incr5           2019-11-07:00:39:49  VALID         INCREMENTAL            DB__ROOT

--- SQL operation complete.
>>get all backup tags, show details, match 'test055%';

BackupTag             BackupTime           BackupStatus  BackupOperation        BackupOwner
=============================================================================================

test055fulldbincr                          NO_SNAPSHOT   UNKNOWN                Not Available
test055reg1           2019-11-07:00:27:12  VALID         REGULAR                DB__ROOT
test055_altadd_regbk  2019-11-07:00:32:03  VALID         REGULAR                DB__ROOT
test055incr1          2019-11-07:00:34:01  VALID         INCREMENTAL            DB__ROOT
test055incr2          2019-11-07:00:34:19  VALID         INCREMENTAL            DB__ROOT
test055incr3          2019-11-07:00:34:48  VALID         INCREMENTAL            DB__ROOT
test055incr4          2019-11-07:00:36:00  VALID         INCREMENTAL            DB__ROOT
test055incr5          2019-11-07:00:37:53  VALID         INCREMENTAL            DB__ROOT

--- SQL operation complete.
>>drop all backup snapshots, match 'test055%';

--- SQL operation complete.
>>get all backup tags, show details, match 'test055%';

BackupTag             BackupTime           BackupStatus  BackupOperation        BackupOwner
=============================================================================================

test055fulldbincr                          NO_SNAPSHOT   UNKNOWN                Not Available
test055incr1                               NO_SNAPSHOT   UNKNOWN                Not Available
test055incr2                               NO_SNAPSHOT   UNKNOWN                Not Available
test055incr3                               NO_SNAPSHOT   UNKNOWN                Not Available
test055incr4                               NO_SNAPSHOT   UNKNOWN                Not Available
test055incr5                               NO_SNAPSHOT   UNKNOWN                Not Available
test055reg1                                NO_SNAPSHOT   UNKNOWN                Not Available
test055_altadd_regbk                       NO_SNAPSHOT   UNKNOWN                Not Available

--- SQL operation complete.
>>get all backup metadata, match 'test055%';

Metadata(OBSOLETE  ): _BACKUP_test055_altadd_regbk_
Metadata(OBSOLETE  ): _BACKUP_test055fulldbincr_
Metadata(OBSOLETE  ): _BACKUP_test055incr1_
Metadata(OBSOLETE  ): _BACKUP_test055incr2_
Metadata(OBSOLETE  ): _BACKUP_test055incr3_
Metadata(OBSOLETE  ): _BACKUP_test055incr4_
Metadata(OBSOLETE  ): _BACKUP_test055incr5_
Metadata(OBSOLETE  ): _BACKUP_test055reg1_

--- SQL operation complete.
>>
>>log;
