-- @@@ START COPYRIGHT @@@
--
-- Licensed to the Apache Software Foundation (ASF) under one
-- or more contributor license agreements.  See the NOTICE file
-- distributed with this work for additional information
-- regarding copyright ownership.  The ASF licenses this file
-- to you under the Apache License, Version 2.0 (the
-- "License"); you may not use this file except in compliance
-- with the License.  You may obtain a copy of the License at
--
--   http://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing,
-- software distributed under the License is distributed on an
-- "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
-- KIND, either express or implied.  See the License for the
-- specific language governing permissions and limitations
-- under the License.
--
-- @@@ END COPYRIGHT @@@
--
-- test for backup and restore system
--   only elevated users can backup/restore using the system option
--

obey TEST058(clean_up);
log LOG058 clear;
obey TEST058(create_db);
obey TEST058(dbroot_tests);
sh sqlci -i "TEST058(user_tests)" -u sql_user1;
sh sqlci -i "TEST058(user_tests)" -u db__admin;
log;
obey TEST058(clean_up);
exit;

?section clean_up
drop backup snapshot, tag 'bk-sys-058';
drop schema test058sch cascade;
sh rm_snapshots.sh;

?section create_db
create schema test058sch authorization sql_user1;
set schema test058sch;
create table t1incr(a int not null primary key, b int)
  attribute incremental backup;
showddl t1incr;
insert into t1incr values (1,1), (2,2), (3,3), (4,4), (5,5), (6,6);
get privileges for user sql_user1, match '%058%';

?section dbroot_tests
-- ============================================================================
-- DB__ROOT can perform back ups
-- ============================================================================
VALUES(CURRENT_USER);
backup system, tag 'bk-sys-058';
get all backup snapshots, match '%058%';
get version of backup, tag 'bk-sys-058';
--restore system, tag 'bk-sys-058', show objects;

-- error cases
restore system, tag 'bk-sys-058';
restore trafodion, tag 'bk-sys-058', tables(t1incr);
restore system, tag 'bk-sys-058', tables(t1incr);
restore system, tag 'bk-no-exists';

drop backup snapshot, tag 'bk-sys-058';
get all backup snapshots, match '%058%';

-- there should not be any locks.
get all locked objects;

-- should not be any orphans in metadata at this point
cleanup metadata, check, return details;

?section user_tests
-- ============================================================================
-- sql_user1 cannot backup, no priv
-- db__admin can backup, elevated user
-- ============================================================================
log LOG058;
VALUES(CURRENT_USER);

cqd TRAF_BACKUP_SKIP_GET_TAGS_OWNER_LOOKUP 'OFF';
backup system, tag 'bk-sys-058';
get all backup snapshots, match '%058%';
