>>
>>drop schema if exists test056sch cascade;

--- SQL operation complete.
>>create schema if not exists test056sch;

--- SQL operation complete.
>>set schema test056sch;

--- SQL operation complete.
>>
>>cqd auto_query_retry 'OFF';

--- SQL operation complete.
>>
>>-- session 1: cleanup objects
>>cleanup backup, tag 'test056tag';

--- SQL operation complete.
>>
>>drop table if exists test056t1 cascade;

--- SQL operation complete.
>>drop table if exists test056t2 cascade;

--- SQL operation complete.
>>create table test056t1 (a int primary key, b int);

--- SQL operation complete.
>>create table test056t2 (a int, b int, foreign key(b) references test056t1(a));

--- SQL operation complete.
>>create index test056t1i1 on test056t1(a);

--- SQL operation complete.
>>drop view if exists vtest056_1;

--- SQL operation complete.
>>drop view if exists vtest056_2;

--- SQL operation complete.
>>create view vtest056_1 as select * from test056t1;

--- SQL operation complete.
>>
>>-- session 2: backup and return with object locked
>>set envvar BACKUP_ERR_INJECT_3_2;

--- SQL operation complete.
>>backup trafodion, tag 'test056tag', override, table (test056t1);

*** ERROR[5050] This command could not be completed. Error injected at BACKUP_ERR_INJECT_3_2.

--- SQL operation failed with errors.
>>
>>-- session 3: only selects are enabled, IUD are not
>>cqd traf_br_locked_objects_query_type '0';

--- SQL operation complete.
>>invoke test056t1;

-- Definition of Trafodion table TRAFODION.TEST056SCH.TEST056T1
-- Definition of hbase table TRAF_regr:TRAFODION.TEST056SCH.TEST056T1
-- Definition current  Wed Nov  6 23:44:17 2019

  (
    A                                INT NO DEFAULT NOT NULL NOT DROPPABLE
  , B                                INT DEFAULT NULL
  )
  PRIMARY KEY (A ASC)

--- SQL operation complete.
>>select * from test056t1;

--- 0 row(s) selected.
>>
>>-- insert should return error.
>>insert into test056t1(a) values (100);

*** ERROR[4264] Object TRAFODION.TEST056SCH.TEST056T1I1 is locked by a backup or restore operation and cannot be accessed until that operation is finished. Details: test056tag(BACKUP)

*** ERROR[4082] Object TRAFODION.TEST056SCH.TEST056T1I1 does not exist or is inaccessible.

*** ERROR[8822] The statement was not prepared.

>>
>>-- session 4: selects/IUD are enabled but ddl should return error.
>>cqd traf_br_locked_objects_query_type '1';

--- SQL operation complete.
>>
>>invoke test056t1;

-- Definition of Trafodion table TRAFODION.TEST056SCH.TEST056T1
-- Definition of hbase table TRAF_regr:TRAFODION.TEST056SCH.TEST056T1
-- Definition current  Wed Nov  6 23:44:17 2019

  (
    A                                INT NO DEFAULT NOT NULL NOT DROPPABLE
  , B                                INT DEFAULT NULL
  )
  PRIMARY KEY (A ASC)

--- SQL operation complete.
>>invoke test056t2;

-- Definition of Trafodion table TRAFODION.TEST056SCH.TEST056T2
-- Definition of hbase table TRAF_regr:TRAFODION.TEST056SCH.TEST056T2
-- Definition current  Wed Nov  6 23:44:17 2019

  (
    SYSKEY                           LARGEINT NO DEFAULT NOT NULL NOT DROPPABLE
  , A                                INT DEFAULT NULL
  , B                                INT DEFAULT NULL
  )

--- SQL operation complete.
>>
>>drop table test056t1;

*** ERROR[4264] Object TRAFODION.TEST056SCH.TEST056T1 is locked by a backup or restore operation and cannot be accessed until that operation is finished. Details: test056tag(BACKUP)

--- SQL operation failed with errors.
>>drop table test056t2;

*** ERROR[4264] Object TRAFODION.TEST056SCH.TEST056T1 is locked by a backup or restore operation and cannot be accessed until that operation is finished. Details: test056tag(BACKUP)

--- SQL operation failed with errors.
>>drop view vtest056_1;

*** ERROR[4264] Object TRAFODION.TEST056SCH.TEST056T1 is locked by a backup or restore operation and cannot be accessed until that operation is finished. Details: test056tag(BACKUP)

--- SQL operation failed with errors.
>>drop index test056t1i1;

*** ERROR[4264] Object TRAFODION.TEST056SCH.TEST056T1 is locked by a backup or restore operation and cannot be accessed until that operation is finished. Details: test056tag(BACKUP)

*** ERROR[4082] Object TRAFODION.TEST056SCH.TEST056T1 does not exist or is inaccessible.

*** ERROR[4082] Object TRAFODION.TEST056SCH.TEST056T1I1 does not exist or is inaccessible.

--- SQL operation failed with errors.
>>
>>invoke test056t1;

-- Definition of Trafodion table TRAFODION.TEST056SCH.TEST056T1
-- Definition of hbase table TRAF_regr:TRAFODION.TEST056SCH.TEST056T1
-- Definition current  Wed Nov  6 23:44:19 2019

  (
    A                                INT NO DEFAULT NOT NULL NOT DROPPABLE
  , B                                INT DEFAULT NULL
  )
  PRIMARY KEY (A ASC)

--- SQL operation complete.
>>select * from test056t1;

--- 0 row(s) selected.
>>insert into test056t1(a) values (100);

--- 1 row(s) inserted.
>>update test056t1 set a = 20;

--- 1 row(s) updated.
>>delete from test056t1;

--- 1 row(s) deleted.
>>update statistics for table test056t1 on every column;

*** ERROR[9200] UPDATE STATISTICS for table TRAFODION.TEST056SCH.TEST056T1 encountered an error  (4264) from statement Process_Query.

*** ERROR[4264] Object TRAFODION.TEST056SCH.TEST056T1 is locked by a backup or restore operation and cannot be accessed until that operation is finished. Details: test056tag(BACKUP)

*** ERROR[4082] Object TRAFODION.TEST056SCH.TEST056T1 does not exist or is inaccessible.

--- SQL operation failed with errors.
>>
>>alter table test056t1 drop column d;

*** ERROR[4264] Object TRAFODION.TEST056SCH.TEST056T1 is locked by a backup or restore operation and cannot be accessed until that operation is finished. Details: test056tag(BACKUP)

--- SQL operation failed with errors.
>>alter table test056t1 add column d int;

*** ERROR[4264] Object TRAFODION.TEST056SCH.TEST056T1 is locked by a backup or restore operation and cannot be accessed until that operation is finished. Details: test056tag(BACKUP)

--- SQL operation failed with errors.
>>alter table test056t1 add constraint ctest056t1 check (a > 0);

*** ERROR[4264] Object TRAFODION.TEST056SCH.TEST056T1 is locked by a backup or restore operation and cannot be accessed until that operation is finished. Details: test056tag(BACKUP)

*** ERROR[4082] Object TRAFODION.TEST056SCH.TEST056T1 does not exist or is inaccessible.

--- SQL operation failed with errors.
>>drop table test056t1;

*** ERROR[4264] Object TRAFODION.TEST056SCH.TEST056T1 is locked by a backup or restore operation and cannot be accessed until that operation is finished. Details: test056tag(BACKUP)

*** ERROR[4082] Object TRAFODION.TEST056SCH.TEST056T1 does not exist or is inaccessible.

--- SQL operation failed with errors.
>>create table test056t1 (a int);

*** ERROR[1390] Object TRAFODION.TEST056SCH.TEST056T1 already exists in Trafodion.

--- SQL operation failed with errors.
>>create index test056t1i1 on test056t1(a);

*** ERROR[4264] Object TRAFODION.TEST056SCH.TEST056T1 is locked by a backup or restore operation and cannot be accessed until that operation is finished. Details: test056tag(BACKUP)

*** ERROR[4082] Object TRAFODION.TEST056SCH.TEST056T1 does not exist or is inaccessible.

--- SQL operation failed with errors.
>>drop index test056t1i1;

*** ERROR[4264] Object TRAFODION.TEST056SCH.TEST056T1 is locked by a backup or restore operation and cannot be accessed until that operation is finished. Details: test056tag(BACKUP)

*** ERROR[4082] Object TRAFODION.TEST056SCH.TEST056T1 does not exist or is inaccessible.

*** ERROR[4082] Object TRAFODION.TEST056SCH.TEST056T1I1 does not exist or is inaccessible.

--- SQL operation failed with errors.
>>create view vtest056_2 as select * from test056t1;

*** ERROR[4264] Object TRAFODION.TEST056SCH.TEST056T1 is locked by a backup or restore operation and cannot be accessed until that operation is finished. Details: test056tag(BACKUP)

*** ERROR[4082] Object TRAFODION.TEST056SCH.TEST056T1 does not exist or is inaccessible.

--- SQL operation failed with errors.
>>drop view vtest056_2;

*** ERROR[1389] Object TRAFODION.TEST056SCH.VTEST056_2 does not exist in Trafodion.

--- SQL operation failed with errors.
>>
>>-- session 5: selects/IUD/ddl are enabled
>>cqd traf_br_locked_objects_query_type '2';

--- SQL operation complete.
>>invoke test056t1;

-- Definition of Trafodion table TRAFODION.TEST056SCH.TEST056T1
-- Definition of hbase table TRAF_regr:TRAFODION.TEST056SCH.TEST056T1
-- Definition current  Wed Nov  6 23:44:30 2019

  (
    A                                INT NO DEFAULT NOT NULL NOT DROPPABLE
  , B                                INT DEFAULT NULL
  )
  PRIMARY KEY (A ASC)

--- SQL operation complete.
>>select * from test056t1;

--- 0 row(s) selected.
>>insert into test056t1(a) values (100);

--- 1 row(s) inserted.
>>create view vtest056_2 as select * from test056t1;

--- SQL operation complete.
>>drop view vtest056_2;

--- SQL operation complete.
>>
>>-- session 6: unlock
>>cleanup backup, tag 'test056tag';

--- SQL operation complete.
>>
>>-- return tag option to return the backup tag
>>reset envvar BACKUP_ERR_INJECT_3_2;

--- SQL operation complete.
>>cqd traf_br_locked_objects_query_type reset;

--- SQL operation complete.
>>backup trafodion, tag 'test056tag2', table (test056t1), return tag;
test056tag2_00212439872681810881

--- SQL operation complete.
>>backup trafodion, tag 'test056tag2', override, table (test056t1), return tag;
test056tag2

--- SQL operation complete.
>>
>>-- return tag error cases
>>backup trafodion, tag 'test056tag2', table (test056t1), return tag, show objects;

*** ERROR[5050] BACKUP command could not be completed. Reason: RETURN TAG cannot be specified with 'show objects' or 'return status'.

*** ERROR[8822] The statement was not prepared.

>>backup trafodion, tag 'test056tag2', table (test056t1), return tag, return status;

*** ERROR[5050] BACKUP command could not be completed. Reason: RETURN TAG cannot be specified with 'show objects' or 'return status'.

*** ERROR[8822] The statement was not prepared.

>>restore trafodion, tag 'test056tag2', table (test056t1), return tag;

*** ERROR[5050] RESTORE command could not be completed. Reason: RETURN TAG is not supported.

*** ERROR[8822] The statement was not prepared.

>>
>>-- backup + export: should return error
>>backup trafodion, table (test056t1), tag 'test056tag2', 
+>         export to location '/invalid/target/location';

*** ERROR[5050] EXPORT BACKUP command could not be completed. Reason: Backup completed but export failed due to an error returned from exportOrImportBackup method. To redo just the export, issue a separate 'export backup' command with tag 'test056tag2_00212439872928460311'

--- SQL operation failed with errors.
>>
>>
>>-- BREI progress status
>>set parserflags 131072;

--- SQL operation complete.
>>truncate "_REPOS_".brei_progress_status_table;

--- SQL operation complete.
>>reset parserflags 131072;

--- SQL operation complete.
>>
>>drop table if exists test056t1 cascade;

--- SQL operation complete.
>>create table test056t1 (a int primary key, b int);

--- SQL operation complete.
>>
>>get progress status for current backup;

--- SQL operation complete.
>>get progress status for current restore;

--- SQL operation complete.
>>get progress status for current export;

--- SQL operation complete.
>>get progress status for current import;

--- SQL operation complete.
>>
>>--backup trafodion, tag 'test056tag3', table (test056t1), override;
>>backup trafodion, tag 'test056tag3', schema (test056sch), override;

--- SQL operation complete.
>>get progress status for current backup;


BACKUP Progress Status for tag "test056tag3"
============================================


Step               State        ET        Progress
======             =======      ====      ==========

Initialize         Completed    00:00:00  100%
CreateMetadata     Completed    00:01:28  100%(22/22)
SetupMetadata      Completed    00:00:18  100%(4/4)
BackupObjects      Completed    00:00:05  100%(29/29)
Finalize           Completed    00:00:01  100%


BACKUP End Status for tag "test056tag3"
=======================================

StartTime: 2019-11-06 23:51:34 (local time)
EndTime:   2019-11-06 23:53:29 (local time)
ET:        00:01:55 (hh:mm:ss)


--- SQL operation complete.
>>
>>sh echo "export backup to location '$HDFS_URL/user/trafodion/schgsexport', tag 'test056tag3';" > tmp_export_test056;
>>obey tmp_export_test056;
>>export backup to location 'hdfs://localhost:36000/user/trafodion/schgsexport', tag 'test056tag3';

--- SQL operation complete.
>>get progress status of current export;


EXPORT Progress Status for tag "test056tag3"
============================================


Step               State        ET        Progress
======             =======      ====      ==========

Initialize         Completed    00:00:00  100%
ExportObjects      Completed    00:01:56  100%(29/29)
Finalize           Completed    00:00:00  100%


EXPORT End Status for tag "test056tag3"
=======================================

StartTime: 2019-11-06 23:53:30 (local time)
EndTime:   2019-11-06 23:55:27 (local time)
ET:        00:01:57 (hh:mm:ss)


--- SQL operation complete.
>>
>>drop table test056t1 cascade;

--- SQL operation complete.
>>drop backup tag, tag 'test056tag3';

--- SQL operation complete.
>>
>>sh echo "import backup from location '$HDFS_URL/user/trafodion/schgsexport', tag 'test056tag3', override;" > tmp_export_test056;
>>obey tmp_export_test056;
>>import backup from location 'hdfs://localhost:36000/user/trafodion/schgsexport', tag 'test056tag3', override;

--- SQL operation complete.
>>get progress status for current import;


IMPORT Progress Status for tag "test056tag3"
============================================


Step               State        ET        Progress
======             =======      ====      ==========

Initialize         Completed    00:00:00  100%
ImportObjects      Completed    00:02:00  100%(29/29)
Finalize           Completed    00:00:00  100%


IMPORT End Status for tag "test056tag3"
=======================================

StartTime: 2019-11-06 23:58:05 (local time)
EndTime:   2019-11-07 00:00:06 (local time)
ET:        00:02:00 (hh:mm:ss)


--- SQL operation complete.
>>
>>restore trafodion, tag 'test056tag3';

--- SQL operation complete.
>>get progress status for current restore;


RESTORE Progress Status for tag "test056tag3"
=============================================


Step               State        ET        Progress
======             =======      ====      ==========

Initialize         Completed    00:00:00  100%
CreateMetadata     Completed    00:01:20  100%(22/22)
RestoreObjects     Completed    00:02:33  100%(29/29)
Finalize           Completed    00:00:03  100%


RESTORE End Status for tag "test056tag3"
========================================

StartTime: 2019-11-07 00:00:06 (local time)
EndTime:   2019-11-07 00:04:06 (local time)
ET:        00:03:59 (hh:mm:ss)


--- SQL operation complete.
>>
>>select * from test056t1;

--- 0 row(s) selected.
>>
>>get progress status for last backup;


BACKUP Progress Status for tag "test056tag3"
============================================


Step               State        ET        Progress
======             =======      ====      ==========

Initialize         Completed    00:00:00  100%
CreateMetadata     Completed    00:01:28  100%(22/22)
SetupMetadata      Completed    00:00:18  100%(4/4)
BackupObjects      Completed    00:00:05  100%(29/29)
Finalize           Completed    00:00:01  100%


BACKUP End Status for tag "test056tag3"
=======================================

StartTime: 2019-11-06 23:51:34 (local time)
EndTime:   2019-11-06 23:53:29 (local time)
ET:        00:01:55 (hh:mm:ss)


--- SQL operation complete.
>>get progress status for last restore;


RESTORE Progress Status for tag "test056tag3"
=============================================


Step               State        ET        Progress
======             =======      ====      ==========

Initialize         Completed    00:00:00  100%
CreateMetadata     Completed    00:01:20  100%(22/22)
RestoreObjects     Completed    00:02:33  100%(29/29)
Finalize           Completed    00:00:03  100%


RESTORE End Status for tag "test056tag3"
========================================

StartTime: 2019-11-07 00:00:06 (local time)
EndTime:   2019-11-07 00:04:06 (local time)
ET:        00:03:59 (hh:mm:ss)


--- SQL operation complete.
>>get progress status of last export;


EXPORT Progress Status for tag "test056tag3"
============================================


Step               State        ET        Progress
======             =======      ====      ==========

Initialize         Completed    00:00:00  100%
ExportObjects      Completed    00:01:56  100%(29/29)
Finalize           Completed    00:00:00  100%


EXPORT End Status for tag "test056tag3"
=======================================

StartTime: 2019-11-06 23:53:30 (local time)
EndTime:   2019-11-06 23:55:27 (local time)
ET:        00:01:57 (hh:mm:ss)


--- SQL operation complete.
>>get progress status of last import;


IMPORT Progress Status for tag "test056tag3"
============================================


Step               State        ET        Progress
======             =======      ====      ==========

Initialize         Completed    00:00:00  100%
ImportObjects      Completed    00:02:00  100%(29/29)
Finalize           Completed    00:00:00  100%


IMPORT End Status for tag "test056tag3"
=======================================

StartTime: 2019-11-06 23:58:05 (local time)
EndTime:   2019-11-07 00:00:06 (local time)
ET:        00:02:00 (hh:mm:ss)


--- SQL operation complete.
>>
>>-- cleanup
>>cleanup backup, tag 'test056tag2';

--- SQL operation complete.
>>cleanup backup, tag 'test056tag3';

--- SQL operation complete.
>>
>>log;
