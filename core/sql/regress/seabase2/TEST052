
-- @@@ START COPYRIGHT @@@
--
-- Licensed to the Apache Software Foundation (ASF) under one
-- or more contributor license agreements.  See the NOTICE file
-- distributed with this work for additional information
-- regarding copyright ownership.  The ASF licenses this file
-- to you under the Apache License, Version 2.0 (the
-- "License"); you may not use this file except in compliance
-- with the License.  You may obtain a copy of the License at
--
--   http://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing,
-- software distributed under the License is distributed on an
-- "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
-- KIND, either express or implied.  See the License for the
-- specific language governing permissions and limitations
-- under the License.
--
-- @@@ END COPYRIGHT @@@
--
-- test for BACKUP and RESTORE, part 3
--

drop all backup snapshots, match 'tag052%';
cleanup table sch052.t1;
cleanup table sch052.t1incr;
cleanup schema sch052;
cleanup table sch052inc.test1;
cleanup schema sch052inc;

drop backup snapshot, tag 'tag052_reg';
drop obsolete backup metadata, tag 'tag052_reg';
drop backup snapshot, tag 'tag052_incr';
drop obsolete backup metadata, tag 'tag052_incr';

cleanup metadata, return details;

log LOG052 clear;

-- should not show any entries
cleanup metadata, check, return details;

drop schema if exists sch052 cascade;
create schema sch052;
drop schema if exists sch052inc cascade;
create schema sch052inc incremental backup;
set schema sch052;
cqd traf_restore_parallel '1';

---------------------------------
-- test1 Alter table drop column
---------------------------------
drop table t1;
drop all backup snapshots, match 'tag052%';

create table t1(a int no default not null primary key, b varchar(20),c3 int) 
   attribute incremental backup;
insert into t1 values(1,'base',1),(2,'base',2);
select * from t1;
--regular backup for table
backup trafodion, tag 'tag052_reg', tables(t1),override;

--inc1: alter drop
alter table t1 drop column c3;
insert into t1 values(3,'inc1');
select * from t1;

--incbk1, t1t2
backup trafodion, tag 'tag052_incr', tables(t1), incremental,override;

drop table t1 cascade;
--restore incbk1
restore trafodion, tag 'tag052_incr';

--Expect (1,'base'), (2,'base'), (3,'inc1')
select * from t1;

---------------------------------------------------------------
-- test1a Alter table drop column , start with reg table first
-------------------------------------------------------------
drop table t1;
drop all backup snapshots, match 'tag052%';

create table t1(a int no default not null primary key, b varchar(20),c3 int); 

insert into t1 values(1,'base',1),(2,'base',2);
select * from t1;
--regular backup for table
backup trafodion, tag 'tag052_reg', tables(t1),override;

--inc1: alter drop
alter table t1 drop column c3;
alter table t1 attribute incremental backup;

insert into t1 values(3,'inc1');
select * from t1;

--incbk1, t1t2
backup trafodion, tag 'tag052_incr', tables(t1), incremental,override;

drop table t1 cascade;
--restore incbk1
restore trafodion, tag 'tag052_incr';

--Expect (1,'base'), (2,'base'), (3,'inc1')
select * from t1;

------------------------------------------
-- test2 Alter table incremental attribute
------------------------------------------
drop table t1;
drop all backup snapshots, match 'tag052%';

create table t1(a int no default not null primary key, b varchar(20),c3 int); 
insert into t1 values(1,'base',1),(2,'base',2);
select * from t1;
--regular backup for table
backup trafodion, tag 'tag052_reg', tables(t1),override;

insert into t1 values(3,'base1',3),(4,'base1',4);

--inc1: alter attribute incremental backup
alter table t1 attribute incremental backup;
insert into t1 values(5,'inc1', 5);
select * from t1;

--incbk1, t1t2
backup trafodion, tag 'tag052_incr', tables(t1), incremental,override;

drop table t1 cascade;
--restore incbk1
restore trafodion, tag 'tag052_incr';

--Expect (1,'base',1),(2,'base',2),(3,'base1',3),(4,'base1',4);(5,'inc1', 5);
select * from t1;

--------------------------------------------------------------------
-- test2a Alter table incremental attribute, no reg backup, only incr 
--------------------------------------------------------------------
drop table t1;
drop all backup snapshots, match 'tag052%';

--//this one needed to make sure there are no matching snapshots from
--//internal old backups.
drop all backup snapshots; 

create table t1(a int no default not null primary key, b varchar(20),c3 int); 
insert into t1 values(1,'base',1),(2,'base',2);
select * from t1;

--NO regular backup for table
--backup trafodion, tag 'tag052_reg', tables(t1),override;

insert into t1 values(3,'base1',3),(4,'base1',4);

--inc1: alter attribute incremental backup
alter table t1 attribute incremental backup;
insert into t1 values(5,'inc1', 5);
select * from t1;

--incbk1, t1t2
backup trafodion, tag 'tag052_incr', tables(t1), incremental,override;

drop table t1 cascade;
--restore incbk1
restore trafodion, tag 'tag052_incr';

--Expect (1,'base',1),(2,'base',2),(3,'base1',3),(4,'base1',4);(5,'inc1', 5);
select * from t1;


--------------------------------------------------------------------
-- test2b Alter table incremental attribute to regular 
--------------------------------------------------------------------
drop table t1;
drop all backup snapshots, match 'tag052%';

create table t1(a int no default not null primary key, b varchar(20),c3 int)
   attribute incremental backup; 
insert into t1 values(1,'base',1),(2,'base',2);
select * from t1;

--regular backup for table
backup trafodion, tag 'tag052_reg', tables(t1),override;

insert into t1 values(3,'base1',3),(4,'base1',4);

--inc1: alter attribute incremental backup
alter table t1 attribute no incremental backup;
insert into t1 values(5,'inc1', 5);
select * from t1;

--incbk1, t1t2
backup trafodion, tag 'tag052_incr', tables(t1), incremental,override;

drop table t1 cascade;
--restore incbk1
restore trafodion, tag 'tag052_incr';

--Expect (1,'base',1),(2,'base',2),(3,'base1',3),(4,'base1',4);(5,'inc1', 5);
select * from t1;



--------------------------------------------------------------------
-- test3 Alter table add column 
--------------------------------------------------------------------
drop table t1;
drop all backup snapshots, match 'tag052%';

create table t1(a int no default not null primary key, b varchar(20)); 

insert into t1 values(1,'base'),(2,'base');
select * from t1;
--regular backup for table
backup trafodion, tag 'tag052_reg', tables(t1),override;

--inc1: alter add column
alter table t1  add column c3 int;
alter table t1 attribute incremental backup;

insert into t1 values(3,'inc1',3);
select * from t1;

--incbk1, t1t2
backup trafodion, tag 'tag052_incr', tables(t1), incremental,override;

drop table t1 cascade;
--restore incbk1
restore trafodion, tag 'tag052_incr';

--Expect (1,'base'), (2,'base'), (3,'inc1',3)
select * from t1;


--------------------------------------------------------------------
-- test4 Alter table alter column datatype 
--------------------------------------------------------------------
drop table t1;
drop all backup snapshots, match 'tag052%';

create table t1(a int no default not null primary key, b varchar(20), c3 int); 

insert into t1 values(1,'base', 1),(2,'base', 2);
select * from t1;
--regular backup for table
backup trafodion, tag 'tag052_reg', tables(t1),override;

--inc1: alter add column
alter table t1 alter column c3 largeint;
alter table t1 attribute incremental backup;

insert into t1 values(3,'inc1',3);
select * from t1;

--incbk1, t1t2
backup trafodion, tag 'tag052_incr', tables(t1), incremental,override;

drop table t1 cascade;
--restore incbk1
restore trafodion, tag 'tag052_incr';

--Expect (1,'base',1),(2,'base',2),(3,'base1',3)
select * from t1;

--------------------------------------------------------------------
-- test5 drop and create same table between two incremental bkps 
--------------------------------------------------------------------
drop table t1;
drop all backup snapshots, match 'tag052%';

--regular backup for table
create table t1(a int no default not null primary key, b varchar(20), c3 int)
    attribute incremental backup; 
insert into t1 values(1,'base', 1),(2,'base', 2);
backup trafodion, tag 'tag052_reg', tables(t1),override;

--inc1
insert into t1 values(3,'inc1',3);
backup trafodion, tag 'tag052_incr', tables(t1), incremental,override;

--drop and recreate
drop table t1 cascade;
create table t1(a int no default not null primary key, b varchar(20), c3 int)
    attribute incremental backup; 
insert into t1 values(4,'inc1',4);
backup trafodion, tag 'tag052_incr', tables(t1), incremental,override;

--inc2 
insert into t1 values(5,'inc1',5);
backup trafodion, tag 'tag052_incr', tables(t1), incremental,override;
select * from t1;

--restore inc
restore trafodion, tag 'tag052_incr';

--Expect (4,'inc1',4),(5,'inc1',5)
select * from t1;

--------------------------------------------------------------------
-- test6 Alter table rename and alter add column 
--------------------------------------------------------------------
drop table t1;
drop table tadd;
drop all backup snapshots, match 'tag052%';

create table t1(a int no default not null primary key, b varchar(20), c3 int)
       attribute incremental backup; 

insert into t1 values(1,'base', 1),(2,'base', 2);
select * from t1;
--regular backup for table
backup trafodion, tag 'tag052_reg', tables(t1),override;

--alter
alter table t1 rename to tadd;
alter table tadd add column d1 varchar(10);

insert into tadd values(3,'inc1',3, 'test');
select * from tadd;

--incbk
backup trafodion, tag 'tag052_incr', tables(tadd), incremental,override,show objects;
backup trafodion, tag 'tag052_incr', tables(tadd), incremental,override;

drop table tadd cascade;

--restore incbk1
restore trafodion, tag 'tag052_incr', show objects;
restore trafodion, tag 'tag052_incr';

--Expect (1,'base',1),(2,'base',2),(3,'base1',3, 'test')
select * from tadd;
alter table tadd rename to t1;

----------------------------------------------
-- teste1 Error inject tests
----------------------------------------------
drop table t1;
drop all backup snapshots, match 'tag052%';

set envvar BACKUP_ERR_INJECT_BEFORE_HIATUS;

create table t1(a int no default not null primary key, b varchar(20),c3 int) 
   attribute incremental backup;

alter table t1 drop column c3;
alter table t1 add column c4 int;
alter table t1 alter column c3 largeint;
alter table t1 rename to t2;
alter table t1 attribute no incremental backup;

reset envvar BACKUP_ERR_INJECT_BEFORE_HIATUS;


--------------------------------------------
--teste2 clearHiatus test
--------------------------------------------
drop table t1;
drop all backup snapshots, match 'tag052%';

create table t1(a int no default not null primary key, b varchar(20),c3 int)
   attribute incremental backup; 
  
--alter drop of non existing column causes setHiatus and clearhiatus to unwind.
alter table t1 drop column xyz;

------------------------------------------------------------------
-- teste2 hiatus test that require internal handling of warning
-----------------------------------------------------------------
drop table t1;
drop all backup snapshots, match 'tag052%';

-- drop table after all backups deleted.
create table t1(a int no default not null primary key, b varchar(20),c3 int) 
   attribute incremental backup;
backup trafodion, tag 'tag052_reg', tables(t1),override;
drop backup snapshot , tag 'tag052_reg';
drop table t1;


-- alter rename many times.
create table t1(a int no default not null primary key, b varchar(20),c3 int) 
   attribute incremental backup;
alter table t1 rename to t2;
alter table t2 rename to t3;
alter table t3 rename to t1;

--  Test case for Mantis-7546
set schema sch052inc;
create table test1(
cno     varchar(3)       not null,
cname   varchar(22)      not null,
cdescp  varchar(25)      not null,
cred    int,
clabfee numeric(5,2),
cdept   varchar(4)       not null
) attribute incremental backup;

insert into test1 values
('C11', 'INTRO TO CS','FOR ROOKIES',3, 100, 'CIS');
insert into test1 values
('C22', 'DATA STRUCTURES','VERY USEFUL',3, 50, 'CIS');
backup trafodion, tag 'tag052_reg', table(test1),incremental,override;

insert into test1 values
('P11', 'EMPIRICISM','SEE IT-BELIEVE IT',3, 100, 'PHIL');

select * from test1;
backup trafodion, tag 'tag052_ovrd', table(test1),incremental,override;

-- Override the same tag, but backup the entire schema and REGULAR backup
-- This override will delete the previous incremental backup, leaving
-- the associated mutations unattached because this backup is regular
backup trafodion, tag 'tag052_ovrd', schema(rep123sch),override;

insert into test1 values
('P22', 'RATIONALISM','FOR CIS MAJORS',3, 50, 'PHIL');
select * from test1;

backup trafodion, tag 'tag052_ovrd', table(test1),incremental,override;
delete from test1;

-- Make sure the deletes are still excluded from the restore.
restore trafodion, tag 'tag052_ovrd';
select * from test1;

--------------------------------------------
--END
--------------------------------------------

-- there should not be any locks.
get all locked objects;

-- should not be any orphans in metadata at this point
cleanup metadata, check, return details;

get all backup snapshots, match 'test052%';
get all backup tags, show details, match 'test052%';
drop all backup snapshots, match 'test052%';
get all backup tags, show details, match 'test052%';
get all backup metadata, match 'test052%';
drop all backup snapshots, match 'tag052%';
get all backup snapshots, match 'tag052%';

log;

-- clean up
--revoke select on t1 from sql_user1;
revoke select on schema sch052 from sql_user1;

