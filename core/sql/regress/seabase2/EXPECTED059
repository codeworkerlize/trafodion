>>
>>-- should not show any entries
>>cleanup metadata, check, return details;
Metadata Cleanup: started, check only

  Start: Cleanup Orphan Objects Entries
  End:   Cleanup Orphan Objects Entries (0 entries found)

  Start: Cleanup Orphan Hbase Entries
  End:   Cleanup Orphan Hbase Entries (0 entries found)

  Start: Cleanup Inconsistent Objects Entries
  End:   Cleanup Inconsistent Objects Entries (0 entries found)

  Start: Cleanup Inconsistent Partitions Entries
  End: Cleanup Inconsistent Partitions Entries (0 entries found)

  Start: Cleanup Inconsistent Views Entries
  End:   Cleanup Inconsistent Views Entries (0 entries found)

  Start: Cleanup Inconsistent Hive Entries
  End:   Cleanup Inconsistent Hive Entries (0 entries found)

  Start: Cleanup Inconsistent Privilege Entries
  End:   Cleanup Inconsistent Privilege Entries (0 entries found)

  Start: Cleanup Inconsistent User Group Entries
  End:   Cleanup Inconsistent User Group Entries (0 entries found)

  Start: Cleanup Inconsistent TEXT Entries
  End: Cleanup Inconsistent TEXT Entries (0 entries found)

Metadata Cleanup: done


--- SQL operation complete.
>>
>>cqd traf_blob_as_varchar 'OFF';

--- SQL operation complete.
>>
>>-- return error, tag doesn't exist
>>drop backup snapshot, tag 'test059';

*** ERROR[5050] DROP BACKUP SNAPSHOT command could not be completed. Reason: Specified tag does not exist.

--- SQL operation failed with errors.
>>
>>drop schema if exists sch059 cascade;

--- SQL operation complete.
>>create schema sch059;

--- SQL operation complete.
>>set schema sch059;

--- SQL operation complete.
>>cqd traf_restore_parallel '1';

--- SQL operation complete.
>>
>>-- precreate tags
>>backup trafodion, create tags ('test059reg', 'test059incr1', 'test059incr2');

--- SQL operation complete.
>>
>>-- incremental backup tests
>>drop schema if exists sch059 cascade;

--- SQL operation complete.
>>create schema if not exists sch059;

--- SQL operation complete.
>>showddl schema sch059;

CREATE PRIVATE SCHEMA TRAFODION.SCH059 AUTHORIZATION DB__ROOT NAMESPACE
  'TRAF_regr'  STORED DESC ;

--- SQL operation complete.
>>
>>set schema sch059;

--- SQL operation complete.
>>
>>create table t1incr(a int not null primary key, b int) 
+>  attribute incremental backup;

--- SQL operation complete.
>>showddl t1incr;

CREATE TABLE TRAFODION.SCH059.T1INCR
  (
    A                                INT NO DEFAULT NOT NULL NOT DROPPABLE
  , B                                INT DEFAULT NULL
  , PRIMARY KEY (A ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_regr' INCREMENTAL BACKUP
;

--- SQL operation complete.
>>alter table t1incr attribute no incremental backup;

--- SQL operation complete.
>>showddl t1incr;

CREATE TABLE TRAFODION.SCH059.T1INCR
  (
    A                                INT NO DEFAULT NOT NULL NOT DROPPABLE
  , B                                INT DEFAULT NULL
  , PRIMARY KEY (A ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_regr'
;

--- SQL operation complete.
>>alter table t1incr attribute incremental backup;

--- SQL operation complete.
>>create table t2noincr(a int);

--- SQL operation complete.
>>showddl t2noincr;

CREATE TABLE TRAFODION.SCH059.T2NOINCR
  (
    A                                INT DEFAULT NULL
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_regr'
;

--- SQL operation complete.
>>create table t2incr(a int not null primary key, b int, c blob) 
+>  attribute incremental backup;

--- SQL operation complete.
>>showddl t2incr;

CREATE TABLE TRAFODION.SCH059.T2INCR
  (
    A                                INT NO DEFAULT NOT NULL NOT DROPPABLE
  , B                                INT DEFAULT NULL
  , C                                BLOB( 5368709120 bytes) DEFAULT NULL
  , PRIMARY KEY (A ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_regr' INCREMENTAL BACKUP
;

--- SQL operation complete.
>>
>>insert into t2noincr values (1);

--- 1 row(s) inserted.
>>
>>insert into t1incr values (1, 10);

--- 1 row(s) inserted.
>>explain options 'f' insert into t1incr values (1,10);

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

1    .    2    root                  o         x                     1.00E+000
.    .    1    trafodion_insert                T1INCR                1.00E+000

--- SQL operation complete.
>>insert into t2incr values (1, 10, '50');

--- 1 row(s) inserted.
>>backup trafodion, tag 'test059reg', tables (t1incr, t2incr, t2noincr), override;

--- SQL operation complete.
>>upsert into t1incr values (1,10), (2,20), (3,30);

--- 3 row(s) inserted.
>>upsert into t2incr values (1,10,'10');

--- 1 row(s) inserted.
>>upsert into t2incr values (2,20,'20');

--- 1 row(s) inserted.
>>upsert into t2incr values (3,30,'30');

--- 1 row(s) inserted.
>>backup trafodion, tag 'test059incr1', tables (t2noincr, t1incr, t2incr), incremental, override;

--- SQL operation complete.
>>update t1incr set b = 30 where a = 2;

--- 1 row(s) updated.
>>update t2incr set b = 30 where a = 2;

--- 1 row(s) updated.
>>update t2incr set c = '30' where a = 2;

--- 1 row(s) updated.
>>delete from t1incr where a = 1 and b = 20;

--- 0 row(s) deleted.
>>delete from t2incr where a = 1 and b = 20;

--- 0 row(s) deleted.
>>-- expect (1, 10), (2, 30), (3, 30)
>>select * from t1incr;

A            B          
-----------  -----------

          1           10
          2           30
          3           30

--- 3 row(s) selected.
>>-- expect (1, 10, '10'), (2, 30, '30'), (3, 30, '30')
>>select a, b, lobtostring(c,100) from t2incr;

A            B            (EXPR)
-----------  -----------  ----------------------------------------------------------------------------------------------------

          1           10  10                                                                                                  
          2           30  30                                                                                                  
          3           30  30                                                                                                  

--- 3 row(s) selected.
>>-- Here we have pending mutations for t1incr and t2incr.  When we restore a subset of
>>-- incremental tables from the incremental backup we should see mutations for t1incr
>>-- removed, but mutations for t2incr left untouched.  A subsequent backup will prove.
>>-- Mantis 7197
>>
>>backup trafodion, tag 'test059incr2', tables (t2noincr, t1incr, t2incr), incremental, override;

--- SQL operation complete.
>>update t1incr set b = 40 where a = 2;

--- 1 row(s) updated.
>>update t2incr set b = 40 where a = 2;

--- 1 row(s) updated.
>>update t2incr set c = '40' where a = 2;

--- 1 row(s) updated.
>>
>>showddl t1incr;

CREATE TABLE TRAFODION.SCH059.T1INCR
  (
    A                                INT NO DEFAULT NOT NULL NOT DROPPABLE
  , B                                INT DEFAULT NULL
  , PRIMARY KEY (A ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_regr' INCREMENTAL BACKUP
;

--- SQL operation complete.
>>select * from t1incr;

A            B          
-----------  -----------

          1           10
          2           40
          3           30

--- 3 row(s) selected.
>>
>>--- export/import of incremental backup and restore, involves mutations.
>>get all backup snapshots, match 'test059%';

BackupTag      BackupTime           BackupStatus  BackupOperation        BackupOwner
======================================================================================

test059reg     2019-11-07:01:30:25  VALID         REGULAR                DB__ROOT
test059incr1   2019-11-07:01:30:46  VALID         INCREMENTAL            DB__ROOT
test059incr2   2019-11-07:01:31:16  VALID         INCREMENTAL            DB__ROOT

--- SQL operation complete.
>>select a, b, lobtostring(c,100) from t2incr;

A            B            (EXPR)
-----------  -----------  ----------------------------------------------------------------------------------------------------

          1           10  10                                                                                                  
          2           40  40                                                                                                  
          3           30  30                                                                                                  

--- 3 row(s) selected.
>>sh echo "export backup to location '$HDFS_URL/user/trafodion/backups' , tag 'test059reg';" > tmp_export_test59;
>>obey tmp_export_test59;
>>export backup to location 'hdfs://localhost:36000/user/trafodion/backups' , tag 'test059reg';

--- SQL operation complete.
>>sh echo "export backup to location '$HDFS_URL/user/trafodion/backups' , tag 'test059incr1';" > tmp_export_test59;
>>obey tmp_export_test59;
>>export backup to location 'hdfs://localhost:36000/user/trafodion/backups' , tag 'test059incr1';

--- SQL operation complete.
>>sh echo "export backup to location '$HDFS_URL/user/trafodion/backups' , tag 'test059incr2';" > tmp_export_test59;
>>obey tmp_export_test59;
>>export backup to location 'hdfs://localhost:36000/user/trafodion/backups' , tag 'test059incr2';

--- SQL operation complete.
>>drop backup snapshot, tag 'test059incr2';

--- SQL operation complete.
>>drop table t2incr cascade;

--- SQL operation complete.
>>get all backup snapshots, match 'test059%';

BackupTag      BackupTime           BackupStatus  BackupOperation        BackupOwner
======================================================================================

test059reg     2019-11-07:01:30:25  VALID         REGULAR                DB__ROOT
test059incr1   2019-11-07:01:30:46  VALID         INCREMENTAL            DB__ROOT

--- SQL operation complete.
>>get tables;

Tables in Schema TRAFODION.SCH059
=================================

SB_HISTOGRAMS
SB_HISTOGRAM_INTERVALS
SB_PERSISTENT_SAMPLES
T1INCR
T2NOINCR

=======================
 5 row(s) returned

--- SQL operation complete.
>>sh echo "import backup from location '$HDFS_URL/user/trafodion/backups' , tag 'test059incr2', override;" > tmp_import_test59;
>>obey tmp_import_test59;
>>import backup from location 'hdfs://localhost:36000/user/trafodion/backups' , tag 'test059incr2', override;

--- SQL operation complete.
>>get all backup snapshots, match 'test059%';

BackupTag      BackupTime           BackupStatus  BackupOperation        BackupOwner
======================================================================================

test059reg     2019-11-07:01:30:25  VALID         REGULAR                DB__ROOT
test059incr1   2019-11-07:01:30:46  VALID         INCREMENTAL            DB__ROOT
test059incr2   2019-11-07:01:31:34  VALID         INCREMENTAL(IMPORTED)  DB__ROOT

--- SQL operation complete.
>>get version of backup, tag 'test059incr2';

  Current Database Version: EsgynDB Advanced 2.7.0.   Expected Database Version: EsgynDB Advanced 2.7.0
  Current Metadata Version: Metadata Version 2.6.0.   Expected Metadata Version: Metadata Version 2.6.0
  Current Product Version : QianBase 1.3.0.   Expected Product Version : QianBase 1.3.0
  Backup is current.

--- SQL operation complete.
>>restore trafodion, tag 'test059incr2';

--- SQL operation complete.
>>get tables;

Tables in Schema TRAFODION.SCH059
=================================

LOBCHUNKS__04627093409705812673
SB_HISTOGRAMS
SB_HISTOGRAM_INTERVALS
SB_PERSISTENT_SAMPLES
T1INCR
T2INCR
T2NOINCR

=======================
 7 row(s) returned

--- SQL operation complete.
>>showddl t2incr;

CREATE TABLE TRAFODION.SCH059.T2INCR
  (
    A                                INT NO DEFAULT NOT NULL NOT DROPPABLE
  , B                                INT DEFAULT NULL
  , C                                BLOB( 5368709120 bytes) DEFAULT NULL
  , PRIMARY KEY (A ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_regr' INCREMENTAL BACKUP
;

--- SQL operation complete.
>>-- expect (1, 10, '10'), (2, 30, '30'), (3, 30, '30')
>>select a, b, lobtostring(c,100) from t2incr;

A            B            (EXPR)
-----------  -----------  ----------------------------------------------------------------------------------------------------

          1           10  10                                                                                                  
          2           30  30                                                                                                  
          3           30  30                                                                                                  

--- 3 row(s) selected.
>>
>>--- error case: export import must have valid hdfs url.
>>sh echo "export backup to location '/user/trafodion/backups' , tag 'test059incr2';" > tmp_export_test59;
>>obey tmp_export_test59;
>>export backup to location '/user/trafodion/backups' , tag 'test059incr2';

*** ERROR[5050] EXPORT BACKUP command could not be completed. Reason: Error returned from exportOrImportBackup method.

--- SQL operation failed with errors.
>>
>>-- expect (1, 10), (2, 30), (3, 30)
>>select * from t1incr;

A            B          
-----------  -----------

          1           10
          2           30
          3           30

--- 3 row(s) selected.
>>-- need to drop incr backup first as cascade option doesn't work yet. TBD.
>>drop backup snapshot, tag 'test059incr2';

--- SQL operation complete.
>>drop backup snapshot, tag 'test059incr1';

--- SQL operation complete.
>>drop backup snapshot, tag 'test059reg', force, cascade;

--- SQL operation complete.
>>
>>-- BREI progress status
>>set parserflags 131072;

--- SQL operation complete.
>>truncate "_REPOS_".brei_progress_status_table;

--- SQL operation complete.
>>reset parserflags 131072;

--- SQL operation complete.
>>
>>set schema sch059;

--- SQL operation complete.
>>drop table if exists test059t1 cascade;

--- SQL operation complete.
>>create table test059t1 (a int primary key, b int);

--- SQL operation complete.
>>insert into test059t1 values (100, 200);

--- 1 row(s) inserted.
>>
>>--backup trafodion, tag 'test059tag3', table (test059t1), override;
>>backup trafodion, tag 'test059tag3', schema (sch059), override;

--- SQL operation complete.
>>get progress status for current backup;


BACKUP Progress Status for tag "test059tag3"
============================================


Step               State        ET        Progress
======             =======      ====      ==========

Initialize         Completed    00:00:00  100%
CreateMetadata     Completed    00:01:36  100%(22/22)
SetupMetadata      Completed    00:00:21  100%(4/4)
BackupObjects      Completed    00:00:07  100%(32/32)
Finalize           Completed    00:00:01  100%


BACKUP End Status for tag "test059tag3"
=======================================

StartTime: 2019-11-07 00:40:52 (local time)
EndTime:   2019-11-07 00:43:00 (local time)
ET:        00:02:07 (hh:mm:ss)


--- SQL operation complete.
>>
>>sh echo "export backup to location '$HDFS_URL/user/trafodion/schgsexport', tag 'test059tag3';" > tmp_export_test059;
>>obey tmp_export_test059;
>>export backup to location 'hdfs://localhost:36000/user/trafodion/schgsexport', tag 'test059tag3';

--- SQL operation complete.
>>get progress status of current export;


EXPORT Progress Status for tag "test059tag3"
============================================


Step               State        ET        Progress
======             =======      ====      ==========

Initialize         Completed    00:00:00  100%
ExportObjects      Completed    00:02:09  100%(32/32)
Finalize           Completed    00:00:00  100%


EXPORT End Status for tag "test059tag3"
=======================================

StartTime: 2019-11-07 00:43:01 (local time)
EndTime:   2019-11-07 00:45:11 (local time)
ET:        00:02:10 (hh:mm:ss)


--- SQL operation complete.
>>
>>drop table test059t1 cascade;

--- SQL operation complete.
>>drop backup tag, tag 'test059tag3';

--- SQL operation complete.
>>
>>sh echo "import backup from location '$HDFS_URL/user/trafodion/schgsexport', tag 'test059tag3', override;" > tmp_export_test059;
>>obey tmp_export_test059;
>>import backup from location 'hdfs://localhost:36000/user/trafodion/schgsexport', tag 'test059tag3', override;

--- SQL operation complete.
>>get progress status for current import;


IMPORT Progress Status for tag "test059tag3"
============================================


Step               State        ET        Progress
======             =======      ====      ==========

Initialize         Completed    00:00:00  100%
ImportObjects      Completed    00:02:11  100%(32/32)
Finalize           Completed    00:00:00  100%


IMPORT End Status for tag "test059tag3"
=======================================

StartTime: 2019-11-07 00:48:08 (local time)
EndTime:   2019-11-07 00:50:20 (local time)
ET:        00:02:11 (hh:mm:ss)


--- SQL operation complete.
>>
>>restore trafodion, tag 'test059tag3';

--- SQL operation complete.
>>get progress status for current restore;


RESTORE Progress Status for tag "test059tag3"
=============================================


Step               State        ET        Progress
======             =======      ====      ==========

Initialize         Completed    00:00:00  100%
CreateMetadata     Completed    00:01:37  100%(22/22)
RestoreObjects     Completed    00:00:50  100%(32/32)
Finalize           Completed    00:00:03  100%


RESTORE End Status for tag "test059tag3"
========================================

StartTime: 2019-11-07 00:50:21 (local time)
EndTime:   2019-11-07 00:52:52 (local time)
ET:        00:02:30 (hh:mm:ss)


--- SQL operation complete.
>>
>>select * from test059t1;

A            B          
-----------  -----------

        100          200

--- 1 row(s) selected.
>>
>>get progress status for last backup;


BACKUP Progress Status for tag "test059tag3"
============================================


Step               State        ET        Progress
======             =======      ====      ==========

Initialize         Completed    00:00:00  100%
CreateMetadata     Completed    00:01:36  100%(22/22)
SetupMetadata      Completed    00:00:21  100%(4/4)
BackupObjects      Completed    00:00:07  100%(32/32)
Finalize           Completed    00:00:01  100%


BACKUP End Status for tag "test059tag3"
=======================================

StartTime: 2019-11-07 00:40:52 (local time)
EndTime:   2019-11-07 00:43:00 (local time)
ET:        00:02:07 (hh:mm:ss)


--- SQL operation complete.
>>get progress status for last restore;


RESTORE Progress Status for tag "test059tag3"
=============================================


Step               State        ET        Progress
======             =======      ====      ==========

Initialize         Completed    00:00:00  100%
CreateMetadata     Completed    00:01:37  100%(22/22)
RestoreObjects     Completed    00:00:50  100%(32/32)
Finalize           Completed    00:00:03  100%


RESTORE End Status for tag "test059tag3"
========================================

StartTime: 2019-11-07 00:50:21 (local time)
EndTime:   2019-11-07 00:52:52 (local time)
ET:        00:02:30 (hh:mm:ss)


--- SQL operation complete.
>>get progress status of last export;


EXPORT Progress Status for tag "test059tag3"
============================================


Step               State        ET        Progress
======             =======      ====      ==========

Initialize         Completed    00:00:00  100%
ExportObjects      Completed    00:02:09  100%(32/32)
Finalize           Completed    00:00:00  100%


EXPORT End Status for tag "test059tag3"
=======================================

StartTime: 2019-11-07 00:43:01 (local time)
EndTime:   2019-11-07 00:45:11 (local time)
ET:        00:02:10 (hh:mm:ss)


--- SQL operation complete.
>>get progress status of last import;


IMPORT Progress Status for tag "test059tag3"
============================================


Step               State        ET        Progress
======             =======      ====      ==========

Initialize         Completed    00:00:00  100%
ImportObjects      Completed    00:02:11  100%(32/32)
Finalize           Completed    00:00:00  100%


IMPORT End Status for tag "test059tag3"
=======================================

StartTime: 2019-11-07 00:48:08 (local time)
EndTime:   2019-11-07 00:50:20 (local time)
ET:        00:02:11 (hh:mm:ss)


--- SQL operation complete.
>>
>>-- end state
>>get all backup snapshots, match 'test059%';

BackupTag     BackupTime           BackupStatus  BackupOperation        BackupOwner
=====================================================================================

test059tag3   2019-11-07:01:42:58  VALID         REGULAR(IMPORTED)      DB__ROOT

--- SQL operation complete.
>>get all backup tags, show details, match 'test059%';

BackupTag     BackupTime           BackupStatus  BackupOperation        BackupOwner
=====================================================================================

test059incr1                       NO_SNAPSHOT   UNKNOWN                Not Available
test059incr2                       NO_SNAPSHOT   UNKNOWN                Not Available
test059tag3   2019-11-07:01:50:21  NO_METADATA   REGULAR(IMPORTED)      DB__ROOT

--- SQL operation complete.
>>drop all backup snapshots, match 'test059%';

--- SQL operation complete.
>>get all backup tags, show details, match 'test059%';

BackupTag     BackupTime           BackupStatus  BackupOperation        BackupOwner
=====================================================================================

test059incr2                       NO_SNAPSHOT   UNKNOWN                Not Available
test059tag3                        NO_SNAPSHOT   UNKNOWN                Not Available
test059incr1                       NO_SNAPSHOT   UNKNOWN                Not Available

--- SQL operation complete.
>>get all backup metadata, match 'test059%';

Metadata(OBSOLETE  ): _BACKUP_test059incr1_
Metadata(OBSOLETE  ): _BACKUP_test059incr2_
Metadata(OBSOLETE  ): _BACKUP_test059tag3_

--- SQL operation complete.
>>
>>log;
