-- Test: TEST202 (Row-level lock)
-- @@@ START COPYRIGHT @@@
--
-- Licensed to the Apache Software Foundation (ASF) under one
-- or more contributor license agreements.  See the NOTICE file
-- distributed with this work for additional information
-- regarding copyright ownership.  The ASF licenses this file
-- to you under the Apache License, Version 2.0 (the
-- "License"); you may not use this file except in compliance
-- with the License.  You may obtain a copy of the License at
--
--   http://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing,
-- software distributed under the License is distributed on an
-- "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
-- KIND, either express or implied.  See the License for the
-- specific language governing permissions and limitations
-- under the License.
--
-- @@@ END COPYRIGHT @@@

obey TEST202(clean);
log LOG202 clear;
obey TEST202(setup);
obey TEST202(M11994);
obey TEST202(M12012);
obey TEST202(M12769);
obey TEST202(M13320);
log;
obey TEST202(clean);
exit;

?section setup
create schema locktest202;
set schema locktest202;

?section M11994
-- Mantis 11994
create table table_pk(a int not null primary key);
create table table_fk(a int, b int, foreign key(a) references table_pk(a));
insert into table_pk values(1);
begin work;
insert into table_fk values(1,1);
sh sqlci -i TEST202\(M11994_1\) >> LOG202;
commit;
select * from table_fk;

?section M11994_1
set schema locktest202;
begin work;
insert into table_fk values(1,1);
commit;

?section M12012
CREATE TABLE dept_fk (deptno DECIMAL(2) not null primary key, dname VARCHAR(14),loc VARCHAR(13));
INSERT INTO dept_fk VALUES(10, 'ACCOUNTING', 'NEW YORK');
INSERT INTO dept_fk VALUES(20, 'RESEARCH', 'DALLAS');
create table emp_fk(employeeno DECIMAL(4), ename VARCHAR(10), deptno DECIMAL(2) references dept_fk(deptno));
INSERT INTO emp_fk VALUES(7369, 'SMITH', 20);

begin work;
insert into emp_fk values(7370, 'TOM', 10);
sh sqlci -i TEST202\(M12012_1\) >> LOG202;
rollback;

begin work;
delete from dept_fk where deptno = 10;
sh sqlci -i TEST202\(M12012_2\) >> LOG202;
rollback;

?section M12012_1
set schema locktest202;
delete from dept_fk where deptno = 10;

?section M12012_2
set schema locktest202;
insert into emp_fk values(7370, 'TOM', 10);

?section M12769
set schema locktest202;
CREATE TABLE employee(employeeno DECIMAL(4) NOT NULL primary key, ename VARCHAR(10), job VARCHAR(9), mgr DECIMAL(4), hiredate DATE, sal DECIMAL(7, 2), comm DECIMAL(7, 2), deptno DECIMAL(2))
hbase_options
(
  data_block_encoding = 'fast_diff',
  compression = 'snappy',
  memstore_flush_size = '1073741824'
);
INSERT INTO employee VALUES(7369, 'SMITH', 'CLERK', 7902, DATE '1980-12-17', 800, NULL, 20);
INSERT INTO employee VALUES(7499, 'ALLEN', 'SALESMAN', 7698, DATE '1981-02-20', 1600, 300, 30);
INSERT INTO employee VALUES(7521, 'WARD', 'SALESMAN', 7698, DATE '1981-02-22', 1250, 500, 30);
INSERT INTO employee VALUES(7566, 'JONES', 'MANAGER', 7839, DATE '1981-04-02', 2975, NULL, 20);
INSERT INTO employee VALUES(7654, 'MARTIN', 'SALESMAN', 7698, DATE '1981-09-28', 1250, 1400, 30);
INSERT INTO employee VALUES(7698, 'BLAKE', 'MANAGER', 7839, DATE '1981-05-01', 2850, NULL, 30);
INSERT INTO employee VALUES(7782, 'CLARK', 'MANAGER', 7839, DATE '1981-07-09', 2450, NULL, 10);
INSERT INTO employee VALUES(7788, 'TAC-MD', 'ANALYST', 7566, DATE '1982-12-09', 3000, NULL, 20);
INSERT INTO employee VALUES(7839, 'KING', 'PRESIDENT', 7788, DATE '1981-11-17', 5000, NULL, 10);
INSERT INTO employee VALUES(7844, 'TURNER', 'SALESMAN', 7698, DATE '1981-09-08', 1500, 0, 30);
INSERT INTO employee VALUES(7876, 'ADAMS', 'CLERK', 7788, DATE '1983-01-12', 1100, NULL, 20);
INSERT INTO employee VALUES(7900, 'JAMES', 'CLERK', 7698, DATE '1981-12-03', 950, NULL, 30);
INSERT INTO employee VALUES(7902, 'FORD', 'ANALYST', 7566, DATE '1981-12-03', 3000, NULL, 20);
INSERT INTO employee VALUES(7934, 'MILLER', 'CLERK', 7782, DATE '1982-01-23', 1300, NULL, 10);

create index employee_index on employee(employeeno);

CREATE TABLE dept(deptno DECIMAL(2) not null primary key, dname VARCHAR(14),loc VARCHAR(13));
INSERT INTO dept VALUES(10, 'ACCOUNTING', 'NEW YORK');
INSERT INTO dept VALUES(20, 'RESEARCH', 'DALLAS');
INSERT INTO dept VALUES(30, 'SALES', 'CHICAGO');
INSERT INTO dept VALUES(40, 'OPERATIONS', 'BOSTON');

bt;
alter table employee add constraint lock_pk foreign key(deptno) references dept(deptno);
sh sqlci -i TEST202\(M12769_2\) >> LOG202;
commit;
select deptno from employee where deptno = 50;
select * from employee where deptno = 50;
select deptno from dept;

?section M12769_2
set schema locktest202;
begin work;
update employee set deptno = 50 where deptno = 10;
commit;

?section M13320
set schema locktest202;
create table t202_dept(deptno DECIMAL(2) not null primary key, dname VARCHAR(14) ,loc VARCHAR(13));
alter table t202_dept drop column loc;

?section clean
drop schema locktest202 cascade;
