>>obey TEST139(set_up);
>>set schema "_PRIVMGR_MD_";

--- SQL operation complete.
>>prepare get_owner_privs from
+>select distinct
+>   substring (object_name,1,10) as object_name,
+>   object_type as type,
+>   substring(authname(grantee_id),1,10) as grantee,
+>   privileges_bitmap,
+>   grantable_bitmap
+>from object_privileges 
+>where grantor_id = -2
+>    and object_uid in 
+>     (select object_uid
+>      from "_MD_".objects
+>      where object_type in ('VI','BT','LB','UR')
+>        and schema_name in ('_PRIVMGR_MD_', 'T139SCH'))
+>  order by 1, 2
+>;

--- SQL command prepared.
>>
>>prepare object_privs from
+>select distinct
+>  object_type as type,
+>  substring (grantor_name,1,10) as grantor,
+>  substring (grantee_name,1,10) as grantee,
+>  case when bitextract(privileges_bitmap,63,1) = 1 then 'S'
+>       else '-' end ||
+>  case when bitextract(privileges_bitmap,62,1) = 1 then 'I'
+>        else '-' end ||
+>  case when bitextract(privileges_bitmap,61,1) = 1 then 'D'
+>        else '-' end ||
+>  case when bitextract(privileges_bitmap,60,1) = 1 then 'U'
+>        else '-' end ||
+>  case when bitextract(privileges_bitmap,59,1) = 1 then 'G'
+>        else '-' end ||
+>  case when bitextract(privileges_bitmap,58,1) = 1 then 'R'
+>        else '-' end ||
+>  case when bitextract(privileges_bitmap,57,1) = 1 then 'E'
+>        else '-' end as privs
+>from "_PRIVMGR_MD_".object_privileges
+>where object_name like ?tblname
+>order by 1, 2, 3;

--- SQL command prepared.
>>
>>prepare all_privs from
+>select distinct
+>  object_type as type,
+>  substring (object_name,1,20) as objname,
+>  substring (grantor_name,1,10) as grantor,
+>  substring (grantee_name,1,10) as grantee,
+>  privileges_bitmap as privs,
+>  grantable_bitmap as wgo
+>from "_PRIVMGR_MD_".object_privileges
+>where object_uid in
+>   (select object_uid from "_MD_".objects
+>    where schema_name in ('T139SCH'))
+>ORDER BY 1, 2,3,4;

--- SQL command prepared.
>>
>>
>>obey TEST139(create_db);
>>create shared schema t139sch;

--- SQL operation complete.
>>set schema t139sch;

--- SQL operation complete.
>>create table teams
+>  (team_number int not null primary key,
+>   team_name char(20) not null,
+>   team_contact varchar(50) not null,
+>   team_contact_number char (10) not null
+>   )
+>  ;

--- SQL operation complete.
>>
>>alter table teams add constraint valid_team_no check (team_number > 0);

--- SQL operation complete.
>>
>>insert into teams values
+>   (1, 'White Socks', 'Sam','4082282222'),
+>   (2, 'Giants', 'Joe', '5102839483'),
+>   (3, 'Cardinals', 'Stella', '9513849384'),
+>   (4, 'Indians', 'Matt', '5128383748'),
+>   (5, 'Tigers', 'Ronit', '6198273827');

--- 5 row(s) inserted.
>>
>>create table games
+>   ( home_team_number int not null,
+>     visitor_team_number int not null,
+>     game_number int not null primary key,
+>     game_time timestamp not null,
+>     game_location varchar(50) not null)
+>  ;

--- SQL operation complete.
>>
>>alter table games add constraint valid_game_number check (game_number > 0);

--- SQL operation complete.
>>
>>insert into games values
+>   (1, 2, 1, timestamp '2009-04-23 19:30:00', 'California'),
+>   (1, 3, 2, timestamp '2009-04-24 19:30:00', 'California'),
+>   (1, 4, 3, timestamp '2009-04-25 10:00:00', 'Oklahoma'),
+>   (2, 3, 4, timestamp '2009-04-25 13:30:00', 'Michigan'),
+>   (1, 5, 5, timestamp '2009-04-25 15:00:00', 'Oklahoma'),
+>   (2, 5, 6, timestamp '2009-04-27 17:00:00', 'New York'),
+>   (3, 4, 7, timestamp '2009-04-28 17:00:00', 'Florida'),
+>   (4, 2, 8, current_timestamp, 'Missouri');

--- 8 row(s) inserted.
>>
>>obey TEST139(tests);
>>-- =================================================================
>>-- this set of tests run basic grant and revoke tests
>>-- =================================================================
>>set schema t139sch;

--- SQL operation complete.
>>
>>grant component privilege DML_SELECT_METADATA on sql_operations to sql_user1;

--- SQL operation complete.
>>
>>set param ?tblname '%GAMES';
>>
>>-- test SELECT, UPDATE, DELETE, INSERT on games
>>grant select on games to sql_user1;

--- SQL operation complete.
>>showddl games;

CREATE TABLE TRAFODION.T139SCH.GAMES
  (
    HOME_TEAM_NUMBER                 INT NO DEFAULT NOT NULL NOT DROPPABLE
  , VISITOR_TEAM_NUMBER              INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_NUMBER                      INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_TIME                        TIMESTAMP(6) NO DEFAULT NOT NULL NOT
      DROPPABLE
  , GAME_LOCATION                    VARCHAR(50) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (GAME_NUMBER ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

ALTER TABLE TRAFODION.T139SCH.GAMES ADD CONSTRAINT
  TRAFODION.T139SCH.VALID_GAME_NUMBER CHECK
  (TRAFODION.T139SCH.GAMES.GAME_NUMBER > 0)
;

-- GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES, ALTER, DROP ON TRAFODION.T139SCH.GAMES TO DB__ROOT WITH GRANT OPTION;
  GRANT SELECT ON TRAFODION.T139SCH.GAMES TO SQL_USER1;

--- SQL operation complete.
>>-- make sure user1 can select but not other operations
>>changeuser sql_user1;
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>obey TEST139(user1_dml);
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER1                                                                                                                       

--- 1 row(s) selected.
>>set schema t139sch;

--- SQL operation complete.
>>select count(*) from games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>update games set game_location = 'Ohio' where game_location = 'New York';

*** ERROR[4481] The user does not have UPDATE privilege on table or view TRAFODION.T139SCH.GAMES.

*** ERROR[8822] The statement was not prepared.

>>update games set game_location = 'New York' where game_location = 'Ohio';

*** ERROR[4481] The user does not have UPDATE privilege on table or view TRAFODION.T139SCH.GAMES.

*** ERROR[8822] The statement was not prepared.

>>insert into games values (4, 5, 9, current_timestamp, 'Ohio');

*** ERROR[4481] The user does not have INSERT privilege on table or view TRAFODION.T139SCH.GAMES.

*** ERROR[8822] The statement was not prepared.

>>select count(*) from games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>delete from games where game_number = 9;

*** ERROR[4481] The user does not have DELETE privilege on table or view TRAFODION.T139SCH.GAMES.

*** ERROR[8822] The statement was not prepared.

>>select count(*) from games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>
>>
>>changeuser db__root;
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>set schema t139sch;

--- SQL operation complete.
>>grant update on games to sql_user1;

--- SQL operation complete.
>>showddl games;

CREATE TABLE TRAFODION.T139SCH.GAMES
  (
    HOME_TEAM_NUMBER                 INT NO DEFAULT NOT NULL NOT DROPPABLE
  , VISITOR_TEAM_NUMBER              INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_NUMBER                      INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_TIME                        TIMESTAMP(6) NO DEFAULT NOT NULL NOT
      DROPPABLE
  , GAME_LOCATION                    VARCHAR(50) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (GAME_NUMBER ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

ALTER TABLE TRAFODION.T139SCH.GAMES ADD CONSTRAINT
  TRAFODION.T139SCH.VALID_GAME_NUMBER CHECK
  (TRAFODION.T139SCH.GAMES.GAME_NUMBER > 0)
;

-- GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES, ALTER, DROP ON TRAFODION.T139SCH.GAMES TO DB__ROOT WITH GRANT OPTION;
  GRANT SELECT, UPDATE ON TRAFODION.T139SCH.GAMES TO SQL_USER1;

--- SQL operation complete.
>>
>>-- make sure user 1 can select and update but not other operations
>>changeuser sql_user1;
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>obey TEST139(user1_dml);
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER1                                                                                                                       

--- 1 row(s) selected.
>>set schema t139sch;

--- SQL operation complete.
>>select count(*) from games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>update games set game_location = 'Ohio' where game_location = 'New York';

--- 1 row(s) updated.
>>update games set game_location = 'New York' where game_location = 'Ohio';

--- 1 row(s) updated.
>>insert into games values (4, 5, 9, current_timestamp, 'Ohio');

*** ERROR[4481] The user does not have INSERT privilege on table or view TRAFODION.T139SCH.GAMES.

*** ERROR[8822] The statement was not prepared.

>>select count(*) from games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>delete from games where game_number = 9;

*** ERROR[4481] The user does not have DELETE privilege on table or view TRAFODION.T139SCH.GAMES.

*** ERROR[8822] The statement was not prepared.

>>select count(*) from games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>
>>
>>changeuser db__root;
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>set schema t139sch;

--- SQL operation complete.
>>grant delete, insert, references on games to sql_user1;

--- SQL operation complete.
>>showddl games;

CREATE TABLE TRAFODION.T139SCH.GAMES
  (
    HOME_TEAM_NUMBER                 INT NO DEFAULT NOT NULL NOT DROPPABLE
  , VISITOR_TEAM_NUMBER              INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_NUMBER                      INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_TIME                        TIMESTAMP(6) NO DEFAULT NOT NULL NOT
      DROPPABLE
  , GAME_LOCATION                    VARCHAR(50) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (GAME_NUMBER ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

ALTER TABLE TRAFODION.T139SCH.GAMES ADD CONSTRAINT
  TRAFODION.T139SCH.VALID_GAME_NUMBER CHECK
  (TRAFODION.T139SCH.GAMES.GAME_NUMBER > 0)
;

-- GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES, ALTER, DROP ON TRAFODION.T139SCH.GAMES TO DB__ROOT WITH GRANT OPTION;
  GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES ON TRAFODION.T139SCH.GAMES
  TO SQL_USER1;

--- SQL operation complete.
>>
>>-- make sure user1 can do all dml
>>changeuser sql_user1;
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>obey TEST139(user1_dml);
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER1                                                                                                                       

--- 1 row(s) selected.
>>set schema t139sch;

--- SQL operation complete.
>>select count(*) from games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>update games set game_location = 'Ohio' where game_location = 'New York';

--- 1 row(s) updated.
>>update games set game_location = 'New York' where game_location = 'Ohio';

--- 1 row(s) updated.
>>insert into games values (4, 5, 9, current_timestamp, 'Ohio');

--- 1 row(s) inserted.
>>select count(*) from games;

(EXPR)              
--------------------

                   9

--- 1 row(s) selected.
>>delete from games where game_number = 9;

--- 1 row(s) deleted.
>>select count(*) from games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>
>>
>>changeuser db__root;
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>set schema t139sch;

--- SQL operation complete.
>>
>>-- verify that caches are cleared instead of reset when default
>>-- TRAF_CLEAR_METADATA_CACHE is ON
>>-- By default, it should be OFF
>>insert into "_MD_".defaults values ('TRAF_CLEAR_METADATA_CACHE', 'ON', 'privs2, test139', 0);

--- 1 row(s) inserted.
>>sh sqlci -i "TEST139(caching)" -u sql_user1;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER1                                                                                                                       

--- 1 row(s) selected.
>>set schema t139sch;

--- SQL operation complete.
>>
>>select count(*) from games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>select num_entries from table (natablecache('user', 'local'));

NUM_ENTRIES
-----------

          2

--- 1 row(s) selected.
>>
>>changeuser sql_user2;
>>select num_entries from table (natablecache('user', 'local'));

NUM_ENTRIES
-----------

          0

--- 1 row(s) selected.
>>exit;

End of MXCI Session

>>update "_MD_".defaults set attr_value = 'OFF' where attribute = 'TRAF_CLEAR_METADATA_CACHE';

--- 1 row(s) updated.
>>sh sqlci -i "TEST139(caching)" -u sql_user1;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER1                                                                                                                       

--- 1 row(s) selected.
>>set schema t139sch;

--- SQL operation complete.
>>
>>select count(*) from games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>select num_entries from table (natablecache('user', 'local'));

NUM_ENTRIES
-----------

          3

--- 1 row(s) selected.
>>
>>changeuser sql_user2;
>>select num_entries from table (natablecache('user', 'local'));

NUM_ENTRIES
-----------

          3

--- 1 row(s) selected.
>>exit;

End of MXCI Session

>>delete from "_MD_".defaults where attribute = 'TRAF_CLEAR_METADATA_CACHE';

--- 1 row(s) deleted.
>>
>>execute object_privs;

TYPE  GRANTOR                                   GRANTEE                                   PRIVS
----  ----------------------------------------  ----------------------------------------  -------

BT    DB__ROOT                                  SQL_USER1                                 SIDU-R-
BT    _SYSTEM                                   DB__ROOT                                  SIDU-R-

--- 2 row(s) selected.
>>
>>-- test revoke SELECT, UPDATE, DELETE, INSERT, REFERENCES 
>>
>>revoke update on games from sql_user1;

--- SQL operation complete.
>>showddl games;

CREATE TABLE TRAFODION.T139SCH.GAMES
  (
    HOME_TEAM_NUMBER                 INT NO DEFAULT NOT NULL NOT DROPPABLE
  , VISITOR_TEAM_NUMBER              INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_NUMBER                      INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_TIME                        TIMESTAMP(6) NO DEFAULT NOT NULL NOT
      DROPPABLE
  , GAME_LOCATION                    VARCHAR(50) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (GAME_NUMBER ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

ALTER TABLE TRAFODION.T139SCH.GAMES ADD CONSTRAINT
  TRAFODION.T139SCH.VALID_GAME_NUMBER CHECK
  (TRAFODION.T139SCH.GAMES.GAME_NUMBER > 0)
;

-- GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES, ALTER, DROP ON TRAFODION.T139SCH.GAMES TO DB__ROOT WITH GRANT OPTION;
  GRANT SELECT, INSERT, DELETE, REFERENCES ON TRAFODION.T139SCH.GAMES TO
  SQL_USER1;

--- SQL operation complete.
>>revoke all_dml on games from sql_user2;

*** WARNING[1018] Grant of role or privilege ALL_DML from DB__ROOT to SQL_USER2 not found, revoke request ignored.

--- SQL operation complete.
>>showddl games;

CREATE TABLE TRAFODION.T139SCH.GAMES
  (
    HOME_TEAM_NUMBER                 INT NO DEFAULT NOT NULL NOT DROPPABLE
  , VISITOR_TEAM_NUMBER              INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_NUMBER                      INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_TIME                        TIMESTAMP(6) NO DEFAULT NOT NULL NOT
      DROPPABLE
  , GAME_LOCATION                    VARCHAR(50) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (GAME_NUMBER ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

ALTER TABLE TRAFODION.T139SCH.GAMES ADD CONSTRAINT
  TRAFODION.T139SCH.VALID_GAME_NUMBER CHECK
  (TRAFODION.T139SCH.GAMES.GAME_NUMBER > 0)
;

-- GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES, ALTER, DROP ON TRAFODION.T139SCH.GAMES TO DB__ROOT WITH GRANT OPTION;
  GRANT SELECT, INSERT, DELETE, REFERENCES ON TRAFODION.T139SCH.GAMES TO
  SQL_USER1;

--- SQL operation complete.
>>revoke all_dml on teams from sql_user3;

*** WARNING[1018] Grant of role or privilege ALL_DML from DB__ROOT to SQL_USER3 not found, revoke request ignored.

--- SQL operation complete.
>>showddl teams;

CREATE TABLE TRAFODION.T139SCH.TEAMS
  (
    TEAM_NUMBER                      INT NO DEFAULT NOT NULL NOT DROPPABLE
  , TEAM_NAME                        CHAR(20) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , TEAM_CONTACT                     VARCHAR(50) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , TEAM_CONTACT_NUMBER              CHAR(10) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (TEAM_NUMBER ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

ALTER TABLE TRAFODION.T139SCH.TEAMS ADD CONSTRAINT
  TRAFODION.T139SCH.VALID_TEAM_NO CHECK (TRAFODION.T139SCH.TEAMS.TEAM_NUMBER >
  0)
;

-- GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES, ALTER, DROP ON TRAFODION.T139SCH.TEAMS TO DB__ROOT WITH GRANT OPTION;

--- SQL operation complete.
>>
>>-- test for JIRA 2177
>>create role t139_role1;

--- SQL operation complete.
>>grant role t139_role1 to sql_user1 with admin option;

--- SQL operation complete.
>>grant insert(team_contact,team_contact_number), select on teams to t139_role1;

--- SQL operation complete.
>>showddl teams;

CREATE TABLE TRAFODION.T139SCH.TEAMS
  (
    TEAM_NUMBER                      INT NO DEFAULT NOT NULL NOT DROPPABLE
  , TEAM_NAME                        CHAR(20) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , TEAM_CONTACT                     VARCHAR(50) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , TEAM_CONTACT_NUMBER              CHAR(10) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (TEAM_NUMBER ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

ALTER TABLE TRAFODION.T139SCH.TEAMS ADD CONSTRAINT
  TRAFODION.T139SCH.VALID_TEAM_NO CHECK (TRAFODION.T139SCH.TEAMS.TEAM_NUMBER >
  0)
;

-- GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES, ALTER, DROP ON TRAFODION.T139SCH.TEAMS TO DB__ROOT WITH GRANT OPTION;
  GRANT SELECT ON TRAFODION.T139SCH.TEAMS TO T139_ROLE1;
GRANT
  INSERT(TEAM_CONTACT, TEAM_CONTACT_NUMBER) ON TRAFODION.T139SCH.TEAMS TO
  T139_ROLE1;

--- SQL operation complete.
>>revoke insert(team_contact,team_contact_number), select on teams from t139_role1;

--- SQL operation complete.
>>showddl teams;

CREATE TABLE TRAFODION.T139SCH.TEAMS
  (
    TEAM_NUMBER                      INT NO DEFAULT NOT NULL NOT DROPPABLE
  , TEAM_NAME                        CHAR(20) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , TEAM_CONTACT                     VARCHAR(50) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , TEAM_CONTACT_NUMBER              CHAR(10) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (TEAM_NUMBER ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

ALTER TABLE TRAFODION.T139SCH.TEAMS ADD CONSTRAINT
  TRAFODION.T139SCH.VALID_TEAM_NO CHECK (TRAFODION.T139SCH.TEAMS.TEAM_NUMBER >
  0)
;

-- GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES, ALTER, DROP ON TRAFODION.T139SCH.TEAMS TO DB__ROOT WITH GRANT OPTION;

--- SQL operation complete.
>>
>>-- test for JIRA 2196/2197
>>grant select,insert ,delete, update ,references(game_time) on games to sql_user1 with grant option;

--- SQL operation complete.
>>showddl games;

CREATE TABLE TRAFODION.T139SCH.GAMES
  (
    HOME_TEAM_NUMBER                 INT NO DEFAULT NOT NULL NOT DROPPABLE
  , VISITOR_TEAM_NUMBER              INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_NUMBER                      INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_TIME                        TIMESTAMP(6) NO DEFAULT NOT NULL NOT
      DROPPABLE
  , GAME_LOCATION                    VARCHAR(50) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (GAME_NUMBER ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

ALTER TABLE TRAFODION.T139SCH.GAMES ADD CONSTRAINT
  TRAFODION.T139SCH.VALID_GAME_NUMBER CHECK
  (TRAFODION.T139SCH.GAMES.GAME_NUMBER > 0)
;

-- GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES, ALTER, DROP ON TRAFODION.T139SCH.GAMES TO DB__ROOT WITH GRANT OPTION;
  GRANT REFERENCES ON TRAFODION.T139SCH.GAMES TO SQL_USER1;
GRANT SELECT,
  INSERT, DELETE, UPDATE ON TRAFODION.T139SCH.GAMES TO SQL_USER1 WITH GRANT
  OPTION;
GRANT REFERENCES(GAME_TIME) ON TRAFODION.T139SCH.GAMES TO SQL_USER1
  WITH GRANT OPTION;

--- SQL operation complete.
>>
>>-- user1 grants/revokes should succeed
>>changeuser sql_user1;
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>obey TEST139(user1_grants);
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER1                                                                                                                       

--- 1 row(s) selected.
>>set schema t139sch;

--- SQL operation complete.
>>grant select(home_team_number,game_time),
+>      insert(home_team_number),
+>      update(visitor_team_number,game_time),
+>      references(game_time) 
+>on games to t139_role1;

--- SQL operation complete.
>>showddl games;

CREATE TABLE TRAFODION.T139SCH.GAMES
  (
    HOME_TEAM_NUMBER                 INT NO DEFAULT NOT NULL NOT DROPPABLE
  , VISITOR_TEAM_NUMBER              INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_NUMBER                      INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_TIME                        TIMESTAMP(6) NO DEFAULT NOT NULL NOT
      DROPPABLE
  , GAME_LOCATION                    VARCHAR(50) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (GAME_NUMBER ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

ALTER TABLE TRAFODION.T139SCH.GAMES ADD CONSTRAINT
  TRAFODION.T139SCH.VALID_GAME_NUMBER CHECK
  (TRAFODION.T139SCH.GAMES.GAME_NUMBER > 0)
;

-- GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES, ALTER, DROP ON TRAFODION.T139SCH.GAMES TO DB__ROOT WITH GRANT OPTION;
  GRANT REFERENCES ON TRAFODION.T139SCH.GAMES TO SQL_USER1;
GRANT SELECT,
  INSERT, DELETE, UPDATE ON TRAFODION.T139SCH.GAMES TO SQL_USER1 WITH GRANT
  OPTION;
GRANT REFERENCES(GAME_TIME) ON TRAFODION.T139SCH.GAMES TO SQL_USER1
  WITH GRANT OPTION;
GRANT SELECT(HOME_TEAM_NUMBER, GAME_TIME),
  INSERT(HOME_TEAM_NUMBER), UPDATE(VISITOR_TEAM_NUMBER, GAME_TIME),
  REFERENCES(GAME_TIME) ON TRAFODION.T139SCH.GAMES TO T139_ROLE1 GRANTED BY
  SQL_USER1;

--- SQL operation complete.
>>revoke select(home_team_number,game_time),
+>      insert(home_team_number),
+>      update(visitor_team_number,game_time),
+>      references(game_time)
+>on games from t139_role1;

--- SQL operation complete.
>>
>>
>>changeuser db__root;
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>set schema t139sch;

--- SQL operation complete.
>>revoke select,insert ,delete, update ,references(game_time) on games 
+>   from sql_user1;

--- SQL operation complete.
>>revoke role t139_role1 from sql_user1;

--- SQL operation complete.
>>drop role t139_role1;

--- SQL operation complete.
>>
>>-- sh sqlci -i "TEST139(authorized)" -u sql_user4;
>>log;
