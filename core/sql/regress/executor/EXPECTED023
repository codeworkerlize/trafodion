>>obey TEST023 (test);
>>-------------------------------------------------------------------------------
>>create table t023t1 (a int not null primary key, b int not null);

--- SQL operation complete.
>>create table t023t2 (a int not null primary key, b int not null);

--- SQL operation complete.
>>create index t023t2i1 on t023t2(b);

--- SQL operation complete.
>>create table t023t3 (a int not null primary key, b int not null)
+>  salt using 4 partitions;

--- SQL operation complete.
>>create table t023t4 (c1 int not null primary key, c2 char(10), c3 int);

--- SQL operation complete.
>>
>>-- tests savepoint settings
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>
>>showtransaction;
ISOLATION LEVEL      : READ COMMITTED
ACCESS MODE          : READ WRITE
AUTOCOMMIT           : ON
NO ROLLBACK          : NOT SPECIFIED
DIAGNOSTICS SIZE     : -1
AUTOABORT            : -1 SECONDS
MULTI COMMIT         : NOT SPECIFIED
AUTOBEGIN            : NOT SPECIFIED
AUTOCOMMIT SAVEPOINT : ON

--- SQL operation complete.
>>set transaction autocommit savepoint on;

--- SQL operation complete.
>>showtransaction;
ISOLATION LEVEL      : READ COMMITTED
ACCESS MODE          : READ WRITE
AUTOCOMMIT           : ON
NO ROLLBACK          : OFF
DIAGNOSTICS SIZE     : -1
AUTOABORT            : -1 SECONDS
MULTI COMMIT         : NOT SPECIFIED
AUTOBEGIN            : NOT SPECIFIED
AUTOCOMMIT SAVEPOINT : ON

--- SQL operation complete.
>>begin work;

--- SQL operation complete.
>>showtransaction;
ISOLATION LEVEL      : READ COMMITTED
ACCESS MODE          : READ WRITE
AUTOCOMMIT           : ON
NO ROLLBACK          : OFF
DIAGNOSTICS SIZE     : -1
AUTOABORT            : -1 SECONDS
MULTI COMMIT         : NOT SPECIFIED
AUTOBEGIN            : NOT SPECIFIED
AUTOCOMMIT SAVEPOINT : ON

--- SQL operation complete.
>>begin savepoint;

--- SQL operation complete.
>>showtransaction;
ISOLATION LEVEL      : READ COMMITTED
ACCESS MODE          : READ WRITE
AUTOCOMMIT           : ON
NO ROLLBACK          : OFF
DIAGNOSTICS SIZE     : -1
AUTOABORT            : -1 SECONDS
MULTI COMMIT         : NOT SPECIFIED
AUTOBEGIN            : NOT SPECIFIED
AUTOCOMMIT SAVEPOINT : ON

--- SQL operation complete.
>>commit savepoint;

--- SQL operation complete.
>>showtransaction;
ISOLATION LEVEL      : READ COMMITTED
ACCESS MODE          : READ WRITE
AUTOCOMMIT           : ON
NO ROLLBACK          : OFF
DIAGNOSTICS SIZE     : -1
AUTOABORT            : -1 SECONDS
MULTI COMMIT         : NOT SPECIFIED
AUTOBEGIN            : NOT SPECIFIED
AUTOCOMMIT SAVEPOINT : ON

--- SQL operation complete.
>>commit work;

--- SQL operation complete.
>>showtransaction;
ISOLATION LEVEL      : READ COMMITTED
ACCESS MODE          : READ WRITE
AUTOCOMMIT           : ON
NO ROLLBACK          : OFF
DIAGNOSTICS SIZE     : -1
AUTOABORT            : -1 SECONDS
MULTI COMMIT         : NOT SPECIFIED
AUTOBEGIN            : NOT SPECIFIED
AUTOCOMMIT SAVEPOINT : ON

--- SQL operation complete.
>>set transaction autocommit savepoint off;

--- SQL operation complete.
>>showtransaction;
ISOLATION LEVEL      : READ COMMITTED
ACCESS MODE          : READ WRITE
AUTOCOMMIT           : ON
NO ROLLBACK          : OFF
DIAGNOSTICS SIZE     : -1
AUTOABORT            : -1 SECONDS
MULTI COMMIT         : NOT SPECIFIED
AUTOBEGIN            : NOT SPECIFIED
AUTOCOMMIT SAVEPOINT : OFF

--- SQL operation complete.
>>
>>
>>set transaction autocommit savepoint on;

--- SQL operation complete.
>>begin work;

--- SQL operation complete.
>>explain options 'f' insert into t023t1 values (1,1);

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

1    .    2    root                  o         s                     1.00E+000
.    .    1    trafodion_insert                T023T1                1.00E+000

--- SQL operation complete.
>>explain options 'f' insert into t023t1 values (1,1), (2,2);

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

3    .    4    root                            s                     2.00E+000
1    2    3    tuple_flow                                            2.00E+000
.    .    2    trafodion_insert                T023T1                1.00E+000
.    .    1    tuplelist                                             2.00E+000

--- SQL operation complete.
>>explain options 'f' delete from t023t1;

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

3    .    4    root                            s                     1.00E+002
1    2    3    tuple_flow                                            1.00E+002
.    .    2    trafodion_vsbb_delet            T023T1                1.00E+000
.    .    1    trafodion_scan                  T023T1                1.00E+002

--- SQL operation complete.
>>explain options 'f' delete from t023t1 where a = 1;

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

1    .    2    root                  o         s                     1.00E+000
.    .    1    trafodion_delete                T023T1                1.00E+000

--- SQL operation complete.
>>explain options 'f' update t023t1 set b = b + 1 where a = 1;

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

1    .    2    root                  o         s                     1.00E+000
.    .    1    trafodion_update                T023T1                1.00E+000

--- SQL operation complete.
>>explain options 'f' update t023t1 set b = 10;

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

3    .    4    root                            s                     1.00E+002
1    2    3    tuple_flow                                            1.00E+002
.    .    2    trafodion_update                T023T1                1.00E+000
.    .    1    trafodion_scan                  T023T1                1.00E+002

--- SQL operation complete.
>>
>>prepare s from insert into t023t1 values (1,1), (2,2);

--- SQL command prepared.
>>explain options 'f' s;

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

3    .    4    root                            s                     2.00E+000
1    2    3    tuple_flow                                            2.00E+000
.    .    2    trafodion_insert                T023T1                1.00E+000
.    .    1    tuplelist                                             2.00E+000

--- SQL operation complete.
>>execute s;

--- 2 row(s) inserted.
>>execute s;

*** ERROR[8102] The operation is prevented by a unique constraint.

--- 0 row(s) inserted.
>>
>>commit work;

--- SQL operation complete.
>>select * from t023t1;

A            B          
-----------  -----------

          1            1
          2            2

--- 2 row(s) selected.
>>
>>delete from t023t2;

--- 0 row(s) deleted.
>>begin work;

--- SQL operation complete.
>>explain options 'f' insert into t023t2 values (10, 20);

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

3    .    4    root                  o         s                     1.00E+000
1    2    3    nested_join                                           1.00E+000
.    .    2    trafodion_insert                T023T2I1              1.00E+000
.    .    1    trafodion_insert                T023T2                1.00E+000

--- SQL operation complete.
>>insert into t023t2 values (1,1), (2,2);

--- 2 row(s) inserted.
>>select * from t023t2;

A            B          
-----------  -----------

          1            1
          2            2

--- 2 row(s) selected.
>>insert into t023t2 values (3,3), (3,2);

*** ERROR[8102] The operation is prevented by a unique constraint.

--- 0 row(s) inserted.
>>commit work;

--- SQL operation complete.
>>select * from t023t2;

A            B          
-----------  -----------

          1            1
          2            2

--- 2 row(s) selected.
>>
>>delete from t023t4;

--- 0 row(s) deleted.
>>insert into t023t4 values 
+>(1,'aaa',101), (2,'aaa', 102),(3,'CCC',103),(4,'CCC',103),(5,'CCC',105),
+>(6,'CCC',105), (7,'CCC',105),(8,'CCC',105),(9,'CCC',105);

--- 9 row(s) inserted.
>>
>>select * from t023t4;

C1           C2          C3         
-----------  ----------  -----------

          1  aaa                 101
          2  aaa                 102
          3  CCC                 103
          4  CCC                 103
          5  CCC                 105
          6  CCC                 105
          7  CCC                 105
          8  CCC                 105
          9  CCC                 105

--- 9 row(s) selected.
>>begin work;

--- SQL operation complete.
>>explain options 'f' update t023t4 set c3=104 where c1=4;

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

1    .    2    root                  o         s                     1.00E+000
.    .    1    trafodion_update                T023T4                1.00E+000

--- SQL operation complete.
>>update t023t4 set c3=104 where c1=4;

--- 1 row(s) updated.
>>select * from t023t4;

C1           C2          C3         
-----------  ----------  -----------

          1  aaa                 101
          2  aaa                 102
          3  CCC                 103
          4  CCC                 104
          5  CCC                 105
          6  CCC                 105
          7  CCC                 105
          8  CCC                 105
          9  CCC                 105

--- 9 row(s) selected.
>>explain options 'f' update t023t4 set c1=8 where c1=9;

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

4    .    5    root                            s                     1.00E+000
2    3    4    tuple_flow                                            1.00E+000
.    .    3    trafodion_insert                T023T4                1.00E+000
1    .    2    sort                                                  1.00E+000
.    .    1    trafodion_delete                T023T4                1.00E+000

--- SQL operation complete.
>>update t023t4 set c1=8 where c1=9;

*** ERROR[8102] The operation is prevented by a unique constraint.

--- 0 row(s) updated.
>>commit work;

--- SQL operation complete.
>>select * from t023t4;

C1           C2          C3         
-----------  ----------  -----------

          1  aaa                 101
          2  aaa                 102
          3  CCC                 103
          4  CCC                 104
          5  CCC                 105
          6  CCC                 105
          7  CCC                 105
          8  CCC                 105
          9  CCC                 105

--- 9 row(s) selected.
>>
>>delete from t023t3;

--- 0 row(s) deleted.
>>begin work;

--- SQL operation complete.
>>explain options 'f' insert into t023t3 values (1,1), (2,2);

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

3    .    4    root                            s                     2.00E+000
1    2    3    tuple_flow                                            2.00E+000
.    .    2    trafodion_insert                T023T3                1.00E+000
.    .    1    tuplelist                                             2.00E+000

--- SQL operation complete.
>>insert into t023t3 values (1,1), (2,2);

--- 2 row(s) inserted.
>>select * from t023t3;

A            B          
-----------  -----------

          2            2
          1            1

--- 2 row(s) selected.
>>select * from t023t3;

A            B          
-----------  -----------

          2            2
          1            1

--- 2 row(s) selected.
>>commit work;

--- SQL operation complete.
>>select * from t023t3;

A            B          
-----------  -----------

          2            2
          1            1

--- 2 row(s) selected.
>>
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>delete from t023t3;

--- 2 row(s) deleted.
>>begin work;

--- SQL operation complete.
>>control query shape esp_exchange(cut);

--- SQL operation complete.
>>prepare s from insert into t023t3 values (1,1), (2,2);

--- SQL command prepared.
>>explain options 'f' s;

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

3    .    4    root                            s                     2.00E+000
1    2    3    tuple_flow                                            2.00E+000
.    .    2    trafodion_insert                T023T3                1.00E+000
.    .    1    tuplelist                                             2.00E+000

--- SQL operation complete.
>>execute s;

--- 2 row(s) inserted.
>>commit work;

--- SQL operation complete.
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>control query shape cut;

--- SQL operation complete.
>>
>>-- first insert should succeed. Second insert should return error and do
>>-- savepoint rollback.
>>begin work;

--- SQL operation complete.
>>insert into t023t3 values (10,10), (20,20);

--- 2 row(s) inserted.
>>execute s;

*** ERROR[8102] The operation is prevented by a unique constraint.

--- 0 row(s) inserted.
>>commit work;

--- SQL operation complete.
>>select * from t023t3;

A            B          
-----------  -----------

          2            2
          1            1
         10           10
         20           20

--- 4 row(s) selected.
>>
>>delete from t023t1;

--- 2 row(s) deleted.
>>begin work;

--- SQL operation complete.
>>insert into t023t1 values (1,1), (2,2);

--- 2 row(s) inserted.
>>begin savepoint;

--- SQL operation complete.
>>insert into t023t1 values (3,3), (4,4);

--- 2 row(s) inserted.
>>insert into t023t1 values (5,5), (6,6);

--- 2 row(s) inserted.
>>insert into t023t1 values (4,4), (3,3);

*** ERROR[8102] The operation is prevented by a unique constraint.

--- 0 row(s) inserted.
>>select * from t023t1;

A            B          
-----------  -----------

          1            1
          2            2
          3            3
          4            4
          5            5
          6            6

--- 6 row(s) selected.
>>rollback savepoint;

--- SQL operation complete.
>>select * from t023t1;

A            B          
-----------  -----------

          1            1
          2            2

--- 2 row(s) selected.
>>commit work;

--- SQL operation complete.
>>select * from t023t1;

A            B          
-----------  -----------

          1            1
          2            2

--- 2 row(s) selected.
>>
>>-- savepoint not enabled
>>begin work;

--- SQL operation complete.
>>explain options 'f' create table t023temp(a int);

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

1    .    2    root                                                  1.00E+000
.    .    1    ddl                                                   1.00E+000

--- SQL operation complete.
>>commit work;

--- SQL operation complete.
>>
>>-- savepoint only enabled within a user transaction
>>explain options 'f' insert into t023t1 values (1,1), (2,2);

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

3    .    4    root                            x                     2.00E+000
1    2    3    tuple_flow                                            2.00E+000
.    .    2    trafodion_insert                T023T1                1.00E+000
.    .    1    tuplelist                                             2.00E+000

--- SQL operation complete.
>>begin savepoint;

*** ERROR[8611] Savepoint operations must be done within a user transaction.

--- SQL operation failed with errors.
>>commit savepoint;

*** ERROR[8611] Savepoint operations must be done within a user transaction.

--- SQL operation failed with errors.
>>rollback savepoint;

*** ERROR[8611] Savepoint operations must be done within a user transaction.

--- SQL operation failed with errors.
>>
>>cqd traf_savepoints 'OFF';

--- SQL operation complete.
>>begin savepoint;

*** ERROR[8620] Unable to begin, commit or rollback savepoint.

*** ERROR[8822] The statement was not prepared.

>>
>>-- upsert with no conflict check
>>control query shape cut;

--- SQL operation complete.
>>cqd attempt_esp_parallelism 'OFF';

--- SQL operation complete.
>>delete from t023t1;

--- 2 row(s) deleted.
>>prepare s from upsert with no conflict check into t023t1 
+>   values (1,1), (2,2), (3,3);

--- SQL command prepared.
>>explain options 'f' s;

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

3    .    4    root                            x                     3.00E+000
1    2    3    tuple_flow                                            3.00E+000
.    .    2    trafodion_vsbb_upser            T023T1                1.00E+000
.    .    1    tuplelist                                             3.00E+000

--- SQL operation complete.
>>execute s;

--- 3 row(s) inserted.
>>select * from t023t1;

A            B          
-----------  -----------

          1            1
          2            2
          3            3

--- 3 row(s) selected.
>>
>>prepare s from upsert with no conflict check into t023t1 values (4,4);

--- SQL command prepared.
>>explain options 'f' s;

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

1    .    2    root                  o                               1.00E+000
.    .    1    trafodion_upsert      r         T023T1                1.00E+000

--- SQL operation complete.
>>execute s;

--- 1 row(s) inserted.
>>select * from t023t1;

A            B          
-----------  -----------

          1            1
          2            2
          3            3
          4            4

--- 4 row(s) selected.
>>
>>-- error cases for 'with no conflict check'
>>
>>-- only upsert can be used 'with no conflict check'
>>insert with no conflict check into t023t1 values (1,1);

*** ERROR[3252] This statement WITH NO CONFLICT CHECK is not supported. Reason: Can only be used with UPSERT.

*** ERROR[8822] The statement was not prepared.

>>upsert using load with no conflict check into t023t1 values (1,1);

*** ERROR[3252] This statement WITH NO CONFLICT CHECK is not supported. Reason: Can only be used with UPSERT.

*** ERROR[8822] The statement was not prepared.

>>
>>-- cannot be used with hive tables
>>prepare s from upsert with no conflict check into hive.hive.customer default values;

*** ERROR[3252] This statement WITH NO CONFLICT CHECK is not supported. Reason: Cannot be used with hive tables.

*** ERROR[8822] The statement was not prepared.

>>
>>-- cannot run within user xn or with auto commit off
>>begin work;

--- SQL operation complete.
>>prepare s from upsert with no conflict check into t023t1 values (1,1), (2,2);

*** ERROR[3252] This statement WITH NO CONFLICT CHECK is not supported. Reason: Cannot be used with a user transaction.

*** ERROR[8822] The statement was not prepared.

>>commit work;

--- SQL operation complete.
>>set transaction autocommit off;

--- SQL operation complete.
>>prepare s from upsert with no conflict check into t023t1 values (1,1), (2,2);

*** ERROR[3252] This statement WITH NO CONFLICT CHECK is not supported. Reason: Cannot be used if AUTOCOMMIT is OFF.

*** ERROR[8822] The statement was not prepared.

>>set transaction autocommit on;

--- SQL operation complete.
>>
>>-- cannot be used if table has secondary indexes
>>create index t023t1i1 on t023t1 (b);

--- SQL operation complete.
>>prepare s from upsert with no conflict check into t023t1 values (4,4);

*** ERROR[3252] This statement WITH NO CONFLICT CHECK is not supported. Reason: Cannot be used with secondary indexes.

*** ERROR[8822] The statement was not prepared.

>>
>>-- cannot be used if table has LOB cols
>>cqd traf_blob_as_varchar 'OFF';

--- SQL operation complete.
>>drop table if exists t023t1lob;

--- SQL operation complete.
>>create table t023lob (a int, b blob);

--- SQL operation complete.
>>prepare s from upsert with no conflict check into t023lob 
+>       values (1, stringtolob('a'));

*** ERROR[3252] This statement WITH NO CONFLICT CHECK is not supported. Reason: Cannot be used with LOB columns.

*** ERROR[8822] The statement was not prepared.

>>
>>
>>-- test ddl in transaction
>>obey TEST023 (ddl_dml);
>>-------------------------------------------------------------------------------
>>create table if not exists t023t5(c1 varchar(40));

--- SQL operation complete.
>>create unique index t_023t5_idx on t023t5(c1);

--- SQL operation complete.
>>insert into t023t5 values ('aaaaa');

--- 1 row(s) inserted.
>>
>>create table if not exists t023t6(c1 varchar(40));

--- SQL operation complete.
>>create unique index t_023t6_idx on t023t6(c1);

--- SQL operation complete.
>>insert into t023t6 values ('aaaaa');

--- 1 row(s) inserted.
>>
>>prepare mc from
+>select cast (catalog_name as char(30) character set iso88591),
+>       cast (schema_name as char(30) character set iso88591),
+>       cast (object_name as char(30) character set iso88591)
+>from table(natablecacheentries('user','local')) 
+>where object_name <> '__SCHEMA__' order by 1,2,3;

--- SQL command prepared.
>>
>>delete all from table(natablecache('remove'));

--- 0 row(s) deleted.
>>
>>obey TEST023 (cm_tx_cm5_cm6);
>>-------------------------------------------------------------------------------
>>begin work;

--- SQL operation complete.
>>obey TEST023 (commit_savepoint_T5);
>>-------------------------------------------------------------------------------
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>begin savepoint;

--- SQL operation complete.
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>alter table t023t5 add if not exists column c2 int;

--- SQL operation complete.
>>select * from t023t5;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>commit savepoint;

--- SQL operation complete.
>>
>>obey TEST023 (commit_savepoint_T6);
>>-------------------------------------------------------------------------------
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>begin savepoint;

--- SQL operation complete.
>>select * from t023t6;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>alter table t023t6 add if not exists column c2 int;

--- SQL operation complete.
>>select * from t023t6;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>commit savepoint;

--- SQL operation complete.
>>
>>-- t5, t6
>>execute mc;

(EXPR)                          (EXPR)                          (EXPR)
------------------------------  ------------------------------  ------------------------------

TRAFODION                       SCH                             T023T5                        
TRAFODION                       SCH                             T023T6                        

--- 2 row(s) selected.
>>-- c1, c2
>>select * from t023t5;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>-- c1, c2
>>select * from t023t6;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>commit work;

--- SQL operation complete.
>>-- null
>>execute mc;

--- 0 row(s) selected.
>>-- c1, c2
>>select * from t023t5;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>-- c1, c2
>>select * from t023t6;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>obey TEST023 (reset_col_t5);
>>-------------------------------------------------------------------------------
>>alter table t023t5 drop column c2;

--- SQL operation complete.
>>
>>obey TEST023 (reset_col_t6);
>>-------------------------------------------------------------------------------
>>alter table t023t6 drop column c2;

--- SQL operation complete.
>>
>>
>>obey TEST023 (cm_tx_roll5_roll6);
>>-------------------------------------------------------------------------------
>>begin work;

--- SQL operation complete.
>>obey TEST023 (rollback_savepoint_T5);
>>-------------------------------------------------------------------------------
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>begin savepoint;

--- SQL operation complete.
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>alter table t023t5 add if not exists column c2 int;

--- SQL operation complete.
>>select * from t023t5;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>rollback savepoint;

--- SQL operation complete.
>>
>>obey TEST023 (rollback_savepoint_T6);
>>-------------------------------------------------------------------------------
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>begin savepoint;

--- SQL operation complete.
>>select * from t023t6;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>alter table t023t6 add if not exists column c2 int;

--- SQL operation complete.
>>select * from t023t6;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>rollback savepoint;

--- SQL operation complete.
>>
>>-- null
>>execute mc;

--- 0 row(s) selected.
>>-- c1
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>-- c1
>>select * from t023t6;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>commit work;

--- SQL operation complete.
>>-- T5, T6(created by to select)
>>execute mc;

(EXPR)                          (EXPR)                          (EXPR)
------------------------------  ------------------------------  ------------------------------

TRAFODION                       SCH                             T023T5                        
TRAFODION                       SCH                             T023T6                        

--- 2 row(s) selected.
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>select * from t023t6;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>
>>obey TEST023 (cm_tx_roll5_cm6);
>>-------------------------------------------------------------------------------
>>begin work;

--- SQL operation complete.
>>obey TEST023 (rollback_savepoint_T5);
>>-------------------------------------------------------------------------------
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>begin savepoint;

--- SQL operation complete.
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>alter table t023t5 add if not exists column c2 int;

--- SQL operation complete.
>>select * from t023t5;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>rollback savepoint;

--- SQL operation complete.
>>
>>obey TEST023 (commit_savepoint_T6);
>>-------------------------------------------------------------------------------
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>begin savepoint;

--- SQL operation complete.
>>select * from t023t6;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>alter table t023t6 add if not exists column c2 int;

--- SQL operation complete.
>>select * from t023t6;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>commit savepoint;

--- SQL operation complete.
>>
>>-- t6
>>execute mc;

(EXPR)                          (EXPR)                          (EXPR)
------------------------------  ------------------------------  ------------------------------

TRAFODION                       SCH                             T023T6                        

--- 1 row(s) selected.
>>-- c1
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>-- c1, c2
>>select * from t023t6;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>commit work;

--- SQL operation complete.
>>-- t5(created by select, t6 is removed from cache)
>>execute mc;

(EXPR)                          (EXPR)                          (EXPR)
------------------------------  ------------------------------  ------------------------------

TRAFODION                       SCH                             T023T5                        

--- 1 row(s) selected.
>>-- c1
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>-- c1, c2
>>select * from t023t6;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>obey TEST023 (reset_col_t6);
>>-------------------------------------------------------------------------------
>>alter table t023t6 drop column c2;

--- SQL operation complete.
>>
>>
>>obey TEST023 (cm_tx_cm5_roll6);
>>-------------------------------------------------------------------------------
>>begin work;

--- SQL operation complete.
>>obey TEST023 (commit_savepoint_T5);
>>-------------------------------------------------------------------------------
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>begin savepoint;

--- SQL operation complete.
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>alter table t023t5 add if not exists column c2 int;

--- SQL operation complete.
>>select * from t023t5;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>commit savepoint;

--- SQL operation complete.
>>
>>obey TEST023 (rollback_savepoint_T6);
>>-------------------------------------------------------------------------------
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>begin savepoint;

--- SQL operation complete.
>>select * from t023t6;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>alter table t023t6 add if not exists column c2 int;

--- SQL operation complete.
>>select * from t023t6;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>rollback savepoint;

--- SQL operation complete.
>>
>>-- t5
>>execute mc;

(EXPR)                          (EXPR)                          (EXPR)
------------------------------  ------------------------------  ------------------------------

TRAFODION                       SCH                             T023T5                        

--- 1 row(s) selected.
>>-- c1, c2
>>select * from t023t5;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>-- c1
>>select * from t023t6;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>commit work;

--- SQL operation complete.
>>-- t6(created by select, t5 is removed from cache)
>>execute mc;

(EXPR)                          (EXPR)                          (EXPR)
------------------------------  ------------------------------  ------------------------------

TRAFODION                       SCH                             T023T6                        

--- 1 row(s) selected.
>>-- c1, c2
>>select * from t023t5;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>-- c1
>>select * from t023t6;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>obey TEST023 (reset_col_t5);
>>-------------------------------------------------------------------------------
>>alter table t023t5 drop column c2;

--- SQL operation complete.
>>
>>
>>obey TEST023 (roll_tx_cm5_cm6);
>>-------------------------------------------------------------------------------
>>begin work;

--- SQL operation complete.
>>obey TEST023 (commit_savepoint_T5);
>>-------------------------------------------------------------------------------
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>begin savepoint;

--- SQL operation complete.
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>alter table t023t5 add if not exists column c2 int;

--- SQL operation complete.
>>select * from t023t5;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>commit savepoint;

--- SQL operation complete.
>>
>>obey TEST023 (commit_savepoint_T6);
>>-------------------------------------------------------------------------------
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>begin savepoint;

--- SQL operation complete.
>>select * from t023t6;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>alter table t023t6 add if not exists column c2 int;

--- SQL operation complete.
>>select * from t023t6;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>commit savepoint;

--- SQL operation complete.
>>
>>-- t5, t6
>>execute mc;

(EXPR)                          (EXPR)                          (EXPR)
------------------------------  ------------------------------  ------------------------------

TRAFODION                       SCH                             T023T5                        
TRAFODION                       SCH                             T023T6                        

--- 2 row(s) selected.
>>-- c1, c2
>>select * from t023t5;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>-- c1, c2
>>select * from t023t6;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>rollback;

--- SQL operation complete.
>>-- null
>>execute mc;

--- 0 row(s) selected.
>>-- c1
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>-- c1
>>select * from t023t6;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>
>>obey TEST023 (roll_tx_roll5_roll6);
>>-------------------------------------------------------------------------------
>>begin work;

--- SQL operation complete.
>>obey TEST023 (rollback_savepoint_T5);
>>-------------------------------------------------------------------------------
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>begin savepoint;

--- SQL operation complete.
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>alter table t023t5 add if not exists column c2 int;

--- SQL operation complete.
>>select * from t023t5;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>rollback savepoint;

--- SQL operation complete.
>>
>>obey TEST023 (rollback_savepoint_T6);
>>-------------------------------------------------------------------------------
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>begin savepoint;

--- SQL operation complete.
>>select * from t023t6;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>alter table t023t6 add if not exists column c2 int;

--- SQL operation complete.
>>select * from t023t6;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>rollback savepoint;

--- SQL operation complete.
>>
>>-- null
>>execute mc;

--- 0 row(s) selected.
>>-- c1
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>-- c1
>>select * from t023t6;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>rollback;

--- SQL operation complete.
>>-- t5, t6(created by select, not ddl command, so not clean)
>>execute mc;

(EXPR)                          (EXPR)                          (EXPR)
------------------------------  ------------------------------  ------------------------------

TRAFODION                       SCH                             T023T5                        
TRAFODION                       SCH                             T023T6                        

--- 2 row(s) selected.
>>-- c1
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>-- c1
>>select * from t023t6;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>
>>obey TEST023 (roll_tx_roll5_cm6);
>>-------------------------------------------------------------------------------
>>begin work;

--- SQL operation complete.
>>obey TEST023 (rollback_savepoint_T5);
>>-------------------------------------------------------------------------------
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>begin savepoint;

--- SQL operation complete.
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>alter table t023t5 add if not exists column c2 int;

--- SQL operation complete.
>>select * from t023t5;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>rollback savepoint;

--- SQL operation complete.
>>
>>obey TEST023 (commit_savepoint_T6);
>>-------------------------------------------------------------------------------
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>begin savepoint;

--- SQL operation complete.
>>select * from t023t6;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>alter table t023t6 add if not exists column c2 int;

--- SQL operation complete.
>>select * from t023t6;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>commit savepoint;

--- SQL operation complete.
>>
>>-- t6
>>execute mc;

(EXPR)                          (EXPR)                          (EXPR)
------------------------------  ------------------------------  ------------------------------

TRAFODION                       SCH                             T023T6                        

--- 1 row(s) selected.
>>-- c1
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>-- c1, c2
>>select * from t023t6;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>rollback;

--- SQL operation complete.
>>-- t5(created by select, not ddl command, so not clean)
>>execute mc;

(EXPR)                          (EXPR)                          (EXPR)
------------------------------  ------------------------------  ------------------------------

TRAFODION                       SCH                             T023T5                        

--- 1 row(s) selected.
>>-- c1
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>-- c1
>>select * from t023t6;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>
>>obey TEST023 (roll_tx_cm5_roll6);
>>-------------------------------------------------------------------------------
>>begin work;

--- SQL operation complete.
>>obey TEST023 (commit_savepoint_T5);
>>-------------------------------------------------------------------------------
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>begin savepoint;

--- SQL operation complete.
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>alter table t023t5 add if not exists column c2 int;

--- SQL operation complete.
>>select * from t023t5;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>commit savepoint;

--- SQL operation complete.
>>
>>obey TEST023 (rollback_savepoint_T6);
>>-------------------------------------------------------------------------------
>>cqd traf_savepoints 'ON';

--- SQL operation complete.
>>begin savepoint;

--- SQL operation complete.
>>select * from t023t6;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>alter table t023t6 add if not exists column c2 int;

--- SQL operation complete.
>>select * from t023t6;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>rollback savepoint;

--- SQL operation complete.
>>
>>-- t5
>>execute mc;

(EXPR)                          (EXPR)                          (EXPR)
------------------------------  ------------------------------  ------------------------------

TRAFODION                       SCH                             T023T5                        

--- 1 row(s) selected.
>>-- c1, c2
>>select * from t023t5;

C1                                        C2         
----------------------------------------  -----------

aaaaa                                               ?

--- 1 row(s) selected.
>>-- c1
>>select * from t023t6;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>rollback;

--- SQL operation complete.
>>-- t6(created by select, not ddl command, so not clean)
>>execute mc;

(EXPR)                          (EXPR)                          (EXPR)
------------------------------  ------------------------------  ------------------------------

TRAFODION                       SCH                             T023T6                        

--- 1 row(s) selected.
>>-- c1
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>-- c1
>>select * from t023t6;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>
>>obey TEST023 (roll_tx_exception);
>>-------------------------------------------------------------------------------
>>cqd traf_savepoints 'OFF';

--- SQL operation complete.
>>begin work;

--- SQL operation complete.
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>alter table t023t5 add if not exists column c2 int;

--- SQL operation complete.
>>insert into t023t5 values ('aaaaa', 2);

*** ERROR[8102] The operation is prevented by a unique constraint.

*** ERROR[8839] Transaction was aborted.

--- 0 row(s) inserted.
>>-- not include t5
>>execute mc;

(EXPR)                          (EXPR)                          (EXPR)
------------------------------  ------------------------------  ------------------------------

TRAFODION                       SCH                             T023T6                        
TRAFODION                       SCH                             T_023T5_IDX                   

--- 2 row(s) selected.
>>select * from t023t5;

C1                                      
----------------------------------------

aaaaa                                   

--- 1 row(s) selected.
>>log;
