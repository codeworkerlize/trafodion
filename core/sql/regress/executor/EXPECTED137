>>
>>create schema if not exists sch137;

--- SQL operation complete.
>>set schema sch137;

--- SQL operation complete.
>>
>>cqd traf_lob_version2 'ON';

--- SQL operation complete.
>>obey TEST137(tests);
>>set schema sch137;

--- SQL operation complete.
>>
>>drop table if exists tlob1;

--- SQL operation complete.
>>create table if not exists tlob1 (a blob(100), b clob(100), c clob(100));

--- SQL operation complete.
>>delete from tlob1;

--- 0 row(s) deleted.
>>
>>insert into tlob1 values ('10', 'abc', ' xyz '), ('20', 'tt', 'yyyy');

*** ERROR[4483] This LOB conversion function is not allowed in the VALUES clause with multiple input value rows. Use it with a single value row.

*** ERROR[8822] The statement was not prepared.

>>
>>insert into tlob1 values ('10', 'abc', ' xyz ');

--- 1 row(s) inserted.
>>insert into tlob1 values ('20', 'tt', 'yyyy');

--- 1 row(s) inserted.
>>
>>-- should return error. Command not supported from sqlci/trafci
>>extract lobtobuffer(lob 'LOBH00001', location 123, size 123);

*** ERROR[3242] This statement is not supported. Reason: EXTRACT LOBTOBUFFER command cannot be issued directly from sqlci or trafci.

*** ERROR[8822] The statement was not prepared.

>>
>>prepare s from update using upsert tlob1 set b = 'abc';

--- SQL command prepared.
>>explain options 'f' s;

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

3    .    4    root                            x                     1.00E+002
1    2    3    tuple_flow                                            1.00E+002
.    .    2    trafodion_update                TLOB1                 1.00E+000
.    .    1    trafodion_scan                  TLOB1                 1.00E+002

--- SQL operation complete.
>>
>>-- return error. minus not allowed on blob cols.
>>select a from tlob1 minus select a from tlob1;

*** ERROR[4322] A column with LOB datatype cannot be used in this clause or function.

*** ERROR[8822] The statement was not prepared.

>>
>>--should succeed
>>select b from tlob1 minus select b from tlob1;

*** ERROR[4322] A column with LOB datatype cannot be used in this clause or function.

*** ERROR[8822] The statement was not prepared.

>>
>>select octet_length(a), char_length(b), octet_length(c) from tlob1;

(EXPR)                (EXPR)                (EXPR)              
--------------------  --------------------  --------------------

                   2                     3                     5
                   2                     2                     4

--- 2 row(s) selected.
>>
>>select b || c, substring(b,2,1), trim(c), overlay(b placing 'rr' from 2)    
+>  from tlob1;

(EXPR)                                                                                                                                                                                                    (EXPR)  (EXPR)                                                                                                (EXPR)
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ------  ----------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

abc xyz                                                                                                                                                                                                   b       xyz                                                                                                   arr                                                                                                                                                                                                       
ttyyyy                                                                                                                                                                                                    t       yyyy                                                                                                  trr                                                                                                                                                                                                       

--- 2 row(s) selected.
>>
>>-- union cannot be used on blob/clob cols
>>select * from tlob1 union select * from tlob1;

*** ERROR[4322] A column with LOB datatype cannot be used in this clause or function.

*** ERROR[8822] The statement was not prepared.

>>select a from tlob1 union select a from tlob1;

*** ERROR[4322] A column with LOB datatype cannot be used in this clause or function.

*** ERROR[8822] The statement was not prepared.

>>select b,c from tlob1 union select b,c from tlob1;

*** ERROR[4322] A column with LOB datatype cannot be used in this clause or function.

*** ERROR[8822] The statement was not prepared.

>>
>>-- update queries
>>
>>delete from tlob1;

--- 2 row(s) deleted.
>>set param ?p NULL;
>>
>>--row does not exist. nothing to update.
>>  delete from tlob1;

--- 0 row(s) deleted.
>>  update tlob1 set b = null;

--- 0 row(s) updated.
>>  select lobtostring(a,10) from tlob1;

--- 0 row(s) selected.
>>
>>
>>--row exists. no existing handle.  new value null.  insert null in row.
>>  delete from tlob1;

--- 0 row(s) deleted.
>>  insert into tlob1 values (null, null, null);

--- 1 row(s) inserted.
>>  update tlob1 set b = null;

--- 1 row(s) updated.
>>  select lobtostring(b,10) from tlob1;

(EXPR)    
----------

?         

--- 1 row(s) selected.
>>
>>--row exists. no existing handle.  new value nonull. gen handle. insert nonull.
>>  delete from tlob1;

--- 1 row(s) deleted.
>>  insert into tlob1 values (null, null, null);

--- 1 row(s) inserted.
>>  update tlob1 set b = 'abc';

--- 1 row(s) updated.
>>  select lobtostring(b,10) from tlob1;

(EXPR)    
----------

abc       

--- 1 row(s) selected.
>>
>>
>>--row exists. existing handle. new value null. delete handle. insert null in row.
>>  delete from tlob1;

--- 1 row(s) deleted.
>>  insert into tlob1 values ('a', 'b', 'c');

--- 1 row(s) inserted.
>>  update tlob1 set b = null;

--- 1 row(s) updated.
>>  select lobtostring(b,10) from tlob1;

(EXPR)    
----------

?         

--- 1 row(s) selected.
>>
>>
>>--row exists. existing handle. new value nonull. update nonull value.
>>  delete from tlob1;

--- 1 row(s) deleted.
>>  insert into tlob1 values ('a', 'b', 'c');

--- 1 row(s) inserted.
>>  update tlob1 set b = 'bb';

--- 1 row(s) updated.
>>  select lobtostring(b,10) from tlob1;

(EXPR)    
----------

bb        

--- 1 row(s) selected.
>>
>>
>>--update a null value. no append. Should result in a null value.
>>  delete from tlob1;

--- 1 row(s) deleted.
>>  insert into tlob1 values ('a', 'b', 'c');

--- 1 row(s) inserted.
>>  update tlob1 set b = stringtolob(cast(?p as char(10)));

--- 1 row(s) updated.
>>  select lobtostring(b,10) from tlob1;

(EXPR)    
----------

?         

--- 1 row(s) selected.
>>
>>
>>--update append a null value. Should result in a null value.
>>  delete from tlob1;

--- 1 row(s) deleted.
>>  insert into tlob1 values ('a', 'b', 'c');

--- 1 row(s) inserted.
>>  update tlob1 set b = stringtolob(cast(?p as char(10)), append);

--- 1 row(s) updated.
>>  select lobtostring(b,10) from tlob1;

(EXPR)    
----------

?         

--- 1 row(s) selected.
>>
>>
>>-- alter drop on tables with lob columns
>>drop table if exists t031t1 cascade;

--- SQL operation complete.
>>create table t031t1 (z int primary key, a int, b blob, c int, d blob);

--- SQL operation complete.
>>insert into t031t1 values (10, 1, 'bb', 2, 'dd');

--- 1 row(s) inserted.
>>select z, a,lobtostring(b,10),c,lobtostring(d,10)  from t031t1;

Z            A            (EXPR)      C            (EXPR)    
-----------  -----------  ----------  -----------  ----------

         10            1  bb                    2  dd        

--- 1 row(s) selected.
>>alter table t031t1 drop column c;

--- SQL operation complete.
>>select z, a,lobtostring(b,10), lobtostring(d,10) from t031t1;

Z            A            (EXPR)      (EXPR)    
-----------  -----------  ----------  ----------

         10            1  bb          dd        

--- 1 row(s) selected.
>>alter table t031t1 drop column a;

--- SQL operation complete.
>>select z, lobtostring(b,10), lobtostring(d,10) from t031t1;

Z            (EXPR)      (EXPR)    
-----------  ----------  ----------

         10  bb          dd        

--- 1 row(s) selected.
>>alter table t031t1 drop column b;

--- SQL operation complete.
>>select z, lobtostring(d,10) from t031t1;

Z            (EXPR)    
-----------  ----------

         10  dd        

--- 1 row(s) selected.
>>alter table t031t1 drop column d;

--- SQL operation complete.
>>select z from t031t1;

Z          
-----------

         10

--- 1 row(s) selected.
>>
>>
>>
>>
>>cqd traf_lob_version2 'OFF';

--- SQL operation complete.
>>obey TEST137(tests);
>>set schema sch137;

--- SQL operation complete.
>>
>>drop table if exists tlob1;

--- SQL operation complete.
>>create table if not exists tlob1 (a blob(100), b clob(100), c clob(100));

--- SQL operation complete.
>>delete from tlob1;

--- 0 row(s) deleted.
>>
>>insert into tlob1 values ('10', 'abc', ' xyz '), ('20', 'tt', 'yyyy');

*** ERROR[4483] This LOB conversion function is not allowed in the VALUES clause with multiple input value rows. Use it with a single value row.

*** ERROR[8822] The statement was not prepared.

>>
>>insert into tlob1 values ('10', 'abc', ' xyz ');

--- 1 row(s) inserted.
>>insert into tlob1 values ('20', 'tt', 'yyyy');

--- 1 row(s) inserted.
>>
>>-- should return error. Command not supported from sqlci/trafci
>>extract lobtobuffer(lob 'LOBH00001', location 123, size 123);

*** ERROR[3242] This statement is not supported. Reason: EXTRACT LOBTOBUFFER command cannot be issued directly from sqlci or trafci.

*** ERROR[8822] The statement was not prepared.

>>
>>prepare s from update using upsert tlob1 set b = 'abc';

--- SQL command prepared.
>>explain options 'f' s;

LC   RC   OP   OPERATOR              OPT       DESCRIPTION           CARD
---- ---- ---- --------------------  --------  --------------------  ---------

3    .    4    root                            x                     1.00E+002
1    2    3    tuple_flow                                            1.00E+002
.    .    2    trafodion_update                TLOB1                 1.00E+000
.    .    1    trafodion_scan                  TLOB1                 1.00E+002

--- SQL operation complete.
>>
>>-- return error. minus not allowed on blob cols.
>>select a from tlob1 minus select a from tlob1;

*** ERROR[4322] A column with LOB datatype cannot be used in this clause or function.

*** ERROR[8822] The statement was not prepared.

>>
>>--should succeed
>>select b from tlob1 minus select b from tlob1;

*** ERROR[4322] A column with LOB datatype cannot be used in this clause or function.

*** ERROR[8822] The statement was not prepared.

>>
>>select octet_length(a), char_length(b), octet_length(c) from tlob1;

(EXPR)      (EXPR)      (EXPR)    
----------  ----------  ----------

         2           3           5
         2           2           4

--- 2 row(s) selected.
>>
>>select b || c, substring(b,2,1), trim(c), overlay(b placing 'rr' from 2)    
+>  from tlob1;

(EXPR)                                                                                                                                                                                                    (EXPR)  (EXPR)                                                                                                (EXPR)
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ------  ----------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

abc xyz                                                                                                                                                                                                   b       xyz                                                                                                   arr                                                                                                                                                                                                       
ttyyyy                                                                                                                                                                                                    t       yyyy                                                                                                  trr                                                                                                                                                                                                       

--- 2 row(s) selected.
>>
>>-- union cannot be used on blob/clob cols
>>select * from tlob1 union select * from tlob1;

*** ERROR[4322] A column with LOB datatype cannot be used in this clause or function.

*** ERROR[8822] The statement was not prepared.

>>select a from tlob1 union select a from tlob1;

*** ERROR[4322] A column with LOB datatype cannot be used in this clause or function.

*** ERROR[8822] The statement was not prepared.

>>select b,c from tlob1 union select b,c from tlob1;

*** ERROR[4322] A column with LOB datatype cannot be used in this clause or function.

*** ERROR[8822] The statement was not prepared.

>>
>>-- update queries
>>
>>delete from tlob1;

--- 2 row(s) deleted.
>>set param ?p NULL;
>>
>>--row does not exist. nothing to update.
>>  delete from tlob1;

--- 0 row(s) deleted.
>>  update tlob1 set b = null;

--- 0 row(s) updated.
>>  select lobtostring(a,10) from tlob1;

--- 0 row(s) selected.
>>
>>
>>--row exists. no existing handle.  new value null.  insert null in row.
>>  delete from tlob1;

--- 0 row(s) deleted.
>>  insert into tlob1 values (null, null, null);

--- 1 row(s) inserted.
>>  update tlob1 set b = null;

--- 1 row(s) updated.
>>  select lobtostring(b,10) from tlob1;

(EXPR)    
----------

?         

--- 1 row(s) selected.
>>
>>--row exists. no existing handle.  new value nonull. gen handle. insert nonull.
>>  delete from tlob1;

--- 1 row(s) deleted.
>>  insert into tlob1 values (null, null, null);

--- 1 row(s) inserted.
>>  update tlob1 set b = 'abc';

--- 1 row(s) updated.
>>  select lobtostring(b,10) from tlob1;

(EXPR)    
----------

abc       

--- 1 row(s) selected.
>>
>>
>>--row exists. existing handle. new value null. delete handle. insert null in row.
>>  delete from tlob1;

--- 1 row(s) deleted.
>>  insert into tlob1 values ('a', 'b', 'c');

--- 1 row(s) inserted.
>>  update tlob1 set b = null;

--- 1 row(s) updated.
>>  select lobtostring(b,10) from tlob1;

(EXPR)    
----------

?         

--- 1 row(s) selected.
>>
>>
>>--row exists. existing handle. new value nonull. update nonull value.
>>  delete from tlob1;

--- 1 row(s) deleted.
>>  insert into tlob1 values ('a', 'b', 'c');

--- 1 row(s) inserted.
>>  update tlob1 set b = 'bb';

--- 1 row(s) updated.
>>  select lobtostring(b,10) from tlob1;

(EXPR)    
----------

bb        

--- 1 row(s) selected.
>>
>>
>>--update a null value. no append. Should result in a null value.
>>  delete from tlob1;

--- 1 row(s) deleted.
>>  insert into tlob1 values ('a', 'b', 'c');

--- 1 row(s) inserted.
>>  update tlob1 set b = stringtolob(cast(?p as char(10)));

--- 1 row(s) updated.
>>  select lobtostring(b,10) from tlob1;

(EXPR)    
----------

?         

--- 1 row(s) selected.
>>
>>
>>--update append a null value. Should result in a null value.
>>  delete from tlob1;

--- 1 row(s) deleted.
>>  insert into tlob1 values ('a', 'b', 'c');

--- 1 row(s) inserted.
>>  update tlob1 set b = stringtolob(cast(?p as char(10)), append);

--- 1 row(s) updated.
>>  select lobtostring(b,10) from tlob1;

(EXPR)    
----------

?         

--- 1 row(s) selected.
>>
>>
>>-- alter drop on tables with lob columns
>>drop table if exists t031t1 cascade;

--- SQL operation complete.
>>create table t031t1 (z int primary key, a int, b blob, c int, d blob);

--- SQL operation complete.
>>insert into t031t1 values (10, 1, 'bb', 2, 'dd');

--- 1 row(s) inserted.
>>select z, a,lobtostring(b,10),c,lobtostring(d,10)  from t031t1;

Z            A            (EXPR)      C            (EXPR)    
-----------  -----------  ----------  -----------  ----------

         10            1  bb                    2  dd        

--- 1 row(s) selected.
>>alter table t031t1 drop column c;

--- SQL operation complete.
>>select z, a,lobtostring(b,10), lobtostring(d,10) from t031t1;

Z            A            (EXPR)      (EXPR)    
-----------  -----------  ----------  ----------

         10            1  bb          dd        

--- 1 row(s) selected.
>>alter table t031t1 drop column a;

--- SQL operation complete.
>>select z, lobtostring(b,10), lobtostring(d,10) from t031t1;

Z            (EXPR)      (EXPR)    
-----------  ----------  ----------

         10  bb          dd        

--- 1 row(s) selected.
>>alter table t031t1 drop column b;

*** ERROR[1100] LOB column B cannot be specified in this alter operation.

--- SQL operation failed with errors.
>>select z, lobtostring(d,10) from t031t1;

Z            (EXPR)    
-----------  ----------

         10  dd        

--- 1 row(s) selected.
>>alter table t031t1 drop column d;

*** ERROR[1100] LOB column D cannot be specified in this alter operation.

--- SQL operation failed with errors.
>>select z from t031t1;

Z          
-----------

         10

--- 1 row(s) selected.
>>
>>
>>
>>
>>log;
