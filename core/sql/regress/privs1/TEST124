-- ============================================================================
-- TEST124 - tests get statements for component privileges
--
-- @@@ START COPYRIGHT @@@
--
-- Licensed to the Apache Software Foundation (ASF) under one
-- or more contributor license agreements.  See the NOTICE file
-- distributed with this work for additional information
-- regarding copyright ownership.  The ASF licenses this file
-- to you under the Apache License, Version 2.0 (the
-- "License"); you may not use this file except in compliance
-- with the License.  You may obtain a copy of the License at
--
--   http://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing,
-- software distributed under the License is distributed on an
-- "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
-- KIND, either express or implied.  See the License for the
-- specific language governing permissions and limitations
-- under the License.
--
-- @@@ END COPYRIGHT @@@
--
-- ============================================================================
cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';
obey TEST124(clean_up);
log LOG124 clear;
obey TEST124(set_up);
obey TEST124(tests);
log; 
obey TEST124(clean_up);
exit;

?section set_up
revoke component privilege "SHOW" on sql_operations from "PUBLIC";
revoke component privilege create_schema on sql_operations from "PUBLIC";
get privileges on component sql_operations for "PUBLIC";

-- setup test case1:  default behavior for DB__ROOT

-- setup test case2: component privileges for a user
grant component privilege MANAGE_STATISTICS, QUERY_ACTIVATE, CREATE_SCHEMA
on sql_operations to sql_user7;

-- setup test case3: component privileges for a role
create role t124role1;
grant component privilege "CREATE", query_cancel on sql_operations to t124role1;
grant role t124role1 to sql_user6;
showddl role t124role1;

-- setup test case4: component privileges on user and role
grant component privilege manage_statistics on sql_operations to sql_user5;
grant role t124role1 to sql_user5;

-- setup test case5:  SHOW has all privileges
create role t124role2;
grant component privilege "SHOW" on sql_operations to t124role2;
grant role t124role2 to sql_user8;
showddl role t124role2;

?section tests
-- <<<<< test case1 >>>>>: default behavior  
-- DB__ROOT can see all privs
obey TEST124(get_privs);

-- <<<<< test case2 >>>>>: grant subset of privileges to user
-- sql_user7 has privs create_schema, manage_statistics, query_activate
sh sqlci -i "TEST124(get_privs)" -u sql_user7;

-- <<<<< test case3 >>>>>: grant subset of privilege to role
-- sql_user6 has privs create, query_cancel by t124role1
sh sqlci -i "TEST124(get_privs)" -u sql_user6;

-- <<<<< test case4 >>>>>: get privileges from user and role
-- sql_user5 has manage_statistics at user level, create and query_cancel
--  at role level
sh sqlci -i "TEST124(get_privs)" -u sql_user5;

-- <<<<< test case5 >>>>>:  someone with SHOW privilege can see all component privileges
sh sqlci -i "TEST124(get_privs)" -u sql_user8;

-- <<<<< test case6 >>>>>:  db__rootrole see all privs
grant role db__rootrole to sql_user1;
sh sqlci -i "TEST124(get_privs)" -u sql_user1;
revoke role db__rootrole from sql_user1;

?section get_privs
log LOG124;
values(user);

get privileges on component sql_operations;
get privileges on component sql_operations cascade;
get privileges on component sql_operations for sql_user8;
get privileges on component sql_operations for sql_user7;
get privileges on component sql_operations for sql_user6;
get privileges on component sql_operations for sql_user5;
get privileges on component sql_operations for sql_user8 cascade;
get privileges on component sql_operations for sql_user7 cascade;
get privileges on component sql_operations for sql_user6 cascade;
get privileges on component sql_operations for sql_user5 cascade;
get privileges on component sql_operations for t124role1;
get privileges on component sql_operations for t124role1 cascade;
get privileges on component sql_operations for t124role2;
get privileges on component sql_operations for t124role2 cascade;

?section clean_up
revoke component privilege "SHOW" on sql_operations from sql_user8;
revoke component privilege manage_statistics, query_activate, create_schema
   on sql_operations from sql_user7;
revoke component privilege "CREATE", query_cancel on sql_operations;
revoke component privilege manage_statistics on sql_operations from sql_user5;
revoke component privilege "CREATE", query_cancel on sql_operations 
  from t124role1;
revoke role t124role1 from sql_user6;
revoke role t124role1 from sql_user5;
drop role t124role1;

revoke role t124role2 from sql_user8;
revoke component privilege "SHOW" on sql_operations from t124role2;
drop role t124role2;

revoke role db__rootrole from sql_user1;
grant component privilege "SHOW" on sql_operations to "PUBLIC";
grant component privilege create_schema on sql_operations to "PUBLIC";
get privileges on component sql_operations for "PUBLIC";
