-- ============================================================================
-- TEST127 - tests privileges with resource groups and tenants
--
-- @@@ START COPYRIGHT @@@
--
-- Licensed to the Apache Software Foundation (ASF) under one
-- or more contributor license agreements.  See the NOTICE file
-- distributed with this work for additional information
-- regarding copyright ownership.  The ASF licenses this file
-- to you under the Apache License, Version 2.0 (the
-- "License"); you may not use this file except in compliance
-- with the License.  You may obtain a copy of the License at
--
--   http://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing,
-- software distributed under the License is distributed on an
-- "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
-- KIND, either express or implied.  See the License for the
-- specific language governing permissions and limitations
-- under the License.
--
-- @@@ END COPYRIGHT @@@
--
-- Tests the following commands:
--    get and showddl stmts
-- ============================================================================

cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';
cqd TENANT_OVERSUBSCRIBE_ERR_NODE_RATIO '60.1';
cqd NODE_ALLOCATIONS 'edev05:0|2 node1:1|3 node2:2|2 node3:3|6 node4:4|3 node5:5|5 node6:6|3 node7:7|8 node8:8|3 node9:9|1 node10:10|2 ';

obey TEST127(clean_up);
log LOG127 clear;
obey TEST127(set_up);
obey TEST127(show_cmds);
sh sqlci -i "TEST127(show_cmds)" -u sql_user1;
sh sqlci -i "TEST127(show_cmds)" -u sql_user1 -t tenant1;
grant component privilege MANAGE_TENANTS on sql_operations to sql_user1;
-- sql_user1 should see everything
get privileges on component sql_operations for sql_user1 cascade;
sh sqlci -i "TEST127(show_cmds)" -u sql_user1 -t tenant1;
revoke component privilege MANAGE_TENANTS on sql_operations from sql_user1;
grant component privilege "SHOW" on sql_operations to sql_user1;
-- sql_user1 should see everything
get privileges on component sql_operations for sql_user1 cascade;
sh sqlci -i "TEST127(show_cmds)" -u sql_user1;
revoke component privilege "SHOW" on sql_operations from sql_user1;
log;
obey TEST127(clean_up);
exit;

?section clean_up
drop tenant tenant1;
drop tenant tenant2;
drop tenant tenant3;
drop tenant tenant4;

drop resource group group1;
drop resource group group2;
drop resource group group3;

revoke component privilege MANAGE_TENANTS on sql_operations from sql_user1;
revoke component privilege "SHOW" on sql_operations from sql_user1;

?section set_up
create resource group group1 nodes ('edev05');
create resource group group2 nodes ('edev05') authorization sql_user1;
create resource group group3 nodes ('node1', 'node3', 'node4', 'node8', 'node5');

create tenant tenant1 admin role tenant1_admin, resource groups (group1);
create tenant tenant2 admin role tenant2_admin, resource groups (group2);
create tenant tenant3 admin role tenant3_admin, resource groups (group1, group2);
create tenant tenant4 admin role tenant4_admin, resource groups (group3);

?section show_cmds
log LOG127;
cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

get resource groups;
showddl resource group group1;
showddl resource group group2;
showddl resource group group3;
showddl resource group db__rgroup_default;
showddl resource group group_noexists;

get nodes;
get nodes in resource group group1;
get nodes in resource group group2;
get nodes in resource group group3;
get nodes in resource group db__rgroup_default;
get nodes in resource group group_noexists;

get tenants;
showddl tenant tenant1;
showddl tenant tenant2;
showddl tenant tenant3;
showddl tenant tenant4;
showddl tenant esgyndb;
showddl tenant tenant_noexists;

get nodes for tenant tenant1;
get nodes for tenant tenant2;
get nodes for tenant tenant3;
get nodes for tenant tenant4;
get nodes for tenant esgyndb;
get nodes for tenant tenant_noexists;

get tenants on resource group group1;
get tenants on resource group group2;
get tenants on resource group group3;
get tenants on resource group db__rgroup_default;
get tenants on resource group group_noexists;

