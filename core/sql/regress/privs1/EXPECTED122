>>obey TEST122(tests);
>>-- =================================================================
>>--  runs 4 sets of tests
>>--    manage_tests - granting manage component privilege
>>--    t122sch1_tests where schema owner is role
>>--    t122sch2_tests where schema owner is user
>>--    ddl_tests - tests granting DDL privileges on schema
>>-- =================================================================
>>
>>create role manage_role;

--- SQL operation complete.
>>grant component privilege "MANAGE_STATISTICS" on sql_operations to manage_role;

--- SQL operation complete.
>>grant component privilege manage on sql_operations to sql_user7;

--- SQL operation complete.
>>grant role manage_role to sql_user7;

--- SQL operation complete.
>>get privileges on component sql_operations for sql_user7 cascade;

Privilege information on Component SQL_OPERATIONS for SQL_USER7
===============================================================

CREATE_SCHEMA
MANAGE
MANAGE_STATISTICS

=======================
 3 row(s) returned

--- SQL operation complete.
>>sh sqlci -i "TEST122(manage_tests)" -u sql_user7;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER7                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>cqd AUTO_QUERY_RETRY_WARNINGS 'ON';

--- SQL operation complete.
>>set param ?cmd 'put';
>>
>>-- selects from "_MD_", "_PRIVMGR_MD_"  and '_TENANT_MD_' work
>>-- sql_user7 get privileges from both manage_role and direct grants
>>select cast (auth_db_name as char (20) character set iso88591) 
+>from "_MD_".auths where auth_db_name like 'DB__%';

(EXPR)              
--------------------

DB__ADMIN           
DB__ROOT            
DB__ROOTROLE        
DB__ADMINROLE       
DB__SERVICESROLE    
DB__LIBMGRROLE      
DB__HIVEROLE        
DB__HBASEROLE       

--- 8 row(s) selected.
>>select cast(role_name as char(20) character set iso88591) 
+>from "_PRIVMGR_MD_".role_usage where role_name = 'MANAGE_ROLE';

(EXPR)              
--------------------

MANAGE_ROLE         
MANAGE_ROLE         

--- 2 row(s) selected.
>>select tenant_id, admin_role_id from "_TENANT_MD_".tenants where tenant_id = 1500000;

TENANT_ID    ADMIN_ROLE_ID
-----------  -------------

    1500000        1000000

--- 1 row(s) selected.
>>
>>-- operations against "_REPOS_"  and "_LIBMGR_ fail
>>select count(*) from "_REPOS_".METRIC_QUERY_TABLE;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION."_REPOS_".METRIC_QUERY_TABLE.

*** ERROR[8822] The statement was not prepared.

>>call "_LIBMGR_".help(?cmd);

*** ERROR[4482] The user does not have EXECUTE privilege on user-defined routine TRAFODION."_LIBMGR_".HELP.

*** ERROR[8822] The statement was not prepared.

>>
>>sh sqlci -i "TEST122(revoke_role_manage)";
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

DB__ROOT                                                                                                                        

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>revoke role manage_role from sql_user7;

--- SQL operation complete.
>>get privileges on component sql_operations for sql_user7 cascade;

Privilege information on Component SQL_OPERATIONS for SQL_USER7
===============================================================

CREATE_SCHEMA
MANAGE

=======================
 2 row(s) returned

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>-- selects from "_MD_", "_PRIVMGR_MD_"  and '_TENANT_MD_' still work
>>-- sql_user7 gets privilege from direct grant
>>select cast (auth_db_name as char (20) character set iso88591)
+>from "_MD_".auths where auth_db_name like 'DB__%';

(EXPR)              
--------------------

DB__ADMIN           
DB__ROOT            
DB__ROOTROLE        
DB__ADMINROLE       
DB__SERVICESROLE    
DB__LIBMGRROLE      
DB__HIVEROLE        
DB__HBASEROLE       

--- 8 row(s) selected.
>>select cast(role_name as char(20) character set iso88591) 
+>from "_PRIVMGR_MD_".role_usage where role_name = 'MANAGE_ROLE';

(EXPR)              
--------------------

MANAGE_ROLE         

--- 1 row(s) selected.
>>select tenant_id, admin_role_id from "_TENANT_MD_".tenants where tenant_id = 1500000;

TENANT_ID    ADMIN_ROLE_ID
-----------  -------------

    1500000        1000000

--- 1 row(s) selected.
>>
>>sh sqlci -i "TEST122(revoke_manage)";
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

DB__ROOT                                                                                                                        

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>revoke component privilege manage on sql_operations from sql_user7;

--- SQL operation complete.
>>get privileges on component sql_operations for sql_user7 cascade;

Privilege information on Component SQL_OPERATIONS for SQL_USER7
===============================================================

CREATE_SCHEMA

=======================
 1 row(s) returned

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>-- selects from "_MD_", "_PRIVMGR_MD_"  and '_TENANT_MD_' fail
>>select cast (auth_db_name as char (20) character set iso88591)
+>from "_MD_".auths where auth_db_name like 'DB__%';

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION."_MD_".AUTHS.

*** ERROR[8822] The statement was not prepared.

>>select cast(role_name as char(20) character set iso88591) 
+>from "_PRIVMGR_MD_".role_usage where role_name = 'MANAGE_ROLE';

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION."_PRIVMGR_MD_".ROLE_USAGE.

*** ERROR[8822] The statement was not prepared.

>>select tenant_id, admin_role_id from "_TENANT_MD_".tenants where tenant_id = 1500000;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION."_TENANT_MD_".TENANTS.

*** ERROR[8822] The statement was not prepared.

>>
>>exit;

End of MXCI Session

>>revoke component privilege manage_statistics on sql_operations from manage_role;

--- SQL operation complete.
>>revoke component privilege manage on sql_operations from sql_user7;

*** ERROR[1018] Grant of role or privilege MANAGE on component SQL_OPERATIONS from DB__ROOT to SQL_USER7 not found, revoke request ignored.

--- SQL operation failed with errors.
>>revoke role manage_role from sql_user7;

*** ERROR[1018] Grant of role or privilege MANAGE_ROLE from DB__ROOT to SQL_USER7 not found, revoke request ignored.

--- SQL operation failed with errors.
>>drop role manage_role;

--- SQL operation complete.
>>get privileges on component sql_operations for sql_user7 cascade;

Privilege information on Component SQL_OPERATIONS for SQL_USER7
===============================================================

CREATE_SCHEMA

=======================
 1 row(s) returned

--- SQL operation complete.
>>
>>obey TEST122(create_db);
>>-- =================================================================
>>-- create roles, schemas, and objects in schemas
>>-- =================================================================
>>
>>-- *** create roles and schemas ***
>>create role t122role1;

--- SQL operation complete.
>>create role t122role2;

--- SQL operation complete.
>>
>>grant select on "_MD_".objects to public;

--- SQL operation complete.
>>grant select on "_PRIVMGR_MD_".schema_privileges to public;

--- SQL operation complete.
>>
>>create schema t122sch1 authorization t122role1;

--- SQL operation complete.
>>create schema t122sch2 authorization sql_user3;

--- SQL operation complete.
>>
>>-- *** create schema t122sch1 objects ***
>>set schema t122sch1;

--- SQL operation complete.
>>create table teams
+>  (team_number int not null primary key,
+>   team_name char(20) not null,
+>   team_contact varchar(50) not null,
+>   team_contact_number char (10) not null
+>   )
+>  ;

--- SQL operation complete.
>>
>>alter table teams add constraint valid_team_no check (team_number > 0);

--- SQL operation complete.
>>insert into teams values
+>   (1, 'White Socks', 'Sam','4082282222'),
+>   (2, 'Giants', 'Joe', '5102839483'),
+>   (3, 'Cardinals', 'Stella', '9513849384'),
+>   (4, 'Indians', 'Matt', '5128383748'),
+>   (5, 'Tigers', 'Ronit', '6198273827');

--- 5 row(s) inserted.
>>
>>create table games
+>   ( home_team_number int not null,
+>     visitor_team_number int not null,
+>     game_number int not null primary key,
+>     game_time timestamp not null,
+>     game_location varchar(50) not null)
+>  ;

--- SQL operation complete.
>>
>>alter table games add constraint valid_game_number check (game_number > 0);

--- SQL operation complete.
>>
>>insert into games values
+>   (1, 2, 1, timestamp '2009-04-23 19:30:00', 'California'),
+>   (1, 3, 2, timestamp '2009-04-24 19:30:00', 'California'),
+>   (1, 4, 3, timestamp '2009-04-25 10:00:00', 'Oklahoma'),
+>   (2, 3, 4, timestamp '2009-04-25 13:30:00', 'Michigan'),
+>   (1, 5, 5, timestamp '2009-04-25 15:00:00', 'Oklahoma'),
+>   (2, 5, 6, timestamp '2009-04-27 17:00:00', 'New York'),
+>   (3, 4, 7, timestamp '2009-04-28 17:00:00', 'Florida'),
+>   (4, 2, 8, current_timestamp, 'Missouri');

--- 8 row(s) inserted.
>>
>>create view team_games as
+>  select t.team_number, g.game_number, g.game_time
+>  from teams t, games g
+>  where t.team_number = g.home_team_number
+>  order by t.team_number;

--- SQL operation complete.
>>
>>create sequence team_seq;

--- SQL operation complete.
>>
>>-- Prepare library file
>>sh rm -f ./etest141.dll;
>>sh sh $$scriptsdir$$/tools/dll-compile.ksh etest141.cpp
+>  2>&1 | tee LOG122-SECONDARY;
>>set pattern $$DLL$$ etest141.dll;
>>set pattern $$QUOTE$$ '''';
>>create library t122_l1 file $$QUOTE$$ $$REGRRUNDIR$$/$$DLL$$ $$QUOTE$$ ;

--- SQL operation complete.
>>create function translateBitmap(bitmap largeint) returns (bitmap_string char (20))
+>language c parameter style sql external name 'translateBitmap'
+>library t122_l1
+>deterministic no sql final call allow any parallelism state area size 1024 ;

--- SQL operation complete.
>>
>>get tables;

Tables in Schema TRAFODION.T122SCH1
===================================

GAMES
SB_HISTOGRAMS
SB_HISTOGRAM_INTERVALS
SB_PERSISTENT_SAMPLES
TEAMS

=======================
 5 row(s) returned

--- SQL operation complete.
>>get views;

Views in Schema TRAFODION.T122SCH1
==================================

TEAM_GAMES

=======================
 1 row(s) returned

--- SQL operation complete.
>>get sequences, match 'T122SCH1.TEAM_SEQ';

--- SQL operation complete.
>>get libraries;

Libraries in Schema TRAFODION.T122SCH1
======================================

T122_L1

=======================
 1 row(s) returned

--- SQL operation complete.
>>get functions;

Functions in Schema TRAFODION.T122SCH1
======================================

TRANSLATEBITMAP

=======================
 1 row(s) returned

--- SQL operation complete.
>>
>>-- *** create schema t122sch1 objects ***
>>set schema t122sch2;

--- SQL operation complete.
>>create table players
+>  (player_number int not null,
+>   player_name varchar (50) not null,
+>   player_team_number int not null,
+>   player_phone_number char (10) not null,
+>   player_details varchar(50),
+>   primary key (player_number, player_team_number))
+>  no partition;

--- SQL operation complete.
>>
>>alter table players add constraint valid_player_number check(player_number > 0);

--- SQL operation complete.
>>
>>insert into players values
+>   (1, 'Tom', 1, '4083948394', null),
+>   (2, 'Bob', 1, '4089483948', null),
+>   (3, 'Toby',1, '4082938493', 'pitcher'),
+>   (3, 'Toby',2, '4082938493', null),
+>   (4, 'Julie', 2, '5108394839', 'catcher'),
+>   (5, 'Joanne', 2, '5103849384', null),
+>   (6, 'Pete', 2, '5102839483', null),
+>   (6, 'Pete', 3, '5102839483', 'third base'),
+>   (7, 'Jared',4, '9518293849', 'short stop'),
+>   (8, 'Zachary', 4, '9518293840', null),
+>   (9, 'Lynne', 5, '9518293892', 'pitcher'),
+>   (10, 'Omar', 5, '5128394893', null);

--- 12 row(s) inserted.
>>
>>create table standings
+>    (team_number int not null primary key,
+>     wins int default 0,
+>     loses int default 0,
+>     last_updated timestamp default current_timestamp)
+>;

--- SQL operation complete.
>>
>>insert into standings (team_number) values (1), (2), (3), (4), (5);

--- 5 row(s) inserted.
>>
>>create table stats
+>  (team_number int not null primary key,
+>   num_players int not null)
+>;

--- SQL operation complete.
>>insert into stats values (1,11), (2,12), (3,10), (4,13), (5,12);

--- 5 row(s) inserted.
>>
>>get tables;

Tables in Schema TRAFODION.T122SCH2
===================================

PLAYERS
SB_HISTOGRAMS
SB_HISTOGRAM_INTERVALS
SB_PERSISTENT_SAMPLES
STANDINGS
STATS

=======================
 6 row(s) returned

--- SQL operation complete.
>>
>>grant component privilege "SHOW" on sql_operations to "PUBLIC";

--- SQL operation complete.
>>
>>-- *** report schema details ***
>>showddl schema t122sch1;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH1 AUTHORIZATION T122ROLE1 NAMESPACE
  'TRAF_1500000' ;

--- SQL operation complete.
>>showddl schema t122sch2;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH2 AUTHORIZATION SQL_USER3 NAMESPACE
  'TRAF_1500000' ;

--- SQL operation complete.
>>
>>grant role t122role1 to sql_user1;

--- SQL operation complete.
>>sh sqlci -i "TEST122(t122sch1_tests)" -u sql_user1;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER1                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>cqd AUTO_QUERY_RETRY_WARNINGS 'ON';

--- SQL operation complete.
>>set schema t122sch1;

--- SQL operation complete.
>>
>>-- sql_user1 can view all objects in schema
>>obey TEST122(t122sch1_cmds);
>>-- *** Perform basic dml against t122sch1
>>--    select
>>--    usage (sequence)
>>--    execute (translateBitmap)
>>-- ***
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER1                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch1;

--- SQL operation complete.
>>
>>select count(*) from games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>select count(*) from teams;

(EXPR)              
--------------------

                   5

--- 1 row(s) selected.
>>select count(*) from team_games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>select team_number, seqnum(team_seq) from teams;

TEAM_NUMBER  (EXPR)              
-----------  --------------------

          1                     1
          2                     2
          3                     3
          4                     4
          5                     5

--- 5 row(s) selected.
>>select distinct
+>   substring (schema_name,1,40) as schema_name,
+>   substring(grantor_name,1,10) as grantor,
+>   substring(grantee_name,1,10) as grantee,
+>   translateBitmap(privileges_bitmap) as granted_privs,
+>   translateBitmap(grantable_bitmap) as grantable_privs
+>from "_PRIVMGR_MD_".schema_privileges
+>where schema_uid in
+>     (select object_uid
+>      from "_MD_".objects
+>      where schema_name like 'T122SCH%')
+>  order by 1, 2, 3, 4, 5
+>;

--- 0 row(s) selected.
>>
>>
>>-- grant sql_user2 privs
>>-- fails error 1012 because sql_user1 does not have priv directly
>>grant select, update, insert, delete on schema t122sch1 to sql_user2;

*** ERROR[1012] No privileges were granted.  SQL_USER1 lacks grant option on the specified privileges. Please retry using the BY clause for one of the following roles (T122ROLE1).

--- SQL operation failed with errors.
>>
>>-- sql_user1 -> grant dml through the role
>>grant select, update, insert, delete on schema t122sch1 to sql_user2 by t122role1;

--- SQL operation complete.
>>
>>-- sql_user2 -> selects work but not execute (function) and usage (sequence)
>>sh sqlci -i "TEST122(user_tests)" -u sql_user2;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER2                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>obey TEST122(t122sch1_cmds);
>>-- *** Perform basic dml against t122sch1
>>--    select
>>--    usage (sequence)
>>--    execute (translateBitmap)
>>-- ***
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER2                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch1;

--- SQL operation complete.
>>
>>select count(*) from games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>select count(*) from teams;

(EXPR)              
--------------------

                   5

--- 1 row(s) selected.
>>select count(*) from team_games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>select team_number, seqnum(team_seq) from teams;

*** ERROR[4491] The user does not have USAGE privilege on sequence TRAFODION.T122SCH1.TEAM_SEQ.

*** ERROR[8822] The statement was not prepared.

>>select distinct
+>   substring (schema_name,1,40) as schema_name,
+>   substring(grantor_name,1,10) as grantor,
+>   substring(grantee_name,1,10) as grantee,
+>   translateBitmap(privileges_bitmap) as granted_privs,
+>   translateBitmap(grantable_bitmap) as grantable_privs
+>from "_PRIVMGR_MD_".schema_privileges
+>where schema_uid in
+>     (select object_uid
+>      from "_MD_".objects
+>      where schema_name like 'T122SCH%')
+>  order by 1, 2, 3, 4, 5
+>;

*** ERROR[4482] The user does not have EXECUTE privilege on user-defined routine TRAFODION.T122SCH1.TRANSLATEBITMAP.

*** ERROR[8822] The statement was not prepared.

>>
>>showddl schema t122sch1;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH1 AUTHORIZATION T122ROLE1 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH1 TO T122ROLE1 WITH GRANT OPTION;
  GRANT SELECT, INSERT, DELETE, UPDATE ON SCHEMA TRAFODION.T122SCH1 TO
  SQL_USER2;

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>
>>-- sql_user1 -> grant usage privilege
>>grant usage on schema t122sch1 to sql_user2 by t122role1;

--- SQL operation complete.
>>
>>-- sql_user2 -> all work except execute (function)
>>sh sqlci -i "TEST122(user_tests)" -u sql_user2;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER2                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>obey TEST122(t122sch1_cmds);
>>-- *** Perform basic dml against t122sch1
>>--    select
>>--    usage (sequence)
>>--    execute (translateBitmap)
>>-- ***
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER2                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch1;

--- SQL operation complete.
>>
>>select count(*) from games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>select count(*) from teams;

(EXPR)              
--------------------

                   5

--- 1 row(s) selected.
>>select count(*) from team_games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>select team_number, seqnum(team_seq) from teams;

TEAM_NUMBER  (EXPR)              
-----------  --------------------

          1                    26
          2                    27
          3                    28
          4                    29
          5                    30

--- 5 row(s) selected.
>>select distinct
+>   substring (schema_name,1,40) as schema_name,
+>   substring(grantor_name,1,10) as grantor,
+>   substring(grantee_name,1,10) as grantee,
+>   translateBitmap(privileges_bitmap) as granted_privs,
+>   translateBitmap(grantable_bitmap) as grantable_privs
+>from "_PRIVMGR_MD_".schema_privileges
+>where schema_uid in
+>     (select object_uid
+>      from "_MD_".objects
+>      where schema_name like 'T122SCH%')
+>  order by 1, 2, 3, 4, 5
+>;

*** ERROR[4482] The user does not have EXECUTE privilege on user-defined routine TRAFODION.T122SCH1.TRANSLATEBITMAP.

*** ERROR[8822] The statement was not prepared.

>>
>>showddl schema t122sch1;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH1 AUTHORIZATION T122ROLE1 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH1 TO T122ROLE1 WITH GRANT OPTION;
  GRANT SELECT, INSERT, DELETE, UPDATE, USAGE ON SCHEMA TRAFODION.T122SCH1 TO
  SQL_USER2;

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>
>>-- sql_user1 -> grant execute privilege
>>grant execute on schema t122sch1 to sql_user2 by t122role1;

--- SQL operation complete.
>>
>>-- sql_user2 -> all work
>>sh sqlci -i "TEST122(user_tests)" -u sql_user2;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER2                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>obey TEST122(t122sch1_cmds);
>>-- *** Perform basic dml against t122sch1
>>--    select
>>--    usage (sequence)
>>--    execute (translateBitmap)
>>-- ***
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER2                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch1;

--- SQL operation complete.
>>
>>select count(*) from games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>select count(*) from teams;

(EXPR)              
--------------------

                   5

--- 1 row(s) selected.
>>select count(*) from team_games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>select team_number, seqnum(team_seq) from teams;

TEAM_NUMBER  (EXPR)              
-----------  --------------------

          1                    51
          2                    52
          3                    53
          4                    54
          5                    55

--- 5 row(s) selected.
>>select distinct
+>   substring (schema_name,1,40) as schema_name,
+>   substring(grantor_name,1,10) as grantor,
+>   substring(grantee_name,1,10) as grantee,
+>   translateBitmap(privileges_bitmap) as granted_privs,
+>   translateBitmap(grantable_bitmap) as grantable_privs
+>from "_PRIVMGR_MD_".schema_privileges
+>where schema_uid in
+>     (select object_uid
+>      from "_MD_".objects
+>      where schema_name like 'T122SCH%')
+>  order by 1, 2, 3, 4, 5
+>;

SCHEMA_NAME                                                                                                                                                       GRANTOR                                   GRANTEE                                   GRANTED_PRIVS         GRANTABLE_PRIVS
----------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------  ----------------------------------------  --------------------  --------------------

TRAFODION.T122SCH1                                                                                                                                                T122ROLE1                                 SQL_USER2                                 SIDUG-E               NONE                

--- 1 row(s) selected.
>>
>>showddl schema t122sch1;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH1 AUTHORIZATION T122ROLE1 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH1 TO T122ROLE1 WITH GRANT OPTION;
  GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, EXECUTE ON SCHEMA
  TRAFODION.T122SCH1 TO SQL_USER2;

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>
>>-- sql_user1 -> revoke privs
>>-- fails, sql_user1 has no priv, need by clause
>>revoke select, update, insert, delete, usage, execute on schema t122sch1 from sql_user2;

*** ERROR[1012] No privileges were granted.  SQL_USER1 lacks grant option on the specified privileges. Please retry using the BY clause for one of the following roles (T122ROLE1).

--- SQL operation failed with errors.
>>
>>-- sql_user1 -> can revoke through role
>>revoke select, update, insert, delete, usage, execute on schema t122sch1 from sql_user2
+>   by t122role1;

--- SQL operation complete.
>>
>>-- Test query invalidation, by revoking role t122sch1 from sql_user1 and then
>>-- granting the role again. Grants and revokes are performed in a different
>>-- process
>>
>>-- sql_user1 no longer has privs through role
>>--    queries and grant statements fail
>>sh sqlci -i "TEST122(role_revoke)";
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

DB__ROOT                                                                                                                        

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>revoke role t122role1 from sql_user1;

--- SQL operation complete.
>>showddl role t122role1;

CREATE ROLE "T122ROLE1";
  -- GRANT ROLE "T122ROLE1" TO "DB__ROOT" WITH ADMIN OPTION;

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>obey TEST122(t122sch1_cmds);
>>-- *** Perform basic dml against t122sch1
>>--    select
>>--    usage (sequence)
>>--    execute (translateBitmap)
>>-- ***
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER1                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch1;

--- SQL operation complete.
>>
>>select count(*) from games;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH1.GAMES.

*** ERROR[8822] The statement was not prepared.

>>select count(*) from teams;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH1.TEAMS.

*** ERROR[8822] The statement was not prepared.

>>select count(*) from team_games;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH1.TEAM_GAMES.

*** ERROR[8822] The statement was not prepared.

>>select team_number, seqnum(team_seq) from teams;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH1.TEAMS.

*** ERROR[4491] The user does not have USAGE privilege on sequence TRAFODION.T122SCH1.TEAM_SEQ.

*** ERROR[8822] The statement was not prepared.

>>select distinct
+>   substring (schema_name,1,40) as schema_name,
+>   substring(grantor_name,1,10) as grantor,
+>   substring(grantee_name,1,10) as grantee,
+>   translateBitmap(privileges_bitmap) as granted_privs,
+>   translateBitmap(grantable_bitmap) as grantable_privs
+>from "_PRIVMGR_MD_".schema_privileges
+>where schema_uid in
+>     (select object_uid
+>      from "_MD_".objects
+>      where schema_name like 'T122SCH%')
+>  order by 1, 2, 3, 4, 5
+>;

*** ERROR[4482] The user does not have EXECUTE privilege on user-defined routine TRAFODION.T122SCH1.TRANSLATEBITMAP.

*** ERROR[8822] The statement was not prepared.

>>
>>grant select on schema t122sch1 to sql_user2 by t122role1;

*** ERROR[1017] You are not authorized to perform this operation.

--- SQL operation failed with errors.
>>revoke select on schema t122sch1 from sql_user2 by t122role1;

*** ERROR[1017] You are not authorized to perform this operation.

--- SQL operation failed with errors.
>>
>>-- sql_user1 now has privs through role
>>sh sqlci -i "TEST122(role_grant)";
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

DB__ROOT                                                                                                                        

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>grant role t122role1 to sql_user1;

--- SQL operation complete.
>>showddl role t122role1;

CREATE ROLE "T122ROLE1";
  -- GRANT ROLE "T122ROLE1" TO "DB__ROOT" WITH ADMIN OPTION;
GRANT ROLE
  "T122ROLE1" TO "SQL_USER1";

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>obey TEST122(t122sch1_cmds);
>>-- *** Perform basic dml against t122sch1
>>--    select
>>--    usage (sequence)
>>--    execute (translateBitmap)
>>-- ***
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER1                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch1;

--- SQL operation complete.
>>
>>select count(*) from games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>select count(*) from teams;

(EXPR)              
--------------------

                   5

--- 1 row(s) selected.
>>select count(*) from team_games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>select team_number, seqnum(team_seq) from teams;

TEAM_NUMBER  (EXPR)              
-----------  --------------------

          1                     6
          2                     7
          3                     8
          4                     9
          5                    10

--- 5 row(s) selected.
>>select distinct
+>   substring (schema_name,1,40) as schema_name,
+>   substring(grantor_name,1,10) as grantor,
+>   substring(grantee_name,1,10) as grantee,
+>   translateBitmap(privileges_bitmap) as granted_privs,
+>   translateBitmap(grantable_bitmap) as grantable_privs
+>from "_PRIVMGR_MD_".schema_privileges
+>where schema_uid in
+>     (select object_uid
+>      from "_MD_".objects
+>      where schema_name like 'T122SCH%')
+>  order by 1, 2, 3, 4, 5
+>;

--- 0 row(s) selected.
>>
>>grant select on schema t122sch1 to sql_user2 by t122role1;

--- SQL operation complete.
>>revoke select on schema t122sch1 from sql_user2 by t122role1;

--- SQL operation complete.
>>
>>-- test granting and revoking public
>>grant select, execute, usage on schema t122sch1 to public by t122role1;

--- SQL operation complete.
>>sh sqlci -i "TEST122(user_tests)" -u sql_user8;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER8                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>obey TEST122(t122sch1_cmds);
>>-- *** Perform basic dml against t122sch1
>>--    select
>>--    usage (sequence)
>>--    execute (translateBitmap)
>>-- ***
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER8                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch1;

--- SQL operation complete.
>>
>>select count(*) from games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>select count(*) from teams;

(EXPR)              
--------------------

                   5

--- 1 row(s) selected.
>>select count(*) from team_games;

(EXPR)              
--------------------

                   8

--- 1 row(s) selected.
>>select team_number, seqnum(team_seq) from teams;

TEAM_NUMBER  (EXPR)              
-----------  --------------------

          1                    76
          2                    77
          3                    78
          4                    79
          5                    80

--- 5 row(s) selected.
>>select distinct
+>   substring (schema_name,1,40) as schema_name,
+>   substring(grantor_name,1,10) as grantor,
+>   substring(grantee_name,1,10) as grantee,
+>   translateBitmap(privileges_bitmap) as granted_privs,
+>   translateBitmap(grantable_bitmap) as grantable_privs
+>from "_PRIVMGR_MD_".schema_privileges
+>where schema_uid in
+>     (select object_uid
+>      from "_MD_".objects
+>      where schema_name like 'T122SCH%')
+>  order by 1, 2, 3, 4, 5
+>;

SCHEMA_NAME                                                                                                                                                       GRANTOR                                   GRANTEE                                   GRANTED_PRIVS         GRANTABLE_PRIVS
----------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------  ----------------------------------------  --------------------  --------------------

TRAFODION.T122SCH1                                                                                                                                                T122ROLE1                                 PUBLIC                                    S---G-E               NONE                

--- 1 row(s) selected.
>>
>>showddl schema t122sch1;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH1 AUTHORIZATION T122ROLE1 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH1 TO T122ROLE1 WITH GRANT OPTION;
  GRANT SELECT, USAGE, EXECUTE ON SCHEMA TRAFODION.T122SCH1 TO PUBLIC;

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>revoke select, execute, usage on schema t122sch1 from public by t122role1;

--- SQL operation complete.
>>sh sqlci -i "TEST122(user_tests)" -u sql_user8;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER8                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>obey TEST122(t122sch1_cmds);
>>-- *** Perform basic dml against t122sch1
>>--    select
>>--    usage (sequence)
>>--    execute (translateBitmap)
>>-- ***
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER8                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch1;

--- SQL operation complete.
>>
>>select count(*) from games;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH1.GAMES.

*** ERROR[8822] The statement was not prepared.

>>select count(*) from teams;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH1.TEAMS.

*** ERROR[8822] The statement was not prepared.

>>select count(*) from team_games;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH1.TEAM_GAMES.

*** ERROR[8822] The statement was not prepared.

>>select team_number, seqnum(team_seq) from teams;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH1.TEAMS.

*** ERROR[4491] The user does not have USAGE privilege on sequence TRAFODION.T122SCH1.TEAM_SEQ.

*** ERROR[8822] The statement was not prepared.

>>select distinct
+>   substring (schema_name,1,40) as schema_name,
+>   substring(grantor_name,1,10) as grantor,
+>   substring(grantee_name,1,10) as grantee,
+>   translateBitmap(privileges_bitmap) as granted_privs,
+>   translateBitmap(grantable_bitmap) as grantable_privs
+>from "_PRIVMGR_MD_".schema_privileges
+>where schema_uid in
+>     (select object_uid
+>      from "_MD_".objects
+>      where schema_name like 'T122SCH%')
+>  order by 1, 2, 3, 4, 5
+>;

*** ERROR[4482] The user does not have EXECUTE privilege on user-defined routine TRAFODION.T122SCH1.TRANSLATEBITMAP.

*** ERROR[8822] The statement was not prepared.

>>
>>showddl schema t122sch1;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH1 AUTHORIZATION T122ROLE1 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH1 TO T122ROLE1 WITH GRANT OPTION;

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>
>>-- all privileges should be removed
>>showddl schema t122sch1;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH1 AUTHORIZATION T122ROLE1 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH1 TO T122ROLE1 WITH GRANT OPTION;

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>sh sqlci -i "TEST122(t122sch2_tests)" -u sql_user3;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER3                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>cqd AUTO_QUERY_RETRY_WARNINGS 'ON';

--- SQL operation complete.
>>set schema t122sch2;

--- SQL operation complete.
>>
>>-- sql_user3 -> can view all tables;
>>obey TEST122(t122sch2_cmds);
>>
>>-- *** Perform basic dml against t122sch2
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER3                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch2;

--- SQL operation complete.
>>
>>select count(*) from players;

(EXPR)              
--------------------

                  12

--- 1 row(s) selected.
>>select count(*) from standings;

(EXPR)              
--------------------

                   5

--- 1 row(s) selected.
>>update stats set num_players = num_players + 1;

--- 5 row(s) updated.
>>select * from stats;

TEAM_NUMBER  NUM_PLAYERS
-----------  -----------

          1           12
          2           13
          3           11
          4           14
          5           13

--- 5 row(s) selected.
>>
>>
>>-- sql_user3 -> grant select priv
>>grant select on schema t122sch2 to sql_user4 with grant option;

--- SQL operation complete.
>>
>>-- sql_user4 -> test schema privs and query invalidation
>>sh sqlci -i "TEST122(user4_tests)" -u sql_user4;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER4                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>cqd AUTO_QUERY_RETRY_WARNINGS 'ON';

--- SQL operation complete.
>>set schema t122sch2;

--- SQL operation complete.
>>
>>-- sql_user4 -> can select from objects
>>obey TEST122(t122sch2_cmds);
>>
>>-- *** Perform basic dml against t122sch2
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER4                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch2;

--- SQL operation complete.
>>
>>select count(*) from players;

(EXPR)              
--------------------

                  12

--- 1 row(s) selected.
>>select count(*) from standings;

(EXPR)              
--------------------

                   5

--- 1 row(s) selected.
>>update stats set num_players = num_players + 1;

*** ERROR[4481] The user does not have UPDATE privilege on table or view TRAFODION.T122SCH2.STATS.

*** ERROR[8822] The statement was not prepared.

>>select * from stats;

TEAM_NUMBER  NUM_PLAYERS
-----------  -----------

          1           12
          2           13
          3           11
          4           14
          5           13

--- 5 row(s) selected.
>>
>>
>>-- sql_user4 -> test privilege propagation
>>--    propagate select privilege
>>grant select on schema t122sch2 to sql_user5;

--- SQL operation complete.
>>grant select on schema t122sch2 to sql_user6 with grant option;

--- SQL operation complete.
>>showddl schema t122sch2;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH2 AUTHORIZATION SQL_USER3 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER3 WITH GRANT OPTION;
  GRANT SELECT ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER4 WITH GRANT OPTION;
  GRANT SELECT ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER5 GRANTED BY SQL_USER4;
  GRANT SELECT ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER6 WITH GRANT OPTION;

--- SQL operation complete.
>>
>>-- sql_user5 -> can access t122sch2 objects but not grant privs
>>sh sqlci -i "TEST122(user5_tests)" -u sql_user5;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER5                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>obey TEST122(t122sch2_cmds);
>>
>>-- *** Perform basic dml against t122sch2
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER5                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch2;

--- SQL operation complete.
>>
>>select count(*) from players;

(EXPR)              
--------------------

                  12

--- 1 row(s) selected.
>>select count(*) from standings;

(EXPR)              
--------------------

                   5

--- 1 row(s) selected.
>>update stats set num_players = num_players + 1;

*** ERROR[4481] The user does not have UPDATE privilege on table or view TRAFODION.T122SCH2.STATS.

*** ERROR[8822] The statement was not prepared.

>>select * from stats;

TEAM_NUMBER  NUM_PLAYERS
-----------  -----------

          1           12
          2           13
          3           11
          4           14
          5           13

--- 5 row(s) selected.
>>
>>grant select on schema t122sch2 to sql_user7;

*** ERROR[1012] No privileges were granted.  SQL_USER5 lacks grant option on the specified privileges.

--- SQL operation failed with errors.
>>showddl schema t122sch2;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH2 AUTHORIZATION SQL_USER3 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER3 WITH GRANT OPTION;
  GRANT SELECT ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER4 WITH GRANT OPTION;
  GRANT SELECT ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER5 GRANTED BY SQL_USER4;
  GRANT SELECT ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER6 WITH GRANT OPTION;

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>
>>-- sql_user6 -> can access t122sch2 objects and grant privs
>>sh sqlci -i "TEST122(user6_tests)" -u sql_user6;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER6                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>obey TEST122(t122sch2_cmds);
>>
>>-- *** Perform basic dml against t122sch2
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER6                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch2;

--- SQL operation complete.
>>
>>select count(*) from players;

(EXPR)              
--------------------

                  12

--- 1 row(s) selected.
>>select count(*) from standings;

(EXPR)              
--------------------

                   5

--- 1 row(s) selected.
>>update stats set num_players = num_players + 1;

*** ERROR[4481] The user does not have UPDATE privilege on table or view TRAFODION.T122SCH2.STATS.

*** ERROR[8822] The statement was not prepared.

>>select * from stats;

TEAM_NUMBER  NUM_PLAYERS
-----------  -----------

          1           12
          2           13
          3           11
          4           14
          5           13

--- 5 row(s) selected.
>>
>>grant select on schema t122sch2 to sql_user7;

--- SQL operation complete.
>>showddl schema t122sch2;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH2 AUTHORIZATION SQL_USER3 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER3 WITH GRANT OPTION;
  GRANT SELECT ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER4 WITH GRANT OPTION;
  GRANT SELECT ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER5 GRANTED BY SQL_USER4;
  GRANT SELECT ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER6 WITH GRANT OPTION;
  GRANT SELECT ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER7 GRANTED BY SQL_USER6;

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>
>>-- sql_user4 -> remove privileges from sql_user5, sql_user5 no long has priv
>>revoke select on schema t122sch2 from sql_user5;

--- SQL operation complete.
>>sh sqlci -i "TEST122(user5_tests)" -u sql_user5;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER5                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>obey TEST122(t122sch2_cmds);
>>
>>-- *** Perform basic dml against t122sch2
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER5                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch2;

--- SQL operation complete.
>>
>>select count(*) from players;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.PLAYERS.

*** ERROR[8822] The statement was not prepared.

>>select count(*) from standings;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.STANDINGS.

*** ERROR[8822] The statement was not prepared.

>>update stats set num_players = num_players + 1;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.STATS.

*** ERROR[4481] The user does not have UPDATE privilege on table or view TRAFODION.T122SCH2.STATS.

*** ERROR[8822] The statement was not prepared.

>>select * from stats;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.STATS.

*** ERROR[8822] The statement was not prepared.

>>
>>grant select on schema t122sch2 to sql_user7;

*** ERROR[1012] No privileges were granted.  SQL_USER5 lacks grant option on the specified privileges.

--- SQL operation failed with errors.
>>showddl schema t122sch2;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH2 AUTHORIZATION SQL_USER3 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER3 WITH GRANT OPTION;
  GRANT SELECT ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER4 WITH GRANT OPTION;
  GRANT SELECT ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER6 WITH GRANT OPTION;
  GRANT SELECT ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER7 GRANTED BY SQL_USER6;

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>
>>-- sql_user4 -> remove privileges from sql_user6, 
>>--    fails, sql_user6 granted privileges to sql_user7
>>--    and user4 cannot revoke it (until we support cascade)
>>revoke grant option for select on schema t122sch2 from sql_user6;

*** ERROR[1037] Revoke failed because of a dependent grant between authorization ID SQL_USER6 and authorization ID SQL_USER7.

--- SQL operation failed with errors.
>>revoke select on schema t122sch2 from sql_user7 by sql_user6;

*** ERROR[1017] You are not authorized to perform this operation.

--- SQL operation failed with errors.
>>
>>-- sql_user6 ->  revoke the privilege
>>sh sqlci -i "TEST122(user6_revoke)" -u sql_user6;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER6                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>revoke select on schema t122sch2 from sql_user7;

--- SQL operation complete.
>>showddl schema t122sch2;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH2 AUTHORIZATION SQL_USER3 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER3 WITH GRANT OPTION;
  GRANT SELECT ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER4 WITH GRANT OPTION;
  GRANT SELECT ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER6 WITH GRANT OPTION;

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>
>>-- sql_user4 -> can now revoke privileges from sql_user6, first revoke
>>--    the GOF
>>revoke grant option for select on schema t122sch2 from sql_user6;

--- SQL operation complete.
>>showddl schema t122sch2;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH2 AUTHORIZATION SQL_USER3 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER3 WITH GRANT OPTION;
  GRANT SELECT ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER4 WITH GRANT OPTION;
  GRANT SELECT ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER6 GRANTED BY SQL_USER4;

--- SQL operation complete.
>>
>>-- sql_user4 -> revoke remaining privileges
>>revoke select on schema t122sch2 from sql_user6;

--- SQL operation complete.
>>showddl schema t122sch2;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH2 AUTHORIZATION SQL_USER3 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER3 WITH GRANT OPTION;
  GRANT SELECT ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER4 WITH GRANT OPTION;

--- SQL operation complete.
>>
>>-- sql_user3 -> test query invalidation, revoke privs from sql_user4 in 
>>--    another process
>>sh sqlci -i "TEST122(revoke_privs)" -u sql_user3;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER3                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>revoke select, insert, update, delete on schema t122sch2 from sql_user4;

--- SQL operation complete.
>>showddl schema t122sch2;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH2 AUTHORIZATION SQL_USER3 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER3 WITH GRANT OPTION;

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>
>>-- sql_user4 -> no longer has privs through the object
>>obey TEST122(t122sch2_cmds);
>>
>>-- *** Perform basic dml against t122sch2
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER4                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch2;

--- SQL operation complete.
>>
>>select count(*) from players;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.PLAYERS.

*** ERROR[8822] The statement was not prepared.

>>select count(*) from standings;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.STANDINGS.

*** ERROR[8822] The statement was not prepared.

>>update stats set num_players = num_players + 1;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.STATS.

*** ERROR[4481] The user does not have UPDATE privilege on table or view TRAFODION.T122SCH2.STATS.

*** ERROR[8822] The statement was not prepared.

>>select * from stats;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.STATS.

*** ERROR[8822] The statement was not prepared.

>>
>>
>>-- sql_user3 -> grant schema, object, and column privileges to sql_user4
>>sh sqlci -i "TEST122(grant_privs)" -u sql_user3;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER3                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>set schema t122sch2;

--- SQL operation complete.
>>
>>grant select, insert, update, delete on schema t122sch2 to sql_user4;

--- SQL operation complete.
>>grant select on players to sql_user4;

--- SQL operation complete.
>>grant select(team_number,num_players), update on stats to sql_user4;

--- SQL operation complete.
>>showddl schema t122sch2;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH2 AUTHORIZATION SQL_USER3 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER3 WITH GRANT OPTION;
  GRANT SELECT, INSERT, DELETE, UPDATE ON SCHEMA TRAFODION.T122SCH2 TO
  SQL_USER4;

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>
>>-- sql_user4 -> can now access objects
>>obey TEST122(t122sch2_cmds);
>>
>>-- *** Perform basic dml against t122sch2
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER4                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch2;

--- SQL operation complete.
>>
>>select count(*) from players;

(EXPR)              
--------------------

                  12

--- 1 row(s) selected.
>>select count(*) from standings;

(EXPR)              
--------------------

                   5

--- 1 row(s) selected.
>>update stats set num_players = num_players + 1;

--- 5 row(s) updated.
>>select * from stats;

TEAM_NUMBER  NUM_PLAYERS
-----------  -----------

          1           13
          2           14
          3           12
          4           15
          5           14

--- 5 row(s) selected.
>>
>>
>>-- sql_user3 -> revoke schema privileges, 
>>--    no longer able to select from standings or stats
>>--    can select from players and update stats
>>sh sqlci -i "TEST122(revoke_privs)" -u sql_user3;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER3                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>revoke select, insert, update, delete on schema t122sch2 from sql_user4;

--- SQL operation complete.
>>showddl schema t122sch2;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH2 AUTHORIZATION SQL_USER3 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER3 WITH GRANT OPTION;

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>obey TEST122(t122sch2_cmds);
>>
>>-- *** Perform basic dml against t122sch2
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER4                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch2;

--- SQL operation complete.
>>
>>select count(*) from players;

(EXPR)              
--------------------

                  12

--- 1 row(s) selected.
>>select count(*) from standings;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.STANDINGS.

*** ERROR[8822] The statement was not prepared.

>>update stats set num_players = num_players + 1;

--- 5 row(s) updated.
>>select * from stats;

TEAM_NUMBER  NUM_PLAYERS
-----------  -----------

          1           14
          2           15
          3           13
          4           16
          5           15

--- 5 row(s) selected.
>>
>>
>>exit;

End of MXCI Session

>>
>>-- sql_user3 -> cleanup remaining privileges for previous test
>>revoke all on players from sql_user4;

--- SQL operation complete.
>>revoke select(num_players, team_number), update on stats from sql_user4;

--- SQL operation complete.
>>
>>-- sql_user7 -> test qi for public privilege
>>sh sqlci -i "TEST122(user7_tests)" -u sql_user7;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER7                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>-- fails - has no privilege
>>obey TEST122(t122sch2_cmds);
>>
>>-- *** Perform basic dml against t122sch2
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER7                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch2;

--- SQL operation complete.
>>
>>select count(*) from players;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.PLAYERS.

*** ERROR[8822] The statement was not prepared.

>>select count(*) from standings;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.STANDINGS.

*** ERROR[8822] The statement was not prepared.

>>update stats set num_players = num_players + 1;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.STATS.

*** ERROR[4481] The user does not have UPDATE privilege on table or view TRAFODION.T122SCH2.STATS.

*** ERROR[8822] The statement was not prepared.

>>select * from stats;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.STATS.

*** ERROR[8822] The statement was not prepared.

>>
>>
>>-- grant to public, test should work
>>sh sqlci -i "TEST122(grant_public)";
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

DB__ROOT                                                                                                                        

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>grant select, insert, update, delete on schema t122sch2 to public;

--- SQL operation complete.
>>showddl schema t122sch2;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH2 AUTHORIZATION SQL_USER3 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER3 WITH GRANT OPTION;
  GRANT SELECT, INSERT, DELETE, UPDATE ON SCHEMA TRAFODION.T122SCH2 TO PUBLIC;

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>obey TEST122(t122sch2_cmds);
>>
>>-- *** Perform basic dml against t122sch2
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER7                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch2;

--- SQL operation complete.
>>
>>select count(*) from players;

(EXPR)              
--------------------

                  12

--- 1 row(s) selected.
>>select count(*) from standings;

(EXPR)              
--------------------

                   5

--- 1 row(s) selected.
>>update stats set num_players = num_players + 1;

--- 5 row(s) updated.
>>select * from stats;

TEAM_NUMBER  NUM_PLAYERS
-----------  -----------

          1           15
          2           16
          3           14
          4           17
          5           16

--- 5 row(s) selected.
>>
>>
>>-- revoke from public, tests should fail
>>sh sqlci -i "TEST122(revoke_public)";
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

DB__ROOT                                                                                                                        

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>revoke select, insert, update, delete on schema t122sch2 from public;

--- SQL operation complete.
>>showddl schema t122sch2;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH2 AUTHORIZATION SQL_USER3 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER3 WITH GRANT OPTION;

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>obey TEST122(t122sch2_cmds);
>>
>>-- *** Perform basic dml against t122sch2
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER7                                                                                                                       

--- 1 row(s) selected.
>>set schema t122sch2;

--- SQL operation complete.
>>
>>select count(*) from players;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.PLAYERS.

*** ERROR[8822] The statement was not prepared.

>>select count(*) from standings;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.STANDINGS.

*** ERROR[8822] The statement was not prepared.

>>update stats set num_players = num_players + 1;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.STATS.

*** ERROR[4481] The user does not have UPDATE privilege on table or view TRAFODION.T122SCH2.STATS.

*** ERROR[8822] The statement was not prepared.

>>select * from stats;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.STATS.

*** ERROR[8822] The statement was not prepared.

>>
>>
>>exit;

End of MXCI Session

>>
>>-- sql_user3 -> should have only creator privileges
>>showddl schema t122sch2;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH2 AUTHORIZATION SQL_USER3 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER3 WITH GRANT OPTION;

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>revoke role t122role1 from sql_user1;

--- SQL operation complete.
>>
>>obey TEST122(ddl_tests);
>>--  Tests create, alter, and drop privileges at the schema level
>>set schema t122sch2;

--- SQL operation complete.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>showddl schema t122sch2;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH2 AUTHORIZATION SQL_USER3 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER3 WITH GRANT OPTION;

--- SQL operation complete.
>>
>>drop table if exists teams;

--- SQL operation complete.
>>create table if not exists teams
+>  (team_number int not null primary key,
+>   team_name char(20) not null,
+>   team_contact varchar(50) not null,
+>   team_contact_number char (10) not null
+>   )
+>  ;

--- SQL operation complete.
>>grant select on teams to sql_user5;

--- SQL operation complete.
>>drop table if exists games;

--- SQL operation complete.
>>create table if not exists games
+>   ( home_team_number int not null,
+>     visitor_team_number int not null,
+>     game_number int not null primary key,
+>     game_time timestamp not null,
+>     game_location varchar(50) not null)
+>  ;

--- SQL operation complete.
>>drop table if exists players;

--- SQL operation complete.
>>create table if not exists standings
+>    (team_number int not null primary key,
+>     wins int default 0,
+>     loses int default 0,
+>     last_updated timestamp default current_timestamp);

--- SQL operation complete.
>>grant create, alter, drop on schema t122sch2 to sql_user5;

--- SQL operation complete.
>>showddl schema t122sch2;

CREATE PRIVATE SCHEMA TRAFODION.T122SCH2 AUTHORIZATION SQL_USER3 NAMESPACE
  'TRAF_1500000' ;
-- GRANT SELECT, INSERT, DELETE, UPDATE, USAGE, REFERENCES, EXECUTE, CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER3 WITH GRANT OPTION;
  GRANT CREATE, ALTER, DROP ON SCHEMA TRAFODION.T122SCH2 TO SQL_USER5;

--- SQL operation complete.
>>
>>get privileges on table teams;

Privileges on Table T122SCH2.TEAMS
==================================

SIDU-R--AD    (object-grant) SQL_USER3
S---------    (object-grant) SQL_USER5
--------AD    (schema-grant) SQL_USER5

=======================
 3 row(s) returned

--- SQL operation complete.
>>get privileges on table games;

Privileges on Table T122SCH2.GAMES
==================================

SIDU-R--AD    (object-grant) SQL_USER3
--------AD    (schema-grant) SQL_USER5

=======================
 2 row(s) returned

--- SQL operation complete.
>>get privileges on table players;

--- SQL operation complete.
>>get privileges on table standings;

Privileges on Table T122SCH2.STANDINGS
======================================

SIDU-R--AD    (object-grant) SQL_USER3
--------AD    (schema-grant) SQL_USER5

=======================
 2 row(s) returned

--- SQL operation complete.
>>get privileges for user sql_user5, match '%T122SCH2%';

Privileges for User SQL_USER5
=============================

-------CAD    TRAFODION.T122SCH2
S---------    TRAFODION.T122SCH2.TEAMS

=======================
 2 row(s) returned

--- SQL operation complete.
>>
>>-- sql_user5 can perform all schema_ops
>>sh sqlci -i "TEST122(schema_ops)" -u sql_user5;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER5                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>set schema t122sch2;

--- SQL operation complete.
>>get privileges for user sql_user5, match '%T122SCH2%';

Privileges for User SQL_USER5
=============================

-------CAD    TRAFODION.T122SCH2
S---------    TRAFODION.T122SCH2.TEAMS

=======================
 2 row(s) returned

--- SQL operation complete.
>>
>>-- schema level CREATE
>>create view home_teams as
+>  select team_number from teams;

--- SQL operation complete.
>>
>>-- Cannot create view because of no SELECT priv
>>create view home_teams_games as
+>  select t.team_number, g.game_number, g.game_time
+>  from "TEAMS" t,
+>       "GAMES" g
+>  where t.team_number = g.home_team_number
+>  order by 1, game_number, game_time;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.GAMES.

--- SQL operation failed with errors.
>>
>>-- schema level CREATE
>>create table players
+>  (player_number int not null,
+>   player_name varchar (50) not null,
+>   player_team_number int not null,
+>   player_phone_number char (10) not null,
+>   player_details varchar(50),
+>   primary key (player_number, player_team_number))
+>  no partition;

--- SQL operation complete.
>>
>>create sequence players_sequence;

--- SQL operation complete.
>>get objects for user sql_user5, match '%T122SCH2%';

Objects for User SQL_USER5
==========================

BT TRAFODION.T122SCH2.GAMES
BT TRAFODION.T122SCH2.PLAYERS
BT TRAFODION.T122SCH2.SB_HISTOGRAMS
BT TRAFODION.T122SCH2.SB_HISTOGRAM_INTERVALS
BT TRAFODION.T122SCH2.SB_PERSISTENT_SAMPLES
BT TRAFODION.T122SCH2.STANDINGS
BT TRAFODION.T122SCH2.STATS
BT TRAFODION.T122SCH2.TEAMS
SG TRAFODION.T122SCH2.PLAYERS_SEQUENCE
VI TRAFODION.T122SCH2.HOME_TEAMS

=======================
 10 row(s) returned

--- SQL operation complete.
>>
>>-- schema level ALTER
>>showddl games;

CREATE TABLE TRAFODION.T122SCH2.GAMES
  (
    HOME_TEAM_NUMBER                 INT NO DEFAULT NOT NULL NOT DROPPABLE
  , VISITOR_TEAM_NUMBER              INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_NUMBER                      INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_TIME                        TIMESTAMP(6) NO DEFAULT NOT NULL NOT
      DROPPABLE
  , GAME_LOCATION                    VARCHAR(50) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (GAME_NUMBER ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

-- GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES, ALTER, DROP ON TRAFODION.T122SCH2.GAMES TO SQL_USER3 WITH GRANT OPTION;

--- SQL operation complete.
>>alter table games add constraint valid_game_number check (game_number > 0);

--- SQL operation complete.
>>showddl games;

CREATE TABLE TRAFODION.T122SCH2.GAMES
  (
    HOME_TEAM_NUMBER                 INT NO DEFAULT NOT NULL NOT DROPPABLE
  , VISITOR_TEAM_NUMBER              INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_NUMBER                      INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_TIME                        TIMESTAMP(6) NO DEFAULT NOT NULL NOT
      DROPPABLE
  , GAME_LOCATION                    VARCHAR(50) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (GAME_NUMBER ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

ALTER TABLE TRAFODION.T122SCH2.GAMES ADD CONSTRAINT
  TRAFODION.T122SCH2.VALID_GAME_NUMBER CHECK
  (TRAFODION.T122SCH2.GAMES.GAME_NUMBER > 0)
;

-- GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES, ALTER, DROP ON TRAFODION.T122SCH2.GAMES TO SQL_USER3 WITH GRANT OPTION;

--- SQL operation complete.
>>alter table games drop constraint valid_game_number;

--- SQL operation complete.
>>
>>-- schema level DROP
>>drop table standings;

--- SQL operation complete.
>>drop view home_teams;

--- SQL operation complete.
>>drop table players;

--- SQL operation complete.
>>drop sequence players_sequence;

--- SQL operation complete.
>>get objects for user sql_user5, match '%T122SCH2%';

Objects for User SQL_USER5
==========================

BT TRAFODION.T122SCH2.GAMES
BT TRAFODION.T122SCH2.SB_HISTOGRAMS
BT TRAFODION.T122SCH2.SB_HISTOGRAM_INTERVALS
BT TRAFODION.T122SCH2.SB_PERSISTENT_SAMPLES
BT TRAFODION.T122SCH2.STATS
BT TRAFODION.T122SCH2.TEAMS

=======================
 6 row(s) returned

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>obey TEST122(reset_objs);
>>drop view if exists home_teams_games;

--- SQL operation complete.
>>drop view if exists home_teams;

--- SQL operation complete.
>>drop table if exists players;

--- SQL operation complete.
>>drop table if exists standings;

--- SQL operation complete.
>>create table standings
+>    (team_number int not null primary key,
+>     wins int default 0,
+>     loses int default 0,
+>     last_updated timestamp default current_timestamp);

--- SQL operation complete.
>>drop sequence players_sequence;

*** ERROR[1389] Object TRAFODION.T122SCH2.PLAYERS_SEQUENCE does not exist in Trafodion.

--- SQL operation failed with errors.
>>
>>
>>-- sql_user5 cannot alter games
>>revoke alter on schema t122sch2 from sql_user5;

--- SQL operation complete.
>>sh sqlci -i "TEST122(schema_ops)" -u sql_user5;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER5                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>set schema t122sch2;

--- SQL operation complete.
>>get privileges for user sql_user5, match '%T122SCH2%';

Privileges for User SQL_USER5
=============================

-------C-D    TRAFODION.T122SCH2
S---------    TRAFODION.T122SCH2.TEAMS

=======================
 2 row(s) returned

--- SQL operation complete.
>>
>>-- schema level CREATE
>>create view home_teams as
+>  select team_number from teams;

--- SQL operation complete.
>>
>>-- Cannot create view because of no SELECT priv
>>create view home_teams_games as
+>  select t.team_number, g.game_number, g.game_time
+>  from "TEAMS" t,
+>       "GAMES" g
+>  where t.team_number = g.home_team_number
+>  order by 1, game_number, game_time;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.GAMES.

--- SQL operation failed with errors.
>>
>>-- schema level CREATE
>>create table players
+>  (player_number int not null,
+>   player_name varchar (50) not null,
+>   player_team_number int not null,
+>   player_phone_number char (10) not null,
+>   player_details varchar(50),
+>   primary key (player_number, player_team_number))
+>  no partition;

--- SQL operation complete.
>>
>>create sequence players_sequence;

--- SQL operation complete.
>>get objects for user sql_user5, match '%T122SCH2%';

Objects for User SQL_USER5
==========================

BT TRAFODION.T122SCH2.GAMES
BT TRAFODION.T122SCH2.PLAYERS
BT TRAFODION.T122SCH2.SB_HISTOGRAMS
BT TRAFODION.T122SCH2.SB_HISTOGRAM_INTERVALS
BT TRAFODION.T122SCH2.SB_PERSISTENT_SAMPLES
BT TRAFODION.T122SCH2.STANDINGS
BT TRAFODION.T122SCH2.STATS
BT TRAFODION.T122SCH2.TEAMS
SG TRAFODION.T122SCH2.PLAYERS_SEQUENCE
VI TRAFODION.T122SCH2.HOME_TEAMS

=======================
 10 row(s) returned

--- SQL operation complete.
>>
>>-- schema level ALTER
>>showddl games;

CREATE TABLE TRAFODION.T122SCH2.GAMES
  (
    HOME_TEAM_NUMBER                 INT NO DEFAULT NOT NULL NOT DROPPABLE
  , VISITOR_TEAM_NUMBER              INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_NUMBER                      INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_TIME                        TIMESTAMP(6) NO DEFAULT NOT NULL NOT
      DROPPABLE
  , GAME_LOCATION                    VARCHAR(50) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (GAME_NUMBER ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

-- GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES, ALTER, DROP ON TRAFODION.T122SCH2.GAMES TO SQL_USER3 WITH GRANT OPTION;

--- SQL operation complete.
>>alter table games add constraint valid_game_number check (game_number > 0);

*** ERROR[1017] You are not authorized to perform this operation.

--- SQL operation failed with errors.
>>showddl games;

CREATE TABLE TRAFODION.T122SCH2.GAMES
  (
    HOME_TEAM_NUMBER                 INT NO DEFAULT NOT NULL NOT DROPPABLE
  , VISITOR_TEAM_NUMBER              INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_NUMBER                      INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_TIME                        TIMESTAMP(6) NO DEFAULT NOT NULL NOT
      DROPPABLE
  , GAME_LOCATION                    VARCHAR(50) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (GAME_NUMBER ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

-- GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES, ALTER, DROP ON TRAFODION.T122SCH2.GAMES TO SQL_USER3 WITH GRANT OPTION;

--- SQL operation complete.
>>alter table games drop constraint valid_game_number;

*** ERROR[1017] You are not authorized to perform this operation.

--- SQL operation failed with errors.
>>
>>-- schema level DROP
>>drop table standings;

--- SQL operation complete.
>>drop view home_teams;

--- SQL operation complete.
>>drop table players;

--- SQL operation complete.
>>drop sequence players_sequence;

--- SQL operation complete.
>>get objects for user sql_user5, match '%T122SCH2%';

Objects for User SQL_USER5
==========================

BT TRAFODION.T122SCH2.GAMES
BT TRAFODION.T122SCH2.SB_HISTOGRAMS
BT TRAFODION.T122SCH2.SB_HISTOGRAM_INTERVALS
BT TRAFODION.T122SCH2.SB_PERSISTENT_SAMPLES
BT TRAFODION.T122SCH2.STATS
BT TRAFODION.T122SCH2.TEAMS

=======================
 6 row(s) returned

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>obey TEST122(reset_objs);
>>drop view if exists home_teams_games;

--- SQL operation complete.
>>drop view if exists home_teams;

--- SQL operation complete.
>>drop table if exists players;

--- SQL operation complete.
>>drop table if exists standings;

--- SQL operation complete.
>>create table standings
+>    (team_number int not null primary key,
+>     wins int default 0,
+>     loses int default 0,
+>     last_updated timestamp default current_timestamp);

--- SQL operation complete.
>>drop sequence players_sequence;

*** ERROR[1389] Object TRAFODION.T122SCH2.PLAYERS_SEQUENCE does not exist in Trafodion.

--- SQL operation failed with errors.
>>
>>
>>-- sql_user5 can drop their tables but cannot drop other tables
>>revoke drop on schema t122sch2 from sql_user5;

--- SQL operation complete.
>>sh sqlci -i "TEST122(schema_ops)" -u sql_user5;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER5                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>set schema t122sch2;

--- SQL operation complete.
>>get privileges for user sql_user5, match '%T122SCH2%';

Privileges for User SQL_USER5
=============================

-------C--    TRAFODION.T122SCH2
S---------    TRAFODION.T122SCH2.TEAMS

=======================
 2 row(s) returned

--- SQL operation complete.
>>
>>-- schema level CREATE
>>create view home_teams as
+>  select team_number from teams;

--- SQL operation complete.
>>
>>-- Cannot create view because of no SELECT priv
>>create view home_teams_games as
+>  select t.team_number, g.game_number, g.game_time
+>  from "TEAMS" t,
+>       "GAMES" g
+>  where t.team_number = g.home_team_number
+>  order by 1, game_number, game_time;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.GAMES.

--- SQL operation failed with errors.
>>
>>-- schema level CREATE
>>create table players
+>  (player_number int not null,
+>   player_name varchar (50) not null,
+>   player_team_number int not null,
+>   player_phone_number char (10) not null,
+>   player_details varchar(50),
+>   primary key (player_number, player_team_number))
+>  no partition;

--- SQL operation complete.
>>
>>create sequence players_sequence;

--- SQL operation complete.
>>get objects for user sql_user5, match '%T122SCH2%';

Objects for User SQL_USER5
==========================

BT TRAFODION.T122SCH2.GAMES
BT TRAFODION.T122SCH2.PLAYERS
BT TRAFODION.T122SCH2.SB_HISTOGRAMS
BT TRAFODION.T122SCH2.SB_HISTOGRAM_INTERVALS
BT TRAFODION.T122SCH2.SB_PERSISTENT_SAMPLES
BT TRAFODION.T122SCH2.STANDINGS
BT TRAFODION.T122SCH2.STATS
BT TRAFODION.T122SCH2.TEAMS
SG TRAFODION.T122SCH2.PLAYERS_SEQUENCE
VI TRAFODION.T122SCH2.HOME_TEAMS

=======================
 10 row(s) returned

--- SQL operation complete.
>>
>>-- schema level ALTER
>>showddl games;

CREATE TABLE TRAFODION.T122SCH2.GAMES
  (
    HOME_TEAM_NUMBER                 INT NO DEFAULT NOT NULL NOT DROPPABLE
  , VISITOR_TEAM_NUMBER              INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_NUMBER                      INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_TIME                        TIMESTAMP(6) NO DEFAULT NOT NULL NOT
      DROPPABLE
  , GAME_LOCATION                    VARCHAR(50) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (GAME_NUMBER ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

-- GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES, ALTER, DROP ON TRAFODION.T122SCH2.GAMES TO SQL_USER3 WITH GRANT OPTION;

--- SQL operation complete.
>>alter table games add constraint valid_game_number check (game_number > 0);

*** ERROR[1017] You are not authorized to perform this operation.

--- SQL operation failed with errors.
>>showddl games;

CREATE TABLE TRAFODION.T122SCH2.GAMES
  (
    HOME_TEAM_NUMBER                 INT NO DEFAULT NOT NULL NOT DROPPABLE
  , VISITOR_TEAM_NUMBER              INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_NUMBER                      INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_TIME                        TIMESTAMP(6) NO DEFAULT NOT NULL NOT
      DROPPABLE
  , GAME_LOCATION                    VARCHAR(50) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (GAME_NUMBER ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

-- GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES, ALTER, DROP ON TRAFODION.T122SCH2.GAMES TO SQL_USER3 WITH GRANT OPTION;

--- SQL operation complete.
>>alter table games drop constraint valid_game_number;

*** ERROR[1017] You are not authorized to perform this operation.

--- SQL operation failed with errors.
>>
>>-- schema level DROP
>>drop table standings;

*** ERROR[1017] You are not authorized to perform this operation.

--- SQL operation failed with errors.
>>drop view home_teams;

--- SQL operation complete.
>>drop table players;

--- SQL operation complete.
>>drop sequence players_sequence;

--- SQL operation complete.
>>get objects for user sql_user5, match '%T122SCH2%';

Objects for User SQL_USER5
==========================

BT TRAFODION.T122SCH2.GAMES
BT TRAFODION.T122SCH2.SB_HISTOGRAMS
BT TRAFODION.T122SCH2.SB_HISTOGRAM_INTERVALS
BT TRAFODION.T122SCH2.SB_PERSISTENT_SAMPLES
BT TRAFODION.T122SCH2.STANDINGS
BT TRAFODION.T122SCH2.STATS
BT TRAFODION.T122SCH2.TEAMS

=======================
 7 row(s) returned

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>obey TEST122(reset_objs);
>>drop view if exists home_teams_games;

--- SQL operation complete.
>>drop view if exists home_teams;

--- SQL operation complete.
>>drop table if exists players;

--- SQL operation complete.
>>drop table if exists standings;

--- SQL operation complete.
>>create table standings
+>    (team_number int not null primary key,
+>     wins int default 0,
+>     loses int default 0,
+>     last_updated timestamp default current_timestamp);

--- SQL operation complete.
>>drop sequence players_sequence;

*** ERROR[1389] Object TRAFODION.T122SCH2.PLAYERS_SEQUENCE does not exist in Trafodion.

--- SQL operation failed with errors.
>>
>>
>>-- sql_user5 cannot do anything
>>revoke create on schema t122sch2 from sql_user5;

--- SQL operation complete.
>>sh sqlci -i "TEST122(schema_ops)" -u sql_user5;
>>values (current_user);

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------

SQL_USER5                                                                                                                       

--- 1 row(s) selected.
>>cqd SHOWDDL_DISPLAY_PRIVILEGE_GRANTS 'ON';

--- SQL operation complete.
>>
>>set schema t122sch2;

--- SQL operation complete.
>>get privileges for user sql_user5, match '%T122SCH2%';

Privileges for User SQL_USER5
=============================

S---------    TRAFODION.T122SCH2.TEAMS

=======================
 1 row(s) returned

--- SQL operation complete.
>>
>>-- schema level CREATE
>>create view home_teams as
+>  select team_number from teams;

*** ERROR[1017] You are not authorized to perform this operation.

--- SQL operation failed with errors.
>>
>>-- Cannot create view because of no SELECT priv
>>create view home_teams_games as
+>  select t.team_number, g.game_number, g.game_time
+>  from "TEAMS" t,
+>       "GAMES" g
+>  where t.team_number = g.home_team_number
+>  order by 1, game_number, game_time;

*** ERROR[4481] The user does not have SELECT privilege on table or view TRAFODION.T122SCH2.GAMES.

--- SQL operation failed with errors.
>>
>>-- schema level CREATE
>>create table players
+>  (player_number int not null,
+>   player_name varchar (50) not null,
+>   player_team_number int not null,
+>   player_phone_number char (10) not null,
+>   player_details varchar(50),
+>   primary key (player_number, player_team_number))
+>  no partition;

*** ERROR[1017] You are not authorized to perform this operation.

--- SQL operation failed with errors.
>>
>>create sequence players_sequence;

*** ERROR[1017] You are not authorized to perform this operation.

--- SQL operation failed with errors.
>>get objects for user sql_user5, match '%T122SCH2%';

Objects for User SQL_USER5
==========================

BT TRAFODION.T122SCH2.TEAMS

=======================
 1 row(s) returned

--- SQL operation complete.
>>
>>-- schema level ALTER
>>showddl games;

CREATE TABLE TRAFODION.T122SCH2.GAMES
  (
    HOME_TEAM_NUMBER                 INT NO DEFAULT NOT NULL NOT DROPPABLE
  , VISITOR_TEAM_NUMBER              INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_NUMBER                      INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_TIME                        TIMESTAMP(6) NO DEFAULT NOT NULL NOT
      DROPPABLE
  , GAME_LOCATION                    VARCHAR(50) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (GAME_NUMBER ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

-- GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES, ALTER, DROP ON TRAFODION.T122SCH2.GAMES TO SQL_USER3 WITH GRANT OPTION;

--- SQL operation complete.
>>alter table games add constraint valid_game_number check (game_number > 0);

*** ERROR[1017] You are not authorized to perform this operation.

--- SQL operation failed with errors.
>>showddl games;

CREATE TABLE TRAFODION.T122SCH2.GAMES
  (
    HOME_TEAM_NUMBER                 INT NO DEFAULT NOT NULL NOT DROPPABLE
  , VISITOR_TEAM_NUMBER              INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_NUMBER                      INT NO DEFAULT NOT NULL NOT DROPPABLE
  , GAME_TIME                        TIMESTAMP(6) NO DEFAULT NOT NULL NOT
      DROPPABLE
  , GAME_LOCATION                    VARCHAR(50) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (GAME_NUMBER ASC)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

-- GRANT SELECT, INSERT, DELETE, UPDATE, REFERENCES, ALTER, DROP ON TRAFODION.T122SCH2.GAMES TO SQL_USER3 WITH GRANT OPTION;

--- SQL operation complete.
>>alter table games drop constraint valid_game_number;

*** ERROR[1017] You are not authorized to perform this operation.

--- SQL operation failed with errors.
>>
>>-- schema level DROP
>>drop table standings;

*** ERROR[1017] You are not authorized to perform this operation.

--- SQL operation failed with errors.
>>drop view home_teams;

*** ERROR[1389] Object TRAFODION.T122SCH2.HOME_TEAMS does not exist in Trafodion.

--- SQL operation failed with errors.
>>drop table players;

*** ERROR[1389] Object TRAFODION.T122SCH2.PLAYERS does not exist in Trafodion.

--- SQL operation failed with errors.
>>drop sequence players_sequence;

*** ERROR[1389] Object TRAFODION.T122SCH2.PLAYERS_SEQUENCE does not exist in Trafodion.

--- SQL operation failed with errors.
>>get objects for user sql_user5, match '%T122SCH2%';

Objects for User SQL_USER5
==========================

BT TRAFODION.T122SCH2.TEAMS

=======================
 1 row(s) returned

--- SQL operation complete.
>>
>>exit;

End of MXCI Session

>>obey TEST122(reset_objs);
>>drop view if exists home_teams_games;

--- SQL operation complete.
>>drop view if exists home_teams;

--- SQL operation complete.
>>drop table if exists players;

--- SQL operation complete.
>>drop table if exists standings;

--- SQL operation complete.
>>create table standings
+>    (team_number int not null primary key,
+>     wins int default 0,
+>     loses int default 0,
+>     last_updated timestamp default current_timestamp);

--- SQL operation complete.
>>drop sequence players_sequence;

*** ERROR[1389] Object TRAFODION.T122SCH2.PLAYERS_SEQUENCE does not exist in Trafodion.

--- SQL operation failed with errors.
>>
>>
>>-- fails, DDL privileges don't support WGO
>>grant create on schema t122sch2 to sql_user5 with grant option;

*** ERROR[1007] The WITH GRANT OPTION is not supported.

--- SQL operation failed with errors.
>>
>>log;
