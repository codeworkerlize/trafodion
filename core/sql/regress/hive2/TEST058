-- Tests for native Parquet reader
--
-- @@@ START COPYRIGHT @@@
--
--(C) Copyright 2016-2018 Esgyn Corporation
--
-- @@@ END COPYRIGHT @@@


log LOG058 clear;

sh filter_test >> LOG058;

set schema hive.hive;

cqd parquet_use_cpp_reader 'on';
cqd PARQUET_CPP_READER_PARALLELISM '10';

cqd GEN_HSHJ_MIN_MAX_OPT 'ON';

cqd HJ_BROADCAST_INNER_THRESHOLD_MB '0.01';
cqd RANGE_OPTIMIZED_SCAN '500000';

cqd parallel_num_esps '4';

cqd HIST_MISSING_STATS_WARNING_LEVEL '0';

-----------------------------------------------
-- test joins
-----------------------------------------------
prepare xx from 
select count(*) from 
date_dim_parquet
, store_sales_parquet_p << + cardinality 10e7 >>
    where ss_sold_date_sk = d_date_sk 
;

explain options 'p' xx;
execute xx;

-- join on char column

cqd parallel_num_esps '1';

prepare xx from 
select count(*) from 
date_dim_parquet S,
date_dim_parquet T <<+ cardinality 10e7 >> 
    where S.d_date_id = T.d_date_id
;

explain options 'p' xx;
execute xx;

cqd parallel_num_esps '4';

-----------------------------------------------
-- test full scan, with scan predicate A
-----------------------------------------------
prepare xx from 
select count(*) from 
store_sales_parquet_p << + cardinality 10e7 >>
  where ss_sold_time_sk <= 40000 --[28800, 75599]
;

explain options 'p' xx;
execute xx;

-----------------------------------------------
-- test full scan, with scan predicate B
-----------------------------------------------
prepare xx from 
select count(*) from 
store_sales_parquet_p << + cardinality 10e7 >>
    where ss_sold_time_sk <= 60000 --[28800, 75599]
;

explain options 'p' xx;
execute xx;

---------------------------------------
-- test direct copy
---------------------------------------
cqd PARQUET_CPP_READER_DIRECT_COPY 'ON';
cqd parallel_num_esps '1';

prepare xx from 
select [first 10]
d_date_sk, cast(d_day_name as char(20)), cast(d_date_id as char(20))
from date_dim_parquet
order by 1, 2, 3
;

execute xx;

prepare xx from 
select [first 10]
cast(i_current_price as char(20))
from item_parquet
order by 1
;

execute xx;



