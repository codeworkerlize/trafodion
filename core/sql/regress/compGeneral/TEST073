-- Test: TEST073 (CompGeneral)
-- @@@ START COPYRIGHT @@@
--
-- Licensed to the Apache Software Foundation (ASF) under one
-- or more contributor license agreements.  See the NOTICE file
-- distributed with this work for additional information
-- regarding copyright ownership.  The ASF licenses this file
-- to you under the Apache License, Version 2.0 (the
    -- "License"); you may not use this file except in compliance
-- with the License.  You may obtain a copy of the License at
--
--   http://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing,
-- software distributed under the License is distributed on an
-- "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
-- KIND, either express or implied.  See the License for the
-- specific language governing permissions and limitations
-- under the License.
--
-- @@@ END COPYRIGHT @@@
--
-- Functionality: DUMP statement
-- Expected file: EXPECTED073
-- Filter file: FILTER073
-- Tables created: t073t1
-- Limitations:                                                
-- Revision history:
--     (04/7/18) - Created for new syntax DUMP


set pattern $$QUOTE$$ '''';  --Needed for metadata insert of DLL path

log LOG073 clear;

obey TEST073(clnup);
obey TEST073(compile_libs);
obey TEST073(ddl);

obey TEST073(showddl1);
obey TEST073(dump1);
obey TEST073(loadObjects);
obey TEST073(showddl1);
obey TEST073(loadSchema);
obey TEST073(showddl1);

exit;

?section compile_libs
--------------------------------------------------------------------------------------
log;

--DLL
sh rm -f ./TEST072.dll;
sh sh $$scriptsdir$$/tools/dll-compile.ksh TEST073.cpp
  2>&1 | tee -a LOG073-SECONDARY;
set pattern $$DLL$$ TEST073.dll;

log LOG073;


?section ddl
--------------------------------------------------------------------------------------

create schema t073sch_dump1;
create schema t073sch_dump2;

create table   t073sch_dump1.t073t1(col1 int not null, col2 DECIMAL(10, 4) not null, col3 VARCHAR(50) not null, primary key (col1));

create table   t073sch_dump1."t073t1"(col1 int not null, col2 DECIMAL(10, 4) not null, col3 VARCHAR(50) not null, primary key (col1));

create index   t073idx1 on t073sch_dump1.t073t1 (col1, col3);

create view    t073sch_dump1.t073view as select * from t073sch_dump1.t073t1;

create view    t073sch_dump1."t073view" as select * from t073sch_dump1.t073t1;

create library t073sch_dump1.t073dll file $$QUOTE$$ $$REGRRUNDIR$$/$$DLL$$ $$QUOTE$$;

create library t073sch_dump1."t073dll" file $$QUOTE$$ $$REGRRUNDIR$$/$$DLL$$ $$QUOTE$$;

create function t073sch_dump1.t073func(int, int) returns (add2 int)
    external name 'add2' library t073sch_dump1.t073dll
    deterministic no sql no transaction required
;

create function t073sch_dump1."t073func"(int, int) returns (add2 int)
    external name 'add2' library t073sch_dump1.t073dll
    deterministic no sql no transaction required
;

create sequence t073sch_dump1.t073seq
  start with     1
  increment by   1
  maxvalue       10000
  no cycle   
  cache          20
;



?section showddl1
--------------------------------------------------------------------------------------
showddl schema   t073sch_dump1;
showddl table    t073sch_dump1.t073t1;
showddl table    t073sch_dump1."t073t1";
showddl          t073sch_dump1.t073view;
showddl          t073sch_dump1."t073view";
showddl library  t073sch_dump1.t073dll;
showddl library  t073sch_dump1."t073dll";
showddl function t073sch_dump1.t073func;
showddl function t073sch_dump1."t073func";
showddl sequence t073sch_dump1.t073seq;


?section dump1
--------------------------------------------------------------------------------------


-- DUMP OBJECTS WITH short_name AND not set schema (failed)
dump table    t073t1   to file'./DIR073';
dump view     t073view to file'./DIR073';
dump library  t073dll  to file'./DIR073';
dump function t073func to file'./DIR073';
dump sequence t073seq  to file'./DIR073';

-- DUMP OBJECTS WITH short_name AND set schema (success)
set schema t073sch_dump1;
dump table    t073t1   to file'./DIR073';
dump table    "t073t1"   to file'./DIR073';
dump view     t073view to file'./DIR073';
dump view     "t073view" to file'./DIR073';
dump library  t073dll  to file'./DIR073';
dump library  "t073dll"  to file'./DIR073';
dump function t073func to file'./DIR073';
dump function "t073func" to file'./DIR073';
dump sequence t073seq  to file'./DIR073';

-- DUMP OBJECTS WITH full_name AND switch to another schema (success) 
set schema t073sch_dump2;
dump table    t073sch_dump1.t073t1   to file'./DIR073';
dump table    t073sch_dump1."t073t1"   to file'./DIR073';
dump view     t073sch_dump1.t073view to file'./DIR073';
dump view     t073sch_dump1."t073view" to file'./DIR073';
dump library  t073sch_dump1.t073dll  to file'./DIR073';
dump library  t073sch_dump1."t073dll"  to file'./DIR073';
dump function t073sch_dump1.t073func to file'./DIR073';
dump function t073sch_dump1."t073func" to file'./DIR073';
dump sequence t073sch_dump1.t073seq  to file'./DIR073';


-- DUMP SCHEMA WITH short_name (success)
set schema t073sch_dump1;
dump schema t073sch_dump1 to file'./DIR073';

-- DUMP SCHEMA WITH full_name (success)
dump schema trafodion.t073sch_dump1 to file'./DIR073';


?section loadObjects(success)
--------------------------------------------------------------------------------------

drop schema IF EXISTS t073sch_dump1 cascade;
create schema t073sch_dump1;

obey DIR073/TRAFODION_T073SCH_DUMP1_T073T1;
obey DIR073/TRAFODION_T073SCH_DUMP1_t073t1;
obey DIR073/TRAFODION_T073SCH_DUMP1_T073VIEW;
obey DIR073/TRAFODION_T073SCH_DUMP1_t073view;
obey DIR073/TRAFODION_T073SCH_DUMP1_T073DLL;
obey DIR073/TRAFODION_T073SCH_DUMP1_t073dll;
obey DIR073/TRAFODION_T073SCH_DUMP1_T073FUNC;
obey DIR073/TRAFODION_T073SCH_DUMP1_t073func;
obey DIR073/TRAFODION_T073SCH_DUMP1_T073SEQ;

?section loadSchema(success)
--------------------------------------------------------------------------------------

drop schema IF EXISTS t073sch_dump1 cascade;
obey DIR073/TRAFODION_T073SCH_DUMP1;



?section clnup
--------------------------------------------------------------------------------------

-- CLEANUP database
drop schema IF EXISTS t073sch_dump1 cascade;
drop schema IF EXISTS t073sch_dump2 cascade;

-- CELEANUP file
sh rm -rf DIR073;

