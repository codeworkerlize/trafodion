-- @@@ START COPYRIGHT @@@
--
-- Licensed to the Apache Software Foundation (ASF) under one
-- or more contributor license agreements.  See the NOTICE file
-- distributed with this work for additional information
-- regarding copyright ownership.  The ASF licenses this file
-- to you under the Apache License, Version 2.0 (the
-- "License"); you may not use this file except in compliance
-- with the License.  You may obtain a copy of the License at
--
--   http://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing,
-- software distributed under the License is distributed on an
-- "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
-- KIND, either express or implied.  See the License for the
-- specific language governing permissions and limitations
-- under the License.
--
-- @@@ END COPYRIGHT @@@


obey TEST081(clean_up);
log LOG081 clear;
obey TEST081(test_init);
obey TEST081(test_upsert);
log;
obey TEST081(clean_up);
exit;



?section test_init
create schema if not exists TESTDML;
set schema TESTDML;

drop table if exists T081_TA cascade;
drop table if exists T081_TB cascade;
drop table if exists T081_TC cascade;
drop table if exists T081_TD cascade;

CREATE TABLE T081_TA
  (
    C1 INT, C2 INT, PRIMARY KEY (C1 ASC)
  )
  PARTITION BY RANGE (C1)
  (
    PARTITION P1 VALUES LESS THAN (10), PARTITION P2 VALUES LESS THAN (20), PARTITION P3 VALUES LESS THAN (30), PARTITION PMAX VALUES LESS THAN (MAXVALUE)
  )
;

CREATE TABLE T081_TB
  (
    C1 INT, C2 INT, C3 INT, PRIMARY KEY (C1 ASC)
  )
  PARTITION BY RANGE (C1)
  (
    PARTITION P1 VALUES LESS THAN (10), PARTITION P2 VALUES LESS THAN (20), PARTITION P3 VALUES LESS THAN (30), PARTITION PMAX VALUES LESS THAN (MAXVALUE)
  )
;

CREATE TABLE T081_TC
  (
    C1 INT, C2 INT, C3 INT, C4 INT, PRIMARY KEY (C1 ASC)
  )
  PARTITION BY RANGE (C1)
  (
    PARTITION P1 VALUES LESS THAN (10), PARTITION P2 VALUES LESS THAN (20), PARTITION P3 VALUES LESS THAN (30), PARTITION PMAX VALUES LESS THAN (MAXVALUE)
  )
;

-- CREATE TABLE T081_TD
--   (
--     C1 INT, C2 INT, C3 INT, C4 INT, C5 INT, PRIMARY KEY (C1 ASC)
--   )
--   PARTITION BY RANGE (C1)
--   (
--     PARTITION P1 VALUES LESS THAN (10), PARTITION P2 VALUES LESS THAN (20), PARTITION P3 VALUES LESS THAN (30), PARTITION PMAX VALUES LESS THAN (MAXVALUE)
--   )
-- ;

?section test_upsert
-- upsert will lost data on some session, fix it


UPSERT INTO T081_TA SELECT ELEMENT, ELEMENT FROM UDF(SERIES(1,60));
SELECT COUNT(*) FROM T081_TA; -- 60 
UPSERT INTO T081_TA SELECT ELEMENT * 3, ELEMENT  FROM UDF(SERIES(1,60));
SELECT COUNT(*) FROM T081_TA; -- 100

delete from T081_TA where c1 > 60;

UPSERT INTO T081_TB SELECT C1 * 10, * FROM T081_TA;
SELECT COUNT(*) FROM T081_TB; -- 60
SELECT COUNT(*) FROM T081_TB PARTITION(P2); -- 1
SELECT COUNT(*) FROM T081_TB PARTITION(P3); -- 1
SELECT COUNT(*) FROM T081_TB PARTITION(PMAX); -- 58

UPSERT INTO T081_TC SELECT *, * FROM T081_TA;
SELECT COUNT(*) FROM T081_TC; -- 60

DELETE FROM T081_TC;
UPSERT INTO T081_TC SELECT MOD(C1,30), ABS(C1), RAND(), MOD(C1,5) FROM T081_TA;
SELECT COUNT(*) FROM T081_TC;

?section clean_up
drop schema if exists TESTDML cascade;