-- Test: TEST053 (CompGeneral)
-- Functionality: Tests caching for connections
--
-- @@@ START COPYRIGHT @@@
--
-- Licensed to the Apache Software Foundation (ASF) under one
-- or more contributor license agreements.  See the NOTICE file
-- distributed with this work for additional information
-- regarding copyright ownership.  The ASF licenses this file
-- to you under the Apache License, Version 2.0 (the
-- "License"); you may not use this file except in compliance
-- with the License.  You may obtain a copy of the License at
--
--   http://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing,
-- software distributed under the License is distributed on an
-- "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
-- KIND, either express or implied.  See the License for the
-- specific language governing permissions and limitations
-- under the License.
--
-- @@@ END COPYRIGHT @@@

obey TEST053(clean_up);
log LOG053 clear;
obey TEST053(create_db);
obey TEST053(connection_cache);
log;
obey TEST053(clean_up);
exit;

?section clean_up
revoke component privilege dml_select_metadata on sql_operations from public;

drop schema t053_sch1 cascade;
delete from "_MD_".defaults where attribute = 'TRAF_CLEAR_METADATA_CACHE';

?section create_db
create schema t053_sch1 authorization sql_user3;
set schema t053_sch1;
create table t053t1 (a int, b int);
insert into t053t1 values (1,1), (2,2), (3,3), (4,4);
create table t053t2 (a int, b int);
insert into t053t2 values (1,1), (2,2), (3,3), (4,4);
create table t053t3 (a int, b int);
insert into t053t3 values (1,1), (2,2), (3,3), (4,4);

grant select on t053t1 to sql_user1;
grant select on t053t2 to sql_user1;
grant select on t053t3 to sql_user1;
grant select on t053t1 to sql_user2;
grant drop on t053t3 to sql_user2;

get privileges for user sql_user1, match '%T053%';
get privileges for user sql_user2, match '%T053%';
get privileges for user sql_user3, match '%T053%';

grant component privilege dml_select_metadata on sql_operations to public;

?section set_up
-- entries from NATableCache
prepare mc from
select cast (catalog_name as char(30) character set iso88591),
       cast (schema_name as char(30) character set iso88591),
       cast (object_name as char(30) character set iso88591)
from table(natablecacheentries('user','local')) 
where object_name <> '__SCHEMA__' order by 1,2,3;

?section connection_cache
-- metadata cache is not retained between connections

insert into "_MD_".defaults values ('TRAF_CLEAR_METADATA_CACHE', 'ON', 'testing', 0);

-- no items in cache, can select from t053t1, t053t2, t053t3
sh sqlci -i "TEST053(cc_cmds_user1)";

-- no items in cache, can select from t053t1
sh sqlci -i "TEST053(cc_cmds_user2)";

-- no items in cache, can select from all tables
sh sqlci -i "TEST053(cc_cmds_user3)";

-- metadata cache is retained between connections
delete from "_MD_".defaults where attribute = 'TRAF_CLEAR_METADATA_CACHE';

-- items where user has privs, can select from t053t1, t053t2, t053t3
sh sqlci -i "TEST053(cc_cmds_user1)";

-- items where user has privs (t053t1 & t053t3), can select from t053t1
sh sqlci -i "TEST053(cc_cmds_user2)";

-- all items in cache, can select from all tables
sh sqlci -i "TEST053(cc_cmds_user3)";

?section cc_cmds_user1
-- ============================================================================
-- switch connections between db__root and sql_user1
-- ============================================================================
log;
values (current_user);
obey TEST053(set_up);
obey TEST053(load_cache);

log LOG053;
changeuser sql_user1;
values (current_user);
execute mc;
select * from t053_sch1.t053t1;
select * from t053_sch1.t053t2;
select * from t053_sch1.t053t3;

?section cc_cmds_user2
-- ============================================================================
-- switch connections between_db_root and sql_user2
-- ============================================================================
log;
values (current_user);
obey TEST053(set_up);
obey TEST053(load_cache);

log LOG053;
changeuser sql_user2;
values (current_user);
execute mc;
select * from t053_sch1.t053t1;
select * from t053_sch1.t053t2;
select * from t053_sch1.t053t3;

?section cc_cmds_user3
-- ============================================================================
-- switch connections between sql_user3 and sql_user2
-- ============================================================================
log;
values (current_user);
obey TEST053(set_up);
obey TEST053(load_cache);

log LOG053;
changeuser sql_user3;
execute mc;
select * from t053_sch1.t053t1;
select * from t053_sch1.t053t2;
select * from t053_sch1.t053t3;

?section load_cache
execute mc;
select * from t053_sch1.t053t1;
select * from t053_sch1.t053t2;
select * from t053_sch1.t053t3;
execute mc;

