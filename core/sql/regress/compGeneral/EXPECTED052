>>obey TEST052(set_up);
>>
>>-- Resource group details
>>prepare rgInfo from
+>select 
+>       case (resource_type)
+>       when 'N' then 'NODE' || 'FILTER:' || cast (resource_name as char (20) character set iso88591)
+>       else cast (resource_name as char (20) character set iso88591) 
+>       end as resource_name,
+>       resource_type
+>from "_TENANT_MD_".resources
+>order by resource_type, resource_name;

--- SQL command prepared.
>>
>>-- nodes assigned to resource groups
>>prepare rgNodes from
+>SELECT
+>       cast (resource_name as char(15) character set iso88591) as rgroupname,
+>       'NODE' || 'FILTER:' || cast (usage_name as char(15) character set iso88591) as nodename
+>       FROM TRAFODION."_TENANT_MD_".resource_usage u
+>       WHERE usage_type = 'N' and resource_name like 'T052%'
+>       ORDER BY 1, 2;

--- SQL command prepared.
>>
>>-- Tenant details
>>prepare tenantInfo from
+>SELECT cast (a.auth_db_name as char(20) character set iso88591) as tenant_name,
+>       affinity,
+>       tenant_size,
+>       case
+>         when (o.object_uid is NULL) then '?'
+>         else
+>           cast (o.schema_name as char(20) character set iso88591)
+>       end as default_schema,
+>       cluster_size
+>FROM TRAFODION."_TENANT_MD_".tenants t left join "_MD_".objects o 
+>        on t.default_schema_uid = o.object_uid,
+>     TRAFODION."_MD_".auths a
+>WHERE t.tenant_id = a.auth_id and a.auth_db_name like 'T052%'
+>order by 1;

--- SQL command prepared.
>>
>>-- resource groups for tenant
>>prepare tenantRG from
+>select usage_type,
+>       cast (auth_db_name as char (15) character set iso88591) as tname,
+>       cast (resource_name as char (25) character set iso88591) as rname
+>from "_TENANT_MD_".tenants t, "_TENANT_MD_".tenant_usage u,
+>     "_TENANT_MD_".resources r, "_MD_".auths a
+>where t.tenant_id = u.tenant_id
+>  and u.usage_uid = r.resource_uid
+>  and t.tenant_id = a.auth_id
+>  and r.resource_name like 'T052%'
+>order by 2, 3
+>;

--- SQL command prepared.
>>
>>-- nodes for tenant
>>prepare tenantNodes from
+>select
+>       cast (usage_name as char(15) character set iso88591) as uname,
+>       usage_type,
+>       usage_value as units,
+>       'NODE' || 'FILTER:' || cast (resource_name as char (15) character set iso88591) as rname
+>from "_TENANT_MD_".resource_usage
+>where usage_type = 'T' and usage_name like 'T052%'
+>order by 2, 1;

--- SQL command prepared.
>>
>>obey TEST052(create_env);
>>-- create functions
>>set pattern $$QUOTE$$ '''';
>>sh rm -f ./etest052.dll;
>>sh sh $$scriptsdir$$/tools/dll-compile.ksh etest052.cpp
+>  2>&1 | tee -a LOG107-SECONDARY;
>>set pattern $$DLL$$ etest052.dll;
>>
>>create library compGeneral_t052 file $$QUOTE$$ $$REGRRUNDIR$$/$$DLL$$ $$QUOTE$$ ;

--- SQL operation complete.
>>
>>create function get_node_name() returns (hostName char (100))
+>language c parameter style sql external name 'getNodeName'
+>library compGeneral_t052
+>deterministic no sql final call allow any parallelism state area size 1024 ;

--- SQL operation complete.
>>
>>create function get_zookeeper_status(tenantName char(256)) returns (status char(500))
+>language c parameter style sql external name 'getZookeeperTenantStatus'
+>library compGeneral_t052
+>deterministic no sql final call allow any parallelism state area size 1024 ;

--- SQL operation complete.
>>
>>-- generate resource group stmt
>>log;
>>
>>sh cat $REGRRUNDIR/TEMP1_LOG052 | tr -d '\000' | grep resource | grep group > TEMP2_LOG052;
>>obey TEMP2_LOG052;
>>create resource group t052_group1 nodes ('edev08');

--- SQL operation complete.
>>create resource group t052_group2 nodes ('edev08');

--- SQL operation complete.
>>sh rm $REGRRUNDIR/TEMP?_LOG052;
>>sh rm $REGRTSTDIR/TEMP?_LOG052;
>>log LOG052;
>>
>>execute rgInfo;

RESOURCE_NAME                    RESOURCE_TYPE
-------------------------------  -------------

DB__RGROUP_DEFAULT               G            
T052_GROUP1                      G            
T052_GROUP2                      G            
NODEFILTER:edev08                N            

--- 4 row(s) selected.
>>execute rgNodes;

RGROUPNAME       NODENAME                  
---------------  --------------------------

T052_GROUP1      NODEFILTER:edev08         
T052_GROUP2      NODEFILTER:edev08         

--- 2 row(s) selected.
>>
>>create tenant t052_tenant1 admin role tenant1_admin, schemas (tenant1_sch), sessions -2, cluster size 1, affinity 1, tenant size 8;

*** WARNING[1092] With the new tenant definition for tenant T052_TENANT1, at least 1 of the 1 nodes of this cluster or resource group are oversubscribed. The cluster or resource group(s) has or have a capacity of 1 units, of which 8 are allocated to tenants. For example: Node 0 has a capacity of 1 units and has 8 units allocated.

--- SQL operation complete.
>>showddl tenant t052_tenant1;

CREATE TENANT T052_TENANT1 TENANT SIZE 8, AFFINITY 1, CLUSTER SIZE 1, DEFAULT
  SCHEMA TRAFODION.TENANT1_SCH, ADMIN ROLE TENANT1_ADMIN, SCHEMAS
  (TRAFODION.TENANT1_SCH);

--- SQL operation complete.
>>--select get_zookeeper_status('T052_TENANT1') from (values(1));
>>select 'NODE' || 'FILTER:' || cast (a as char(20) character set iso88591) as nodename from (get nodes for tenant t052_tenant1) x(a);

--- 0 row(s) selected.
>>
>>create tenant t052_tenant2 admin role tenant2_admin, schemas (tenant2_sch1, tenant2_sch2 default), 
+>       resource groups (t052_group1), sessions -1, tenant size 10;

*** WARNING[1092] With the new tenant definition for tenant T052_TENANT2, at least 1 of the 1 nodes of this cluster or resource group are oversubscribed. The cluster or resource group(s) has or have a capacity of 1 units, of which 18 are allocated to tenants. For example: Node 0 has a capacity of 1 units and has 18 units allocated.

--- SQL operation complete.
>>showddl tenant t052_tenant1;

CREATE TENANT T052_TENANT1 TENANT SIZE 8, AFFINITY 1, CLUSTER SIZE 1, DEFAULT
  SCHEMA TRAFODION.TENANT1_SCH, ADMIN ROLE TENANT1_ADMIN, SCHEMAS
  (TRAFODION.TENANT1_SCH);

--- SQL operation complete.
>>--select get_zookeeper_status('T052_TENANT2') from (values(1));
>>select 'NODE' || 'FILTER:' || cast (a as char(20) character set iso88591) as nodename from (get nodes for tenant t052_tenant2) x(a);

NODENAME                       
-------------------------------

NODEFILTER:edev08              

--- 1 row(s) selected.
>>
>>create tenant t052_tenant3 admin role tenant3_admin, resource groups (t052_group1, t052_group2), sessions 10, tenant size 16;

*** WARNING[1092] With the new tenant definition for tenant T052_TENANT3, at least 1 of the 1 nodes of this cluster or resource group are oversubscribed. The cluster or resource group(s) has or have a capacity of 1 units, of which 34 are allocated to tenants. For example: Node 0 has a capacity of 1 units and has 34 units allocated.

--- SQL operation complete.
>>showddl tenant t052_tenant1;

CREATE TENANT T052_TENANT1 TENANT SIZE 8, AFFINITY 1, CLUSTER SIZE 1, DEFAULT
  SCHEMA TRAFODION.TENANT1_SCH, ADMIN ROLE TENANT1_ADMIN, SCHEMAS
  (TRAFODION.TENANT1_SCH);

--- SQL operation complete.
>>--select get_zookeeper_status('T052_TENANT3') from (values(1));
>>select 'NODE' || 'FILTER:' || cast (a as char(20) character set iso88591) as nodename from (get nodes for tenant t052_tenant3) x(a);

NODENAME                       
-------------------------------

NODEFILTER:edev08              

--- 1 row(s) selected.
>>
>>execute tenantInfo;

TENANT_NAME           AFFINITY     TENANT_SIZE  DEFAULT_SCHEMA        CLUSTER_SIZE
--------------------  -----------  -----------  --------------------  ------------

T052_TENANT1                    1            8  TENANT1_SCH                      1
T052_TENANT2                   -1           10  TENANT2_SCH2                    -1
T052_TENANT3                   -1           16  ?                               -1

--- 3 row(s) selected.
>>execute tenantRG;

USAGE_TYPE  TNAME            RNAME                    
----------  ---------------  -------------------------

RG          T052_TENANT2     T052_GROUP1              
RG          T052_TENANT3     T052_GROUP1              
RG          T052_TENANT3     T052_GROUP2              

--- 3 row(s) selected.
>>execute tenantNodes;

UNAME            USAGE_TYPE  UNITS                 RNAME
---------------  ----------  --------------------  --------------------------

T052_TENANT2     T                             10  NODEFILTER:edev08         
T052_TENANT3     T                             16  NODEFILTER:edev08         

--- 2 row(s) selected.
>>
>>obey TEST052(update_attrs);
>>alter tenant t052_tenant1 sessions 10, tenant size 4, cluster size 1, affinity 0;

*** WARNING[1092] With the new tenant definition for tenant T052_TENANT1, at least 1 of the 1 nodes of this cluster or resource group are oversubscribed. The cluster or resource group(s) has or have a capacity of 1 units, of which 30 are allocated to tenants. For example: Node 0 has a capacity of 1 units and has 30 units allocated.

--- SQL operation complete.
>>showddl tenant t052_tenant1;

CREATE TENANT T052_TENANT1 TENANT SIZE 4, AFFINITY 0, CLUSTER SIZE 1, DEFAULT
  SCHEMA TRAFODION.TENANT1_SCH, ADMIN ROLE TENANT1_ADMIN, SCHEMAS
  (TRAFODION.TENANT1_SCH);

--- SQL operation complete.
>>--select get_zookeeper_status('T052_TENANT1') from (values(1));
>>
>>alter tenant t052_tenant2 sessions -2, default schema tenant2_sch1, tenant size 16;

*** WARNING[1092] With the new tenant definition for tenant T052_TENANT2, at least 1 of the 1 nodes of this cluster or resource group are oversubscribed. The cluster or resource group(s) has or have a capacity of 1 units, of which 36 are allocated to tenants. For example: Node 0 has a capacity of 1 units and has 36 units allocated.

--- SQL operation complete.
>>showddl tenant t052_tenant1;

CREATE TENANT T052_TENANT1 TENANT SIZE 4, AFFINITY 0, CLUSTER SIZE 1, DEFAULT
  SCHEMA TRAFODION.TENANT1_SCH, ADMIN ROLE TENANT1_ADMIN, SCHEMAS
  (TRAFODION.TENANT1_SCH);

--- SQL operation complete.
>>--select get_zookeeper_status('T052_TENANT2') from (values(1));
>>
>>alter tenant t052_tenant3 sessions 20, schemas(tenant3_sch), tenant size 8;

*** WARNING[1092] With the new tenant definition for tenant T052_TENANT3, at least 1 of the 1 nodes of this cluster or resource group are oversubscribed. The cluster or resource group(s) has or have a capacity of 1 units, of which 28 are allocated to tenants. For example: Node 0 has a capacity of 1 units and has 28 units allocated.

--- SQL operation complete.
>>showddl tenant t052_tenant1;

CREATE TENANT T052_TENANT1 TENANT SIZE 4, AFFINITY 0, CLUSTER SIZE 1, DEFAULT
  SCHEMA TRAFODION.TENANT1_SCH, ADMIN ROLE TENANT1_ADMIN, SCHEMAS
  (TRAFODION.TENANT1_SCH);

--- SQL operation complete.
>>--select get_zookeeper_status('T052_TENANT3') from (values(1));
>>
>>execute tenantInfo;

TENANT_NAME           AFFINITY     TENANT_SIZE  DEFAULT_SCHEMA        CLUSTER_SIZE
--------------------  -----------  -----------  --------------------  ------------

T052_TENANT1                    0            4  TENANT1_SCH                      1
T052_TENANT2                   -1           16  TENANT2_SCH1                    -1
T052_TENANT3                   -1            8  TENANT3_SCH                     -1

--- 3 row(s) selected.
>>log;
