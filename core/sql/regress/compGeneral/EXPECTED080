>>obey TEST080(test_init);
>>create schema if not exists testpartition_part2;

--- SQL operation complete.
>>set schema testpartition_part2;

--- SQL operation complete.
>>
>>obey TEST080(test_MERGE);
>>drop table if exists part_tab70 cascade;

--- SQL operation complete.
>>drop table if exists part_tab70_idx cascade;

--- SQL operation complete.
>>
>>--table without index
>>create table part_tab70 (c1 int,c2 int,c3 int)
+>partition by range(c1)
+>(
+>partition p1 values less than (10),
+>partition p2 values less than (20),
+>partition p3 values less than (30),
+>partition p4 values less than (40),
+>partition p5 values less than (50),
+>partition p6 values less than (60),
+>partition p7 values less than (70),
+>partition p8 values less than (80),
+>partition p9 values less than (90),
+>--partition p10 values less than (100),
+>--partition p11 values less than (110),
+>--partition p12 values less than (120),
+>--partition p13 values less than (130),
+>--partition p14 values less than (140),
+>--partition p15 values less than (150),
+>partition p100 values less than(MAXVALUE)
+>);

--- SQL operation complete.
>>
>>insert into part_tab70 select element, element, element from udf(series(1,149));

--- 149 row(s) inserted.
>>insert into part_tab70 values(139,139,149);

--- 1 row(s) inserted.
>>
>>--table with indexes
>>
>>create table part_tab70_idx (c1 int,c2 int,c3 int)
+>partition by range(c1)
+>(
+>partition p1 values less than (10),
+>partition p2 values less than (20),
+>partition p3 values less than (30),
+>partition p4 values less than (40),
+>partition p5 values less than (50),
+>partition p6 values less than (60),
+>partition p7 values less than (70),
+>partition p8 values less than (80),
+>partition p9 values less than (90),
+>--partition p10 values less than (100),
+>--partition p11 values less than (110),
+>--partition p12 values less than (120),
+>--partition p13 values less than (130),
+>partition p14 values less than (140),
+>partition p15 values less than (150)
+>,partition p100 values less than(MAXVALUE)
+>);

--- SQL operation complete.
>>
>>create index tab70_local_idx2 on part_tab70_idx(c3 desc, c2 asc, c1 desc) local;

--- SQL operation complete.
>>create index p6_idx on part_tab70_idx(c3) partition (p6);

--- SQL operation complete.
>>--create index p11_idx on part_tab70_idx(c3) partition (p11);
>>--create index p13_idx on part_tab70_idx(c3) partition (p13);
>>create unique index p15_idx on part_tab70_idx(c3) partition (p15);

--- SQL operation complete.
>>
>>insert into part_tab70_idx select element, element, element from udf(series(1,149));

--- 149 row(s) inserted.
>>insert into part_tab70_idx values(139,139,149);

--- 1 row(s) inserted.
>>
>>--error cases
>>alter table part_tab70_not_exist merge partitions p5,p6 into partition p8 ;

*** ERROR[4082] Object TRAFODION.TESTPARTITION_PART2.PART_TAB70_NOT_EXIST does not exist or is inaccessible.

--- SQL operation failed with errors.
>>alter table part_tab70 merge partitions p5,p6 into partition p8 ;

*** ERROR[1271] resulting partition name conflicts with that of an existing partition

--- SQL operation failed with errors.
>>alter table part_tab70 merge partitions p5,p8 into partition p5 ;

*** ERROR[1270] partitions being merged are not adjacent.

--- SQL operation failed with errors.
>>
>>--success
>>--01 without index
>>alter table part_tab70 merge partitions p1 into partition p2 ;

--- SQL operation complete.
>>alter table part_tab70 merge partitions p2 into partition p2 ;

--- SQL operation complete.
>>alter table part_tab70 merge partitions for(15) into partition p2 ;

--- SQL operation complete.
>>alter table part_tab70 merge partitions for(48),p7,for(58),p8 into partition p6;

--- SQL operation complete.
>>alter table part_tab70 merge partitions p3,p4 into partition p1_new;

--- SQL operation complete.
>>alter table part_tab70 merge partitions p9,p1_new,for(77);

--- SQL operation complete.
>>--,p10,for(105),for(115);
>>--alter table part_tab70 merge partitions p14 into partition p15;
>>
>>select substring(PARTITION_NAME,1,5), PARTITION_ORDINAL_POSITION, substring(PARTITION_EXPRESSION,1,5), STATUS 
+>from "_MD_".TABLE_PARTITIONS P, "_MD_".OBJECTS O
+>where P.PARENT_UID = O.OBJECT_UID and O.OBJECT_NAME = 'PART_TAB70' and O.SCHEMA_NAME = CURRENT_SCHEMA
+>order by PARTITION_ORDINAL_POSITION;

(EXPR)                PARTITION_ORDINAL_POSITION  (EXPR)                STATUS
--------------------  --------------------------  --------------------  ------

P2                                             0  20                    Y     
SYS_P                                          1  90                    Y     
P100                                           2  MAXVA                 Y     

--- 3 row(s) selected.
>>
>>select count(*) from part_tab70;

(EXPR)              
--------------------

                 150

--- 1 row(s) selected.
>>
>>--02 with indexes
>>alter table part_tab70_idx merge partitions p1 into partition p2 ;

--- SQL operation complete.
>>alter table part_tab70_idx merge partitions p8,for(48),for(58),p7 into partition p6;

--- SQL operation complete.
>>alter table part_tab70_idx merge partitions p3,p4 into partition p1_new;

--- SQL operation complete.
>>alter table part_tab70_idx merge partitions p1_new,for(77),p9;

--- SQL operation complete.
>>--,p10,for(105),for(115);
>>alter table part_tab70_idx merge partitions p14 into partition p15;

*** ERROR[8110] Duplicate rows detected.

*** ERROR[1053] Unique index TRAFODION.TESTPARTITION_PART2.P15_IDX could not be created because the specified column(s) contain duplicate data.

*** ERROR[20123] A user-defined transaction has been started. This DDL operation cannot be performed.

--- SQL operation failed with errors.
>>--should fail by unique index on p15
>>alter table part_tab70_idx merge partitions p14 into partition p15;

*** ERROR[8110] Duplicate rows detected.

*** ERROR[1053] Unique index TRAFODION.TESTPARTITION_PART2.P15_IDX could not be created because the specified column(s) contain duplicate data.

*** ERROR[20123] A user-defined transaction has been started. This DDL operation cannot be performed.

--- SQL operation failed with errors.
>>--redo to check unique index is still online
>>
>>select substring(PARTITION_NAME,1,5), PARTITION_ORDINAL_POSITION, substring(PARTITION_EXPRESSION,1,5), STATUS 
+>from "_MD_".TABLE_PARTITIONS P, "_MD_".OBJECTS O
+>where P.PARENT_UID = O.OBJECT_UID and O.OBJECT_NAME = 'PART_TAB70_IDX' and O.SCHEMA_NAME = CURRENT_SCHEMA
+>order by PARTITION_ORDINAL_POSITION;

(EXPR)                PARTITION_ORDINAL_POSITION  (EXPR)                STATUS
--------------------  --------------------------  --------------------  ------

P2                                             0  20                    Y     
SYS_P                                          1  90                    Y     
P14                                            2  140                   Y     
P15                                            3  150                   Y     
P100                                           4  MAXVA                 Y     

--- 5 row(s) selected.
>>
>>select count(*) from part_tab70_idx;

(EXPR)              
--------------------

                 150

--- 1 row(s) selected.
>>
>>
>>obey TEST080(test_EXCHANGE);
>>create table part_tab71 (c1 int,c2 tinyint,c3 largeint, 
+>                         c4 char(10), c5 char(10) character set utf8, c6 char(10 bytes) character set utf8,
+>                         c7 varchar(10), c8 varchar(10) character set utf8, c9 varchar(16 bytes) character set utf8,
+>                         c10 decimal(18,4), c11 numeric(18,4), c12 numeric(24,6), c13 date, c14 time(4), c15 timestamp(4))
+>store by (c1, c2)
+>partition by range(c1)
+>(
+>--partition p1 values less than (10),
+>--partition p2 values less than (20),
+>partition p3 values less than (30),
+>partition p4 values less than (40),
+>--partition p5 values less than (50),
+>--partition p6 values less than (60),
+>partition p7 values less than (maxvalue)
+>);

--- SQL operation complete.
>>
>>create index part_tab71_idx on part_tab71(c3,c1) local;

--- SQL operation complete.
>>
>>insert into part_tab71 values(1, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into part_tab71 values(2, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into part_tab71 values(3, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into part_tab71 values(11, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into part_tab71 values(12, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into part_tab71 values(13, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into part_tab71 values(21, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into part_tab71 values(22, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into part_tab71 values(23, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into part_tab71 values(31, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into part_tab71 values(32, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into part_tab71 values(33, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into part_tab71 values(41, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into part_tab71 values(42, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into part_tab71 values(43, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into part_tab71 values(51, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into part_tab71 values(52, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into part_tab71 values(53, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>
>>
>>create table common_tab72 (cc1 int,c2 tinyint,c3 largeint, 
+>                         c4 char(10), cc5 char(10) character set utf8, c6 char(10 bytes) character set utf8,
+>                         cc7 varchar(10), c8 varchar(10) character set utf8, c9 varchar(16 bytes) character set utf8,
+>                         c10 decimal(18,4), cc11 numeric(18,4), c12 numeric(24,6), c13 date, cc14 time(4), cc15 timestamp(4))
+>    store by (cc1, c2);

--- SQL operation complete.
>>
>>create index common_tab72_idx on common_tab72(cc11, c3);

--- SQL operation complete.
>>
>>insert into common_tab72 values(28, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into common_tab72 values(35, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into common_tab72 values(36, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into common_tab72 values(37, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into common_tab72 values(38, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>insert into common_tab72 values(39, 1, 1, 'test', 'test测试', 'test测试', '2test', '2test测试', '2test测试', 100.1234, 200.1234, 300.123456, '2021-04-09', '12:00:00.1023', '2021-04-09 12:00:00.1023');

--- 1 row(s) inserted.
>>
>>create table common_tab72_01 (c1 largeint,c2 tinyint,c3 largeint, 
+>                         c4 char(10), c5 char(10) character set utf8, c6 char(10 bytes) character set utf8,
+>                         c7 varchar(10), c8 varchar(10) character set utf8, c9 varchar(16 bytes) character set utf8,
+>                         c10 decimal(18,4), c11 numeric(18,4), c12 numeric(24,6), c13 date, c14 time(4), c15 timestamp(4))
+>    store by (c1, c2);

--- SQL operation complete.
>>create table common_tab72_05 (c1 int,c2 tinyint,c3 largeint, 
+>                         c4 char(10), c5 char(10) character set utf8, c6 char(10 bytes) character set utf8,
+>                         c7 varchar(10), c8 varchar(10) character set utf8, c9 varchar(16 chars) character set utf8,
+>                         c10 decimal(18,4), c11 numeric(18,4), c12 numeric(24,6), c13 date, c14 time(4), c15 timestamp(4))
+>    store by (c1, c2);

--- SQL operation complete.
>>create table common_tab72_09 (c1 int,c2 tinyint,c3 largeint, 
+>                         c4 char(10), c5 char(10) character set utf8, c6 char(10 bytes) character set utf8,
+>                         c7 varchar(10), c8 varchar(10) character set utf8, c9 varchar(16 bytes) character set utf8,
+>                         c10 decimal(18,4), c11 numeric(16,4), c12 numeric(24,6), c13 date, c14 time(4), c15 timestamp(4))
+>    store by (c1, c2);

--- SQL operation complete.
>>create table common_tab72_13 (c1 int,c2 tinyint,c3 largeint, 
+>                         c4 char(10), c5 char(10) character set utf8, c6 char(10 bytes) character set utf8,
+>                         c7 varchar(10), c8 varchar(10) character set utf8, c9 varchar(16 bytes) character set utf8,
+>                         c10 decimal(18,4), c11 numeric(18,4), c12 numeric(24,6), c13 date, c14 time(4), c15 timestamp(4))
+>    store by (c1, c3);

--- SQL operation complete.
>>
>>--error
>>alter table part_tab71 exchange partition p4 with table common_tab72;

*** ERROR[8306] Operation is not allowed, reason: data in exchange table is out of range.

--- SQL operation failed with errors.
>>alter table part_tab71 exchange partition p4 with table part_tab71.p5;

*** ERROR[1127] The specified table TRAFODION.PART_TAB71.P5 does not exist, is inaccessible or is not a base table. Please verify that the correct table was specified.

--- SQL operation failed with errors.
>>--ORA-00942: table or view does not exist
>>alter table part_tab71 exchange partition p4 with partition part_tab71.p5;

*** ERROR[15001] A syntax error occurred at or before: 
alter table part_tab71 exchange partition p4 with partition part_tab71.p5;
                                                          ^ (59 characters from start of SQL statement)

*** ERROR[8822] The statement was not prepared.

>>--ORA-00966: missing TABLE keyword
>>
>>alter table part_tab71 exchange partition p4 with table common_tab72_01;

*** ERROR[8306] Operation is not allowed, reason: DDLs of two table must be the same.

--- SQL operation failed with errors.
>>alter table part_tab71 exchange partition p4 with table common_tab72_05;

*** ERROR[8306] Operation is not allowed, reason: DDLs of two table must be the same.

--- SQL operation failed with errors.
>>alter table part_tab71 exchange partition p4 with table common_tab72_09;

*** ERROR[8306] Operation is not allowed, reason: DDLs of two table must be the same.

--- SQL operation failed with errors.
>>alter table part_tab71 exchange partition p4 with table common_tab72_13;

*** ERROR[8306] Operation is not allowed, reason: DDLs of two table must be the same.

--- SQL operation failed with errors.
>>
>>--success
>>delete from common_tab72 where cc1 = 28;

--- 1 row(s) deleted.
>>
>>select * from part_tab71 partition(p4);

C1           C2    C3                    C4          C5                                        C6          C7          C8                                        C9                C10                   C11                    C12                         C13         C14            C15
-----------  ----  --------------------  ----------  ----------------------------------------  ----------  ----------  ----------------------------------------  ----------------  --------------------  ---------------------  --------------------------  ----------  -------------  ------------------------

         31     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         32     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         33     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023

--- 3 row(s) selected.
>>select * from common_tab72;

CC1          C2    C3                    C4          CC5                                       C6          CC7         C8                                        C9                C10                   CC11                   C12                         C13         CC14           CC15
-----------  ----  --------------------  ----------  ----------------------------------------  ----------  ----------  ----------------------------------------  ----------------  --------------------  ---------------------  --------------------------  ----------  -------------  ------------------------

         35     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         36     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         37     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         38     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         39     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023

--- 5 row(s) selected.
>>
>>alter table part_tab71 exchange partition p4 with table common_tab72;

--- SQL operation complete.
>>
>>select * from part_tab71 partition(p4);

C1           C2    C3                    C4          C5                                        C6          C7          C8                                        C9                C10                   C11                    C12                         C13         C14            C15
-----------  ----  --------------------  ----------  ----------------------------------------  ----------  ----------  ----------------------------------------  ----------------  --------------------  ---------------------  --------------------------  ----------  -------------  ------------------------

         35     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         36     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         37     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         38     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         39     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023

--- 5 row(s) selected.
>>select * from common_tab72;

CC1          C2    C3                    C4          CC5                                       C6          CC7         C8                                        C9                C10                   CC11                   C12                         C13         CC14           CC15
-----------  ----  --------------------  ----------  ----------------------------------------  ----------  ----------  ----------------------------------------  ----------------  --------------------  ---------------------  --------------------------  ----------  -------------  ------------------------

         31     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         32     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         33     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023

--- 3 row(s) selected.
>>
>>alter table part_tab71 exchange partition p4 with table common_tab72;

--- SQL operation complete.
>>
>>select * from part_tab71 partition(p4);

C1           C2    C3                    C4          C5                                        C6          C7          C8                                        C9                C10                   C11                    C12                         C13         C14            C15
-----------  ----  --------------------  ----------  ----------------------------------------  ----------  ----------  ----------------------------------------  ----------------  --------------------  ---------------------  --------------------------  ----------  -------------  ------------------------

         31     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         32     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         33     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023

--- 3 row(s) selected.
>>select * from common_tab72;

CC1          C2    C3                    C4          CC5                                       C6          CC7         C8                                        C9                C10                   CC11                   C12                         C13         CC14           CC15
-----------  ----  --------------------  ----------  ----------------------------------------  ----------  ----------  ----------------------------------------  ----------------  --------------------  ---------------------  --------------------------  ----------  -------------  ------------------------

         35     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         36     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         37     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         38     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         39     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023

--- 5 row(s) selected.
>>
>>alter table part_tab71 exchange partition p4 with table common_tab72;

--- SQL operation complete.
>>
>>select * from part_tab71 partition(p4);

C1           C2    C3                    C4          C5                                        C6          C7          C8                                        C9                C10                   C11                    C12                         C13         C14            C15
-----------  ----  --------------------  ----------  ----------------------------------------  ----------  ----------  ----------------------------------------  ----------------  --------------------  ---------------------  --------------------------  ----------  -------------  ------------------------

         35     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         36     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         37     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         38     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         39     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023

--- 5 row(s) selected.
>>select * from common_tab72;

CC1          C2    C3                    C4          CC5                                       C6          CC7         C8                                        C9                C10                   CC11                   C12                         C13         CC14           CC15
-----------  ----  --------------------  ----------  ----------------------------------------  ----------  ----------  ----------------------------------------  ----------------  --------------------  ---------------------  --------------------------  ----------  -------------  ------------------------

         31     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         32     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023
         33     1                     1  test        test测试                                test测试  2test       2test测试                               2test测试                   100.1234               200.1234                  300.123456  2021-04-09  12:00:00.1023  2021-04-09 12:00:00.1023

--- 3 row(s) selected.
>>
>>set parserflags 131072;

--- SQL operation complete.
>>
>>select * from table(index_table INDEX_PART_TAB71_IDX_PART_PART_TAB71_P4_);

C3@                   C1@          C2    SYSKEY              
--------------------  -----------  ----  --------------------

                   1           35     1   7738564976736678815
                   1           36     1   7738564976736678821
                   1           37     1   7738564976736678823
                   1           38     1   7738564976736678837
                   1           39     1   7738564976736678839

--- 5 row(s) selected.
>>select * from table(index_table common_tab72_idx);

CC11@                  C3@                   CC1          C2    SYSKEY
---------------------  --------------------  -----------  ----  --------------------

             200.1234                     1           31     1   7738564976736818881
             200.1234                     1           32     1   7738564976736818888
             200.1234                     1           33     1   7738564976736818891

--- 3 row(s) selected.
>>
>>
>>obey TEST080(M20998);
>>create table m20998 (c1 int primary key,c2 int,c3 int)
+>partition by range(c1)
+>(
+>partition p1 values less than (10),
+>partition p2 values less than (20),
+>partition p3 values less than (30)
+>);

--- SQL operation complete.
>>
>>cqd TRAF_PARTITIONV2_CONSTRAINT_RAISE_ERROR 'off';

--- SQL operation complete.
>>insert into m20998 partition (p3) values(22,2,3),(1,2,3);

--- 1 row(s) inserted.
>>insert into m20998 partition for(28) values(23,2,3),(1,2,3);

--- 1 row(s) inserted.
>>insert into m20998 values(13,2,3),(100,2,3);

--- 1 row(s) inserted.
>>delete from m20998;

--- 3 row(s) deleted.
>>
>>cqd TRAF_PARTITIONV2_CONSTRAINT_RAISE_ERROR 'on';

--- SQL operation complete.
>>insert into m20998 partition (p3) values(22,2,3),(1,2,3);

*** ERROR[4403] insert partition key is outside specified partition

--- 0 row(s) inserted.
>>insert into m20998 partition for(28) values(22,2,3),(1,2,3);

*** ERROR[4403] insert partition key is outside specified partition

--- 0 row(s) inserted.
>>insert into m20998 values(13,2,3),(100,2,3);

*** ERROR[4403] insert partition key is outside specified partition

--- 0 row(s) inserted.
>>
>>obey TEST080(unique_constraint);
>>drop table if exists pt3 cascade;

--- SQL operation complete.
>>create table pt3(c1 int, c2 numeric(10,2), c3 varchar(10))
+>partition by range(c1)
+>(
+>partition p1 values less than (10),
+>partition p2 values less than (20),
+>partition p3 values less than (30),
+>partition pmax values less than (maxvalue)
+>);

--- SQL operation complete.
>>----------------ddl-----------------------
>>alter table pt3 add constraint unq_pt3 unique(c1);

--- SQL operation complete.
>>showddl pt3;

CREATE TABLE TRAFODION.TESTPARTITION_PART2.PT3
  (
    C1                               INT DEFAULT NULL
  , C2                               NUMERIC(10, 2) DEFAULT NULL
  , C3                               VARCHAR(10) CHARACTER SET ISO88591 COLLATE
      DEFAULT DEFAULT NULL
  )
  PARTITION BY RANGE (C1)
  (
    PARTITION P1 VALUES LESS THAN (10)
  , PARTITION P2 VALUES LESS THAN (20)
  , PARTITION P3 VALUES LESS THAN (30)
  , PARTITION PMAX VALUES LESS THAN (MAXVALUE)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

-- The following index is a system created index --
CREATE UNIQUE INDEX UNQ_PT3 ON TRAFODION.TESTPARTITION_PART2.PT3
  (
    C1 ASC
  )
 GLOBAL
;

ALTER TABLE TRAFODION.TESTPARTITION_PART2.PT3 ADD CONSTRAINT
  TRAFODION.TESTPARTITION_PART2.UNQ_PT3 UNIQUE
  (
    C1
  )
;

--- SQL operation complete.
>>alter table pt3 drop constraint unq_pt3;

--- SQL operation complete.
>>showddl pt3;

CREATE TABLE TRAFODION.TESTPARTITION_PART2.PT3
  (
    C1                               INT DEFAULT NULL
  , C2                               NUMERIC(10, 2) DEFAULT NULL
  , C3                               VARCHAR(10) CHARACTER SET ISO88591 COLLATE
      DEFAULT DEFAULT NULL
  )
  PARTITION BY RANGE (C1)
  (
    PARTITION P1 VALUES LESS THAN (10)
  , PARTITION P2 VALUES LESS THAN (20)
  , PARTITION P3 VALUES LESS THAN (30)
  , PARTITION PMAX VALUES LESS THAN (MAXVALUE)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

--- SQL operation complete.
>>create index unq_pt3 on pt3(c1) global;

--- SQL operation complete.
>>showddl pt3;

CREATE TABLE TRAFODION.TESTPARTITION_PART2.PT3
  (
    C1                               INT DEFAULT NULL
  , C2                               NUMERIC(10, 2) DEFAULT NULL
  , C3                               VARCHAR(10) CHARACTER SET ISO88591 COLLATE
      DEFAULT DEFAULT NULL
  )
  PARTITION BY RANGE (C1)
  (
    PARTITION P1 VALUES LESS THAN (10)
  , PARTITION P2 VALUES LESS THAN (20)
  , PARTITION P3 VALUES LESS THAN (30)
  , PARTITION PMAX VALUES LESS THAN (MAXVALUE)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

CREATE INDEX UNQ_PT3 ON TRAFODION.TESTPARTITION_PART2.PT3
  (
    C1 ASC
  )
 GLOBAL
;

--- SQL operation complete.
>>drop index unq_pt3;

--- SQL operation complete.
>>showddl pt3;

CREATE TABLE TRAFODION.TESTPARTITION_PART2.PT3
  (
    C1                               INT DEFAULT NULL
  , C2                               NUMERIC(10, 2) DEFAULT NULL
  , C3                               VARCHAR(10) CHARACTER SET ISO88591 COLLATE
      DEFAULT DEFAULT NULL
  )
  PARTITION BY RANGE (C1)
  (
    PARTITION P1 VALUES LESS THAN (10)
  , PARTITION P2 VALUES LESS THAN (20)
  , PARTITION P3 VALUES LESS THAN (30)
  , PARTITION PMAX VALUES LESS THAN (MAXVALUE)
  )
 ATTRIBUTES ALIGNED FORMAT NAMESPACE 'TRAF_1500000'
;

--- SQL operation complete.
>>
>>----------------dml-----------------------
>>alter table pt3 add constraint unq_pt3 unique(c1);

--- SQL operation complete.
>>showddl pt3;

CREATE TABLE TRAFODION.TESTPARTITION_PART2.PT3
  (
    C1                               INT DEFAULT NULL
  , C2                               NUMERIC(10, 2) DEFAULT NULL
  , C3                               VARCHAR(10) CHARACTER SET ISO88591 COLLATE
      DEFAULT DEFAULT NULL
  )
  PARTITION BY RANGE (C1)
  (
    PARTITION P1 VALUES LESS THAN (10)
  , PARTITION P2 VALUES LESS THAN (20)
  , PARTITION P3 VALUES LESS THAN (30)
  , PARTITION PMAX VALUES LESS THAN (MAXVALUE)
  )
 ATTRIBUTES ALIGNED FORMAT
;

-- The following index is a system created index --
CREATE UNIQUE INDEX UNQ_PT3 ON TRAFODION.TESTPARTITION_PART2.PT3
  (
    C1 ASC
  )
 GLOBAL
;

ALTER TABLE TRAFODION.TESTPARTITION_PART2.PT3 ADD CONSTRAINT
  TRAFODION.TESTPARTITION_PART2.UNQ_PT3 UNIQUE
  (
    C1
  )
;

--- SQL operation complete.
>>insert into pt3 values(1,1.1,'aaaaa');

--- 1 row(s) inserted.
>>insert into pt3 values(11, 2.2, 'bbbbb');

--- 1 row(s) inserted.
>>insert into pt3 values(21, 3.3, 'ccccc');

--- 1 row(s) inserted.
>>
>>--error 8102
>>insert into pt3 values(1,1.1,'aaaaa');

*** ERROR[8102] The operation is prevented by a unique constraint.

--- 0 row(s) inserted.
>>insert into pt3 values(11,1.1,'aaaaa');

*** ERROR[8102] The operation is prevented by a unique constraint.

--- 0 row(s) inserted.
>>insert into pt3 values(21,1.1,'aaaaa');

*** ERROR[8102] The operation is prevented by a unique constraint.

--- 0 row(s) inserted.
>>
>>set parserflags 1;

--- SQL operation complete.
>>select * from table (index_table unq_pt3);

C1@          SYSKEY              
-----------  --------------------

          1    119610909481575201
         11    119610909482698178
         21    119610909482720135

--- 3 row(s) selected.
>>delete from pt3 partition(p1);

--- 1 row(s) deleted.
>>select * from table (index_table unq_pt3);

C1@          SYSKEY              
-----------  --------------------

         11    119610909482698178
         21    119610909482720135

--- 2 row(s) selected.
>>delete from pt3 partition(p2);

--- 1 row(s) deleted.
>>select * from table (index_table unq_pt3);

C1@          SYSKEY              
-----------  --------------------

         21    119610909482720135

--- 1 row(s) selected.
>>delete from pt3 partition(p3);

--- 1 row(s) deleted.
>>select * from table (index_table unq_pt3);

--- 0 row(s) selected.
>>
>>insert into pt3 values(1,1.1,'aaaaa');

--- 1 row(s) inserted.
>>insert into pt3 values(11, 2.2, 'bbbbb');

--- 1 row(s) inserted.
>>insert into pt3 values(21, 3.3, 'ccccc');

--- 1 row(s) inserted.
>>insert into pt3 values(2,1.1,'aaaaa');

--- 1 row(s) inserted.
>>insert into pt3 values(12,2.2,'bbbbb');

--- 1 row(s) inserted.
>>insert into pt3 values(22,3.3,'ccccc');

--- 1 row(s) inserted.
>>--error 8102
>>update pt3 set c1 = 1 where c1 = 2;

*** ERROR[8102] The operation is prevented by a unique constraint.

--- 0 row(s) updated.
>>update pt3 set c1 = 11 where c1 = 12;

*** ERROR[8102] The operation is prevented by a unique constraint.

--- 0 row(s) updated.
>>update pt3 set c1 = 21 where c1 = 22;

*** ERROR[8102] The operation is prevented by a unique constraint.

--- 0 row(s) updated.
>>
>>--success
>>update pt3 set c1 = 3 where c1 = 2;

--- 1 row(s) updated.
>>update pt3 set c1 = 13 where c1 = 12;

--- 1 row(s) updated.
>>update pt3 set c1 = 23 where c1 = 22;

--- 1 row(s) updated.
>>select * from pt3;

C1           C2                     C3        
-----------  ---------------------  ----------

         21                    3.3  ccccc     
         23                    3.3  ccccc     
         11                    2.2  bbbbb     
          1                    1.1  aaaaa     
         13                    2.2  bbbbb     
          3                    1.1  aaaaa     

--- 6 row(s) selected.
>>select * from table (index_table unq_pt3);

C1@          SYSKEY              
-----------  --------------------

          1    119610909484663444
          3    119610909484719730
         11    119610909484679490
         13    119610909484746092
         21    119610909484699298
         23    119610909484763190

--- 6 row(s) selected.
>>delete from pt3;

--- 6 row(s) deleted.
>>
>>insert into pt3 values(1,1.1,'aaaaa');

--- 1 row(s) inserted.
>>insert into pt3 values(11, 2.2,'bbbbb');

--- 1 row(s) inserted.
>>insert into pt3 values(21, 3.3,'ccccc');

--- 1 row(s) inserted.
>>insert into pt3 values(2,1.1,'aaaaa');

--- 1 row(s) inserted.
>>insert into pt3 values(12,2.2,'bbbbb');

--- 1 row(s) inserted.
>>insert into pt3 values(22,3.3,'ccccc');

--- 1 row(s) inserted.
>>--error 8102
>>upsert into pt3 values(1,1.1,'aaaaa');

*** ERROR[8102] The operation is prevented by a unique constraint.

--- 0 row(s) inserted.
>>upsert into pt3 values(11,2.2,'bbbbb');

*** ERROR[8102] The operation is prevented by a unique constraint.

--- 0 row(s) inserted.
>>
>>--success
>>upsert into pt3 values(10,3.4,'upsert');

--- 1 row(s) inserted.
>>upsert into pt3 values(4, 5.6,'upsert');

--- 1 row(s) inserted.
>>select * from pt3;

C1           C2                     C3        
-----------  ---------------------  ----------

         21                    3.3  ccccc     
         22                    3.3  ccccc     
         10                    3.4  upsert    
          1                    1.1  aaaaa     
         11                    2.2  bbbbb     
          2                    1.1  aaaaa     
         12                    2.2  bbbbb     
          4                    5.6  upsert    

--- 8 row(s) selected.
>>select * from table (index_table unq_pt3);

C1@          SYSKEY              
-----------  --------------------

          1    119610909490212419
          2    119610909490262557
          4    119610909492501083
         10    119610909492481945
         11    119610909490231740
         12    119610909490280498
         21    119610909490246703
         22    119610909490295689

--- 8 row(s) selected.
>>reset parserflags 131072;

--- SQL operation complete.
>>
>>log;
